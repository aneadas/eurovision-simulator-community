<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eurovision Song Contest Simulator with Semi-Finals and Dynamic Voting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check-compat.js"></script>
    <style>
        :root {
            --main-background: linear-gradient(135deg, #1e5799 0%, #2989d8 50%, #207cca 51%, #7db9e8 100%);
            --text-color: #000;
            --heading-color: #FFD700;
            --card-background: rgba(255, 255, 255, 0.9);
            --settings-h2-color: #2989d8;
            --section-header-bg: #2c5282;
            --section-header-text: #fff;
            --table-border: #4a5568;
            --table-cell-border: #cbd5e0;
            --table-row-hover: #edf2f7;
            --table-header-bg: #f2f2f2;
            --table-row-even: #f9f9f9;
            --table-row-odd: #fff;
            --non-qualifier-bg: #FFCCCB;
            --button-info-bg: #17a2b8;
            --button-info-text: #fff;
            --button-warning-bg: #ffc107;
            --button-warning-text: #212529;
            --button-primary-bg: #007bff;
            --button-primary-text: #fff;
            --button-secondary-bg: #6c757d;
            --button-secondary-text: #fff;
            --button-success-bg: #28a745;
            --button-success-text: #fff;
            --button-danger-bg: #dc3545;
            --button-danger-text: #fff;
            --input-bg: #fff;
            --input-text: #000;
            --input-border: #ced4da;
            --select-bg: #fff;
            --select-text: #000;
            --select-border: #ced4da;
            --tele-points-revealed-bg: #FFE4B5;
            --current-televote-bg: #FFFACD;
            --jury-points-8-bg: #cd7f32;
            --jury-points-8-text: #000;
            --jury-points-10-bg: silver;
            --jury-points-10-text: #000;
            --jury-points-12-bg: gold;
            --jury-points-12-text: #000;
            --televoted-bg: #d5bdaf;
            --voting-country-bg: #000;
            --voting-country-text: #fff;
            --jury-voted-bg: #d6ccc2;
            --card-shadow: rgba(31, 38, 135, 0.37);
            --card-border: rgba(255, 255, 255, 0.18);
            --button-hover-shadow: rgba(0, 0, 0, 0.2);
            --text-shadow: rgba(0, 0, 0, 0.5);
            --aq-checkbox-border: #ccc;
            --aq-checkbox-checked-border: #FFD700;
            --aq-checkbox-checked-text: #000;
            --btn-pink-bg: #FF69B4;
            --btn-pink-border: #FF69B4;
            --btn-pink-text: #fff;
            --btn-pink-hover-bg: #FF1493;
            --btn-pink-hover-border: #FF1493;
            --btn-pink-hover-text: #fff;
            --points-low-bg: #ADD8E6;
            --simulation-area-bg: #f8f9fa;
            --moving-up-bg: green;
            --moving-down-bg: red;
            --rank-box-bg: orange;
            --rank-box-text: #fff;
            --aq-label-text: #666;
            --chart-text-color: #D3D3D3;
            --accordion-bg: #f8f9fa;
            --accordion-header-bg: #e9ecef;
            --accordion-header-text: #000;
        }

        body.dark-mode {
            --main-background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2a2a2a 51%, #3a3a3a 100%);
            --text-color: #e0e0e0;
            --heading-color: #FFD700;
            --card-background: #1e1e1e;
            --settings-h2-color: #4da6ff;
            --section-header-bg: #333;
            --section-header-text: #e0e0e0;
            --table-border: #555;
            --table-cell-border: #666;
            --table-row-hover: #333;
            --table-header-bg: #444;
            --table-row-even: #282828;
            --table-row-odd: #222;
            --non-qualifier-bg: #442222;
            --button-info-bg: #138496;
            --button-info-text: #e0e0e0;
            --button-warning-bg: #e0a800;
            --button-warning-text: #212529;
            --button-primary-bg: #0056b3;
            --button-primary-text: #e0e0e0;
            --button-secondary-bg: #5a6268;
            --button-secondary-text: #e0e0e0;
            --button-success-bg: #218838;
            --button-success-text: #e0e0e0;
            --button-danger-bg: #c82333;
            --button-danger-text: #e0e0e0;
            --input-bg: #333;
            --input-text: #e0e0e0;
            --input-border: #555;
            --select-bg: #333;
            --select-text: #e0e0e0;
            --select-border: #555;
            --tele-points-revealed-bg: #664400;
            --current-televote-bg: #665500;
            --jury-points-8-bg: #cd7f32;
            --jury-points-8-text: #000;
            --jury-points-10-bg: silver;
            --jury-points-10-text: #000;
            --jury-points-12-bg: gold;
            --jury-points-12-text: #000;
            --televoted-bg: #20282e;
            --voting-country-bg: #000;
            --voting-country-text: #fff;
            --jury-voted-bg: #181818;
            --card-shadow: rgba(255, 255, 255, 0.2);
            --card-border: rgba(255, 255, 255, 0.18);
            --button-hover-shadow: rgba(255, 255, 255, 0.2);
            --text-shadow: rgba(0, 0, 0, 0.5);
            --aq-checkbox-border: #555;
            --aq-checkbox-checked-border: #FFD700;
            --aq-checkbox-checked-text: #000;
            --btn-pink-bg: #FF69B4;
            --btn-pink-border: #FF69B4;
            --btn-pink-text: #e0e0e0;
            --btn-pink-hover-bg: #FF1493;
            --btn-pink-hover-border: #FF1493;
            --btn-pink-hover-text: #e0e0e0;
            --points-low-bg: #4682B4;
            --simulation-area-bg: #222;
            --moving-up-bg: green;
            --moving-down-bg: red;
            --rank-box-bg: orange;
            --rank-box-text: #e0e0e0;
            --aq-label-text: #999;
            --chart-text-color: #D3D3D3;
            --accordion-bg: #444;
            --accordion-header-bg: #555;
            --accordion-header-text: #e0e0e0;
            --text-color: #ffffff;
            --input-text: #999999;
            --chart-text-color: #ffffff;
        }

        body {
            color: var(--text-color);
        }

        .eurovision-simulator {
            background: var(--main-background);
            min-height: 100vh;
            padding: 20px;
        }

        .eurovision-simulator h1 {
            color: var(--heading-color);
            font-size: 3rem;
            text-shadow: 2px 2px 4px var(--text-shadow);
        }

        .menu-card,
        .settings-card {
            background: var(--card-background);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 var(--card-shadow);
            backdrop-filter: blur(4px);
            border: 1px solid var(--card-border);
            margin-bottom: 20px;
        }

        .menu-card .btn {
            margin-bottom: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .menu-card .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--button-hover-shadow);
        }

        .settings-card h2 {
            color: var(--settings-h2-color);
            margin-top: 20px;
            margin-bottom: 15px;
        }

        .section-header {
            background-color: var(--section-header-bg);
            color: var(--section-header-text);
            padding: 10px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            text-align: center;
        }

        .selection-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 2px solid var(--table-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .selection-table th,
        .selection-table td {
            border: 1px solid var(--table-cell-border);
            padding: 8px;
        }

        .selection-table tr:hover {
            background-color: var(--table-row-hover);
        }

        .eurovision-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
        }

        .eurovision-table th,
        .eurovision-table td {
            border: 1px solid var(--table-cell-border);
            padding: 4px;
            text-align: center;
        }

        .eurovision-table th {
            background-color: var(--table-header-bg);
            font-weight: bold;
            text-align: left;
        }

        .eurovision-table .receiving-country {
            text-align: right;
            font-weight: bold;
            padding-right: 10px;
        }

        .eurovision-table .flag-icon {
            margin-left: 5px;
        }

        .rotate-header {
            height: 140px;
            white-space: nowrap;
            padding: 5px 0;
        }

        .rotate-header .flag-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 15px;
        }

        .rotate-header .flag-icon {
            font-size: 12px;
        }

        .rotate-header .country-name {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            padding-top: 5px;
            text-align: left;
            max-height: 110px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rotate-header>div {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: left;
        }

        .points-column {
            transition: display 0.5s ease-in-out;
        }

        .points-12 {
            background-color: var(--jury-points-12-bg) !important;
            color: var(--jury-points-12-text) !important;
            font-weight: bold !important;
        }

        .points-10 {
            background-color: var(--jury-points-10-bg) !important;
            color: var(--jury-points-10-text) !important;
            font-weight: bold !important;
        }

        .points-8 {
            background-color: var(--jury-points-8-bg) !important;
            color: var(--jury-points-8-text) !important;
            font-weight: bold !important;
        }

        .points-7,
        .points-6,
        .points-5,
        .points-4,
        .points-3,
        .points-2,
        .points-1 {
            background-color: var(--points-low-bg) !important;
            font-weight: bold !important;
        }

        .self-vote {
            background-color: var(--voting-country-bg) !important;
            color: var(--voting-country-text) !important;
        }

        .total-column {
            font-weight: bold;
            background-color: var(--table-header-bg);
        }

        .btn-pink {
            background-color: var(--btn-pink-bg);
            border-color: var(--btn-pink-border);
            color: var(--btn-pink-text);
        }

        .btn-pink:hover {
            background-color: var(--btn-pink-hover-bg);
            border-color: var(--btn-pink-hover-border);
            color: var(--btn-pink-hover-text);
        }

        .even-row {
            background-color: var(--table-row-even);
        }

        .odd-row {
            background-color: var(--table-row-odd);
        }

        .placement {
            font-weight: bold;
            text-decoration: underline;
        }

        .semi-placement {
            font-weight: bold;
            text-decoration: underline;
        }

        .form-check-input {
            width: 1.5em;
            height: 1.5em;
        }

        .form-check-label {
            margin-left: 0.5em;
        }

        .odds-input {
            width: 70px;
        }

        .non-qualifier {
            background-color: var(--non-qualifier-bg) !important;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .country-checkbox {
            margin-right: 5px;
        }

        .aq-checkbox {
            appearance: none;
            width: 1.5em;
            height: 1.5em;
            border: 1px solid var(--aq-checkbox-border);
            border-radius: 3px;
            margin-left: 5px;
            background-color: var(--jury-points-12-bg);
            cursor: pointer;
        }

        .aq-checkbox:checked {
            background-color: var(--jury-points-12-bg);
            border-color: var(--aq-checkbox-checked-border);
        }

        .aq-checkbox:checked::before {
            content: '\2714';
            display: block;
            text-align: center;
            color: var(--aq-checkbox-checked-text);
            font-size: 1em;
            line-height: 1.5em;
        }

        .country-name {
            margin-left: 5px;
        }

        .eurovision-table tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        .eurovision-table tr:hover {
            background-color: var(--table-row-hover);
        }

        .table-striped>tbody>tr:nth-of-type(odd) {
            background-color: var(--table-row-odd);
        }

        .table-striped>tbody>tr:nth-of-type(even) {
            background-color: var(--table-row-even);
        }

        .table-striped>tbody>tr.non-qualifier:nth-of-type(odd),
        .table-striped>tbody>tr.non-qualifier:nth-of-type(even) {
            background-color: var(--non-qualifier-bg) !important;
        }

        #simulationArea {
            background-color: var(--simulation-area-bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        #simulationArea h3 {
            color: var(--settings-h2-color);
            margin-bottom: 15px;
        }

        #simulationArea table {
            background-color: var(--table-row-odd);
        }

        .tele-points-revealed {
            background-color: var(--tele-points-revealed-bg) !important;
            font-weight: bold;
            transition: background-color 0.5s ease;
        }

        .receiving-country {
            transition: background-color 0.5s ease;
        }

        .eurovision-table tbody {
            position: relative;
        }

        .eurovision-table tbody tr {
            transition: transform 0.8s ease-in-out;
            position: relative;
        }

        .rank {
            transition: all 0.8s ease-in-out;
        }

        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .moving-up::after,
        .moving-down::after {
            content: '';
            position: absolute;
            left: 0;
            width: 15px;
            height: 100%;
            transition: opacity 0.8s ease-in-out;
        }

        .moving-up::after {
            background-color: var(--moving-up-bg);
        }

        .moving-down::after {
            background-color: var(--moving-down-bg);
        }

        .reveal-button {
            width: 100%;
            font-size: 1.5em;
            padding: 15px;
            margin-top: 20px;
        }

        #timerDisplay {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }

        .current-televote {
            background-color: var(--current-televote-bg);
        }

        #revealTelevotingButton {
            font-size: 1.5em;
            padding: 15px;
        }

        .semi-final-charts {
            display: none;
            color: var(--chart-text-color);
            /* Very light gray for semi-finales text */
        }

        #chartContainer {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: var(--simulation-area-bg);
            border-radius: 10px;
            color: var(--chart-text-color);
            /* Very light gray for chart text */
        }

        #dynamicVotingArea {
            margin-top: 20px;
        }

        .genre-select {
            width: 100px;
        }

        .scenography-select {
            width: 100px;
        }

        .genre-likeability {
            width: 50px;
            margin-left: 5px;
        }

        #genreLikeability {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
            gap: 6px;
        }

        .scenography-likeability {
            width: 50px;
            margin-left: 5px;
        }

        #scenographyLikeability {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
            gap: 6px;
        }

        .aq-label {
            font-size: 0.8em;
            color: var(--aq-label-text);
            display: block;
            text-align: center;
            margin-bottom: 2px;
        }

        #dynamicVotingArea {
            order: -1;
        }

        .content-wrapper {
            display: flex;
            flex-direction: column;
        }

        #dynamicVotingArea {
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        #customContestants {
            min-height: 20px;
            display: revert;
        }

        .odds-column {
            display: none;
        }

        .rank-box {
            background-color: var(--rank-box-bg);
            color: var(--rank-box-text);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }

        .accordion {
            background-color: var(--accordion-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .accordion .accordion-item {
            background-color: var(--accordion-bg);
        }

        .accordion .accordion-header {
            background-color: var(--accordion-header-bg);
            color: var(--accordion-header-text);
            padding: 10px;
            cursor: pointer;
        }

        .accordion .accordion-header:hover {
            background-color: var(--accordion-header-bg);
        }

        .accordion .accordion-collapse {
            background-color: var(--accordion-bg);
            padding: 10px;
        }


        body.dark-mode .btn-primary {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
        }

        body.dark-mode .btn-secondary {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
        }

        body.dark-mode .btn-success {
            background-color: var(--button-success-bg);
            color: var(--button-success-text);
        }

        body.dark-mode .btn-danger {
            background-color: var(--button-danger-bg);
            color: var(--button-danger-text);
        }

        body.dark-mode .btn-info {
            background-color: var(--button-info-bg);
            color: var(--button-info-text);
        }

        body.dark-mode .btn-warning {
            background-color: var(--button-warning-bg);
            color: var(--button-warning-text);
        }

        body.dark-mode .accordion-button {
            background-color: var(--accordion-header-bg);
            color: var(--accordion-header-text);
        }

        body.dark-mode input,
        body.dark-mode select {
            background-color: var(--input-bg);
            color: var(--input-text);
            border-color: var(--input-border);
        }

        body.dark-mode .table th,
        body.dark-mode .table td,
        body.dark-mode .eurovision-table th,
        body.dark-mode .eurovision-table td {
            color: var(--text-color);
        }

        body.dark-mode .mb-3,
        body.dark-mode .col-6 {
            color: #000000
        }

        body.dark-mode .modal-body {
            color: #000000
        }

        body.dark-mode #welcomeModal .modal-content {
            background-color: #2d3748;
        }

        body.dark-mode #welcomeModal .modal-body {
            color: #e2e8f0;
        }

        body.dark-mode #welcomeModal .modal-body h4 {
            color: #63b3ed !important;
        }

        body.dark-mode #welcomeModal .modal-body p {
            color: #cbd5e0 !important;
        }

        .song-info-inputs {
            padding-top: 5px;
            border-top: 1px solid var(--table-cell-border);
        }

        .song-info-inputs input,
        .song-info-inputs select {
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--input-border);
        }

        .song-info-inputs input::placeholder {
            color: var(--aq-label-text);
            font-style: italic;
        }

        /* ===== CHRISTMAS DECORATIONS ===== */

        /* Snowflakes Container */
        .snowflakes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .snowflake {
            position: absolute;
            top: -20px;
            color: #fff;
            font-size: 1.5em;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            animation: snowfall linear infinite;
            opacity: 0.9;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(0) rotate(0deg);
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* Christmas Lights */
        .christmas-lights {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            z-index: 10000;
            pointer-events: none;
        }

        .lights-wire {
            position: absolute;
            top: 8px;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #2d5016 0%, #1a3009 50%, #2d5016 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .light-bulb {
            position: relative;
            width: 16px;
            height: 22px;
            margin: 0 18px;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: glow 1s ease-in-out infinite alternate;
            top: 10px;
        }

        .light-bulb::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #4a4a4a;
            border-radius: 2px;
        }

        .light-bulb.red {
            background: #ff3333;
            box-shadow: 0 0 15px #ff3333, 0 0 30px #ff3333;
        }

        .light-bulb.green {
            background: #33ff33;
            box-shadow: 0 0 15px #33ff33, 0 0 30px #33ff33;
            animation-delay: 0.2s;
        }

        .light-bulb.blue {
            background: #3399ff;
            box-shadow: 0 0 15px #3399ff, 0 0 30px #3399ff;
            animation-delay: 0.4s;
        }

        .light-bulb.yellow {
            background: #ffcc00;
            box-shadow: 0 0 15px #ffcc00, 0 0 30px #ffcc00;
            animation-delay: 0.6s;
        }

        .light-bulb.pink {
            background: #ff66cc;
            box-shadow: 0 0 15px #ff66cc, 0 0 30px #ff66cc;
            animation-delay: 0.8s;
        }

        @keyframes glow {
            0% {
                opacity: 0.6;
                filter: brightness(0.8);
            }

            100% {
                opacity: 1;
                filter: brightness(1.3);
            }
        }

        /* Christmas Banner */
        .christmas-banner {
            background: linear-gradient(135deg, #c41e3a 0%, #1a472a 50%, #c41e3a 100%);
            color: #fff;
            padding: 15px 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 20px;
            margin-top: 35px;
            animation: bannerShimmer 3s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        @keyframes bannerShimmer {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .christmas-banner .emoji {
            font-size: 1.5rem;
            margin: 0 10px;
        }

        /* Festive title enhancement */
        .eurovision-simulator h1 {
            position: relative;
        }

        .eurovision-simulator h1::before {
            content: 'üéÑ';
            margin-right: 15px;
        }

        .eurovision-simulator h1::after {
            content: 'üéÑ';
            margin-left: 15px;
        }

        /* Snow on cards */
        .menu-card,
        .settings-card {
            position: relative;
        }

        .menu-card::before,
        .settings-card::before {
            content: '‚ùÑÔ∏è';
            position: absolute;
            top: -10px;
            left: 10px;
            font-size: 1.2rem;
            animation: snowSpin 4s linear infinite;
        }

        .menu-card::after,
        .settings-card::after {
            content: '‚ùÑÔ∏è';
            position: absolute;
            top: -10px;
            right: 10px;
            font-size: 1.2rem;
            animation: snowSpin 4s linear infinite reverse;
        }

        @keyframes snowSpin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Hide Christmas elements when disabled */
        body:not(.christmas-enabled) .eurovision-simulator h1::before,
        body:not(.christmas-enabled) .eurovision-simulator h1::after {
            content: '';
        }

        body:not(.christmas-enabled) .menu-card::before,
        body:not(.christmas-enabled) .menu-card::after,
        body:not(.christmas-enabled) .settings-card::before,
        body:not(.christmas-enabled) .settings-card::after {
            content: '';
        }

        /* ===== ADVENT CALENDAR STYLES ===== */
        .advent-calendar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            padding: 20px;
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #1a472a 100%);
            border-radius: 15px;
        }

        .advent-door {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #8B0000 0%, #c41e3a 50%, #8B0000 100%);
            border: 3px solid #FFD700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .advent-door:hover:not(.opened):not(.locked) {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.5);
        }

        .advent-door.locked {
            background: linear-gradient(135deg, #444 0%, #666 50%, #444 100%);
            border-color: #888;
            color: #888;
            cursor: not-allowed;
        }

        .advent-door.locked::after {
            content: 'üîí';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.8rem;
        }

        .advent-door.opened {
            background: linear-gradient(135deg, #2d5a3d 0%, #3d7a4d 50%, #2d5a3d 100%);
            border-color: #90EE90;
            animation: doorOpen 0.5s ease;
        }

        .advent-door.today:not(.opened) {
            animation: todayPulse 2s ease-in-out infinite;
            border-color: #fff;
        }

        @keyframes doorOpen {
            0% {
                transform: rotateY(0deg);
            }

            50% {
                transform: rotateY(90deg);
            }

            100% {
                transform: rotateY(0deg);
            }
        }

        @keyframes todayPulse {

            0%,
            100% {
                box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700;
            }

            50% {
                box-shadow: 0 0 20px #FFD700, 0 0 40px #FFD700, 0 0 60px #FFD700;
            }
        }

        .advent-content {
            text-align: center;
            padding: 20px;
        }

        .advent-content .country-reveal {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .advent-content .country-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2989d8;
            margin-bottom: 10px;
        }

        .advent-content .fun-fact {
            font-style: italic;
            color: #666;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 10px;
        }

        .advent-stats {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 15px;
            color: #fff;
        }

        .advent-stats div {
            text-align: center;
        }

        .advent-stats .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
        }

        /* Leaderboard Tabs */
        .leaderboard-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 10px 0;
            gap: 5px;
            overflow-x: auto;
        }

        .leaderboard-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            white-space: nowrap;
        }

        .leaderboard-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .leaderboard-tab.active {
            background: #fff;
            color: #c41e3a;
        }

        /* ===== CHRISTMAS LEADERBOARD STYLES ===== */
        .leaderboard-header {
            background: linear-gradient(135deg, #c41e3a 0%, #8B0000 100%);
            color: #FFD700;
            padding: 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }

        .leaderboard-header h2 {
            margin: 0;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .leaderboard-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
        }

        .leaderboard-stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: #fff;
        }

        .leaderboard-stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFD700;
        }

        .leaderboard-stat-card .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background: #2c5282;
            color: #fff;
            padding: 12px;
            text-align: left;
        }

        .leaderboard-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }

        .leaderboard-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .leaderboard-table tr:hover {
            background: #e9ecef;
        }

        .leaderboard-rank {
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .leaderboard-rank.gold {
            color: #FFD700;
            font-size: 1.3rem;
        }

        .leaderboard-rank.silver {
            color: #C0C0C0;
            font-size: 1.2rem;
        }

        .leaderboard-rank.bronze {
            color: #CD7F32;
            font-size: 1.1rem;
        }

        .trophy-icon {
            animation: trophyBounce 2s ease-in-out infinite;
        }

        @keyframes trophyBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .leaderboard-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .leaderboard-loading .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #c41e3a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .snowflake {
            position: fixed;
            top: -10px;
            z-index: 1000;
            /* Ensure it is BELOW bootstrap modals (1050+) */
            pointer-events: none;
            color: #FFF;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            user-select: none;
            cursor: default;
            animation-name: fall, shake;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: infinite, infinite;
        }

        @keyframes fall {
            0% {
                top: -10%
            }

            100% {
                top: 100%
            }
        }

        @keyframes shake {
            0% {
                transform: translateX(0px)
            }

            50% {
                transform: translateX(80px)
            }

            100% {
                transform: translateX(0px)
            }
        }
    </style>
</head>

<body>
    <style>
        /* ... existing styles ... */
        .badge-role {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            text-transform: uppercase;
            font-weight: bold;
            display: inline-block;
            vertical-align: middle;
        }

        .badge-admin {
            background-color: #dc3545;
            color: white;
            border: 1px solid #b02a37;
        }

        .badge-dev {
            background-color: #0d6efd;
            color: white;
            border: 1px solid #0a58ca;
        }
    </style>
    <!-- Christmas Lights -->
    <div class="christmas-lights">
        <div class="lights-wire"></div>
        <div class="light-bulb red"></div>
        <div class="light-bulb green"></div>
        <div class="light-bulb blue"></div>
        <div class="light-bulb yellow"></div>
        <div class="light-bulb pink"></div>
        <div class="light-bulb red"></div>
        <div class="light-bulb green"></div>
        <div class="light-bulb blue"></div>
        <div class="light-bulb yellow"></div>
        <div class="light-bulb pink"></div>
        <div class="light-bulb red"></div>
        <div class="light-bulb green"></div>
        <div class="light-bulb blue"></div>
        <div class="light-bulb yellow"></div>
        <div class="light-bulb pink"></div>
        <div class="light-bulb red"></div>
        <div class="light-bulb green"></div>
        <div class="light-bulb blue"></div>
        <div class="light-bulb yellow"></div>
        <div class="light-bulb pink"></div>
    </div>

    <!-- Snowflakes -->
    <div class="snowflakes" id="snowflakes"></div>

    <!-- Welcome Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #1e5799 0%,#2989d8 50%,#207cca 51%,#7db9e8 100%); color: white;">
                    <h5 class="modal-title" id="welcomeModalLabel">üéµ Welcome to Eurovision Simulator! üéµ</h5>
                </div>
                <div class="modal-body text-center">
                    <h4 style="color: #2989d8; margin-bottom: 20px;">Join Our Community!</h4>
                    <p style="font-size: 16px; margin-bottom: 20px;">
                        Welcome to the ultimate Eurovision Song Contest simulator! üåü<br>
                        Create your own contests, predict results, and have fun!
                    </p>
                    <p style="font-size: 16px; margin-bottom: 25px;">
                        <strong>Join our Reddit community</strong> to share your simulations,<br>
                        discuss strategies, and connect with other Eurovision fans!
                    </p>
                    <a href="https://www.reddit.com/r/YourOwnESC/" target="_blank" class="btn btn-primary btn-lg"
                        style="background-color: #FF4500; border-color: #FF4500; margin-bottom: 15px;">
                        <strong>üì± Visit r/YourOwnESC</strong>
                    </a>
                    <p style="font-size: 14px; color: #666; margin-top: 20px;">
                        This message will only appear once. Enjoy the simulator!
                    </p>
                </div>
                <div class="modal-footer" style="justify-content: center;">
                    <button type="button" class="btn btn-success btn-lg" data-bs-dismiss="modal">Let's Start!
                        üéâ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JESC Voting Modal -->
    <div class="modal fade" id="jescVotingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white;">
                    <h5 class="modal-title">üëæ Junior Eurovision 2025 Voting</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="jescVotingTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="vote-tab" data-bs-toggle="tab"
                                data-bs-target="#vote-content" type="button" role="tab">üíñ Your Favorite</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="prediction-tab" data-bs-toggle="tab"
                                data-bs-target="#prediction-content" type="button" role="tab">üîÆ Prediction (Who will
                                win?)</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="jescVotingTabContent">
                        <!-- Vote Tab -->
                        <div class="tab-pane fade show active" id="vote-content" role="tabpanel">
                            <div id="jescVotingContent">
                                <p class="text-center mb-4">Vote for your favorite Junior Eurovision 2025 song! You can
                                    only vote once.</p>
                                <div id="jescParticipantsList" class="list-group">
                                    <!-- Participants will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <!-- Prediction Tab -->
                        <div class="tab-pane fade" id="prediction-content" role="tabpanel">
                            <div id="jescPredictionContent">
                                <p class="text-center mb-4">Who do you THINK will win? Cast your prediction!</p>
                                <div id="jescPredictionList" class="list-group">
                                    <!-- Prediction list will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nickname Modal -->
    <div class="modal fade" id="nicknameModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üë§ Choose a Nickname</h5>
                </div>
                <div class="modal-body">
                    <p>Welcome! Please choose a unique nickname to be displayed on the leaderboard.</p>
                    <div class="mb-3">
                        <label for="nicknameInput" class="form-label">Nickname</label>
                        <input type="text" class="form-control" id="nicknameInput" placeholder="Enter your nickname..."
                            maxlength="15">
                        <div id="nicknameError" class="text-danger mt-1 small"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="saveNicknameButton">Save & Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal (View/Edit) -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #ffffff; color: #333;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title">üë§ User Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="profileLoading" class="spinner-border text-primary" role="status"></div>
                    <div id="profileContent" style="display: none;">
                        <img id="profileImage" src="" class="rounded-circle mb-3 border border-3 border-light shadow"
                            style="width: 100px; height: 100px; object-fit: cover;">
                        <h3 id="profileNickname" class="fw-bold mb-1"></h3>
                        <div id="profileBadges" class="mb-2"></div>
                        <p id="profileBio" class="text-muted fst-italic px-4"></p>

                        <div id="profileTags" class="d-flex justify-content-center flex-wrap gap-2 mb-3"></div>

                        <div id="profileStats" class="row g-2 mb-3 border-top border-bottom py-2">
                            <div class="col-6 border-end">
                                <h5 class="fw-bold mb-0" id="profileSimulations">-</h5>
                                <small class="text-muted">Simulations</small>
                            </div>
                            <div class="col-6">
                                <h5 class="fw-bold mb-0" id="profileJoinDate">-</h5>
                                <small class="text-muted">Joined</small>
                            </div>
                        </div>

                        <!-- Edit Controls (Only visible to owner) -->
                        <div id="editProfileControls" style="display: none;"
                            class="mt-4 p-3 bg-light rounded text-start">
                            <h6 class="fw-bold border-bottom pb-2">‚úèÔ∏è Edit Profile</h6>
                            <div class="mb-3">
                                <label class="form-label small">Avatar URL</label>
                                <input type="text" class="form-control form-control-sm" id="editAvatarUrl"
                                    placeholder="https://...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Bio</label>
                                <textarea class="form-control form-control-sm" id="editBio" rows="2" maxlength="100"
                                    placeholder="Tell us about yourself..."></textarea>
                            </div>
                            <!-- REMOVED PREMATURE CLOSING DIV -->

                            <div class="mb-3">
                                <label class="form-label small">Favorite Country (Drag & Drop)</label>
                                <div id="favCountryDropZone"
                                    class="border p-2 mb-2 text-center d-flex align-items-center justify-content-center"
                                    style="min-height: 50px; background: #f8f9fa; border-style: dashed !important; border-radius: 6px;">
                                    <span class="text-muted small">Drag your favorite country here</span>
                                </div>
                                <input type="text" id="favCountrySearch" class="form-control form-control-sm mb-2"
                                    placeholder="Search countries..." onkeyup="filterCountries()">
                                <div id="favCountrySource" class="d-flex flex-wrap gap-2"
                                    style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; padding: 5px; border-radius: 4px; background: #fff;">
                                    <!-- Countries injected by JS -->
                                </div>
                                <input type="hidden" id="editFavCountryCode">
                                <input type="hidden" id="editFavCountryName">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Location</label>
                                <input type="text" class="form-control form-control-sm" id="editLocation"
                                    placeholder="City, Country">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Social Handle (e.g. @username)</label>
                                <input type="text" class="form-control form-control-sm" id="editSocial"
                                    placeholder="@username">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Tags</label>
                                <div class="d-flex flex-wrap gap-2" id="editTagsContainer">
                                    <!-- Tags injected by JS -->
                                </div>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="privacyToggle">
                                <label class="form-check-label small" for="privacyToggle">Private Profile (Hide stats
                                    from leaderboard)</label>
                            </div>
                            <button id="saveProfileButton" class="btn btn-primary btn-sm w-100">Save Changes</button>
                        </div> <!-- NOW CLOSING DIV HERE -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="eurovision-simulator container-fluid">
        <h1 class="text-center mb-4">YOUR VERY OWN EUROVISION SIMULATOR</h1>

        <!-- Christmas Banner -->
        <div class="christmas-banner">
            <span class="emoji">üéÖ</span>
            Merry Christmas & Happy Holidays!
            <span class="emoji">üéÅ</span>
            Season's Greetings!
            <span class="emoji">‚òÉÔ∏è</span>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card menu-card">
                    <div class="card-body">
                        <!-- Auth UI -->
                        <div id="authSection" class="mb-3 p-2 text-center"
                            style="display: none; background: rgba(255,255,255,0.1); border-radius: 10px; border: 1px solid var(--card-border);">
                            <div class="d-flex align-items-center justify-content-center gap-3">
                                <img id="userAvatar" src="" alt="Avatar" class="rounded-circle"
                                    style="width: 40px; height: 40px; border: 2px solid #fff;">
                                <div class="text-start">
                                    <h6 id="userName" class="mb-0 fw-bold">User</h6>
                                    <small class="text-success">‚óè Online</small>
                                </div>
                                <button id="logoutButton" class="btn btn-sm btn-outline-danger ms-2">Logout</button>
                                <button id="myProfileButton" class="btn btn-sm btn-outline-primary ms-1">My
                                    Profile</button>
                            </div>
                        </div>
                        <button id="loginButton" class="btn btn-light mb-2 w-100 fw-bold"
                            style="color: #444; border: 1px solid #ddd;">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G"
                                style="width: 18px; margin-right: 8px;">
                            Sign in with Google
                        </button>
                        <hr class="dropdown-divider mb-3" style="border-top: 1px solid rgba(255,255,255,0.2);">

                        <button id="toggleDarkMode" class="btn btn-secondary mb-2">DARK MODE</button>
                        <button id="toggleChristmas" class="btn btn-danger mb-2">üéÑ CHRISTMAS MODE</button>
                        <button id="adventCalendarButton" class="btn btn-success mb-2">üìÖ ADVENT CALENDAR</button>
                        <button id="leaderboardButton" class="btn btn-warning mb-2">üèÜ LEADERBOARD</button>
                        <button id="userLeaderboardButton" class="btn btn-primary mb-2"
                            style="background: #6f42c1; border-color: #6f42c1;">üë§ USER LEADERBOARD</button>
                        <button id="jescVoteButton" class="btn btn-primary mb-2"
                            style="background: linear-gradient(45deg, #FFD700, #FF8C00); border: none; color: black; font-weight: bold;">üèÜ
                            JESC 2025 WINNER</button>
                        <button id="instructionsButton" class="btn btn-info mb-2">INSTRUCTIONS</button>
                        <button id="whatsNewButton" class="btn btn-warning mb-2">WHAT'S NEW?</button>
                        <button id="generateButton" class="btn btn-warning mb-2">GENERATE</button>
                        <button id="semiFinal1Button" class="btn btn-secondary mb-2" disabled>1ST SEMI CHART</button>
                        <button id="semiFinal2Button" class="btn btn-secondary mb-2" disabled>2ND SEMI CHART</button>
                        <button id="finaleButton" class="btn btn-info mb-2" disabled>FINALE CHART</button>
                        <h5> Simulate here: </h5>
                        <button id="simulateSemiDrawButton" class="btn btn-primary mb-2" disabled>SIMULATE SEMI-FINALE
                            DRAW</button>
                        <button id="simulateButton" class="btn btn-secondary mb-2" disabled>SIMULATE
                            SEMI-FINALE</button>
                        <button id="dynamicVotingButton" class="btn btn-success mb-2" disabled>DYNAMIC FINALE
                            VOTING</button>
                        <button id="dynamicESCVotingButton" class="btn btn-success mb-2" disabled>DYNAMIC ESC
                            VOTING</button>
                        <button id="resetButton" class="btn btn-danger mb-2">RESET CURRENT SIMULATION</button>
                        <button id="saveScenarioButton" class="btn btn-success mb-2">SAVE SCENARIO</button>
                        <button id="loadScenarioButton" class="btn btn-info mb-2">LOAD SCENARIO</button>
                        <input type="file" id="loadScenarioInput" style="display: none;" accept=".json">
                    </div>
                </div>
            </div>
        </div>

        <div id="dynamicVotingArea" class="mb-4"></div>

        <div class="row">
            <div class="col-md-12">
                <div class="card settings-card">
                    <div class="card-body">
                        <h5>V.1.2.7</h5>
                        <h2>Select Participating Countries and Set Odds<br> (11-50 countries semi-finals starting with
                            27, odds -> lower is better):</h2>
                        <h3 id="selectedCount" style="color: black;">Total Selected Countries: 0/50</h3>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="accordion" id="countryAccordion">
                                    <!-- Current Contestants -->
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="participantsYear" class="form-label"> - Year to load
                                                participants:</label>
                                            <input type="number" id="participantsYear" class="form-control" min="1956"
                                                max="2100" value="2025">
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <!-- Use a warning button so it stands out against the blue background -->
                                            <button id="loadParticipantsButton" class="btn btn-warning w-100">Load
                                                Participants</button>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingCurrent">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                                data-bs-target="#collapseCurrent" aria-expanded="true"
                                                aria-controls="collapseCurrent">
                                                Current Contestants
                                            </button>
                                        </h2>
                                        <div id="collapseCurrent" class="accordion-collapse collapse show"
                                            aria-labelledby="headingCurrent" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="currentContestants" class="selection-table w-100">
                                                    </table>
                                                </div>
                                                <button id="selectAllCurrent" class="btn btn-primary mt-2">Select All
                                                    Current</button>
                                                <button id="unselectAllCurrent"
                                                    class="btn btn-secondary mt-2 ml-2">Unselect All Current</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Old Contestants -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingOld">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseOld"
                                                aria-expanded="false" aria-controls="collapseOld">
                                                Non-Current Contestants
                                            </button>
                                        </h2>
                                        <div id="collapseOld" class="accordion-collapse collapse"
                                            aria-labelledby="headingOld" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="oldContestants" class="selection-table w-100"></table>
                                                </div>
                                                <button id="selectAllOld" class="btn btn-primary mt-2">Select All
                                                    Non-Current</button>
                                                <button id="unselectAllOld" class="btn btn-secondary mt-2 ml-2">Unselect
                                                    All Non-Current</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Rest of Europe -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingRestEurope">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseRestEurope"
                                                aria-expanded="false" aria-controls="collapseRestEurope">
                                                Rest of Europe
                                            </button>
                                        </h2>
                                        <div id="collapseRestEurope" class="accordion-collapse collapse"
                                            aria-labelledby="headingRestEurope" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="restEuropeContestants" class="selection-table w-100">
                                                    </table>
                                                </div>
                                                <button id="selectAllRestOfEurope" class="btn btn-primary mt-2">Select
                                                    All Rest of Europe</button>
                                                <button id="unselectAllRestOfEurope"
                                                    class="btn btn-secondary mt-2 ml-2">Unselect All Rest of
                                                    Europe</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- North America -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingNorthAmerica">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseNorthAmerica"
                                                aria-expanded="false" aria-controls="collapseNorthAmerica">
                                                North America
                                            </button>
                                        </h2>
                                        <div id="collapseNorthAmerica" class="accordion-collapse collapse"
                                            aria-labelledby="headingNorthAmerica" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="northAmericaContestants" class="selection-table w-100">
                                                    </table>
                                                </div>
                                                <button id="selectAllNorthAmerica" class="btn btn-primary mt-2">Select
                                                    All North America</button>
                                                <button id="unselectAllNorthAmerica"
                                                    class="btn btn-secondary mt-2 ml-2">Unselect All North
                                                    America</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- South America -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingSouthAmerica">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseSouthAmerica"
                                                aria-expanded="false" aria-controls="collapseSouthAmerica">
                                                South America
                                            </button>
                                        </h2>
                                        <div id="collapseSouthAmerica" class="accordion-collapse collapse"
                                            aria-labelledby="headingSouthAmerica" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="southAmericaContestants" class="selection-table w-100">
                                                    </table>
                                                </div>
                                                <button id="selectAllSouthAmerica" class="btn btn-primary mt-2">Select
                                                    All South America</button>
                                                <button id="unselectAllSouthAmerica"
                                                    class="btn btn-secondary mt-2 ml-2">Unselect All South
                                                    America</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Africa -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingAfrica">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseAfrica"
                                                aria-expanded="false" aria-controls="collapseAfrica">
                                                Africa
                                            </button>
                                        </h2>
                                        <div id="collapseAfrica" class="accordion-collapse collapse"
                                            aria-labelledby="headingAfrica" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="africaContestants" class="selection-table w-100"></table>
                                                </div>
                                                <button id="selectAllAfrica" class="btn btn-primary mt-2">Select All
                                                    Africa</button>
                                                <button id="unselectAllAfrica"
                                                    class="btn btn-secondary mt-2 ml-2">Unselect All Africa</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Asia -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingAsia">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseAsia"
                                                aria-expanded="false" aria-controls="collapseAsia">
                                                Asia
                                            </button>
                                        </h2>
                                        <div id="collapseAsia" class="accordion-collapse collapse"
                                            aria-labelledby="headingAsia" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="asiaContestants" class="selection-table w-100"></table>
                                                </div>
                                                <button id="selectAllAsia" class="btn btn-primary mt-2">Select All
                                                    Asia</button>
                                                <button id="unselectAllAsia"
                                                    class="btn btn-secondary mt-2 ml-2">Unselect All Asia</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Oceania -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingOceania">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseOceania"
                                                aria-expanded="false" aria-controls="collapseOceania">
                                                Oceania
                                            </button>
                                        </h2>
                                        <div id="collapseOceania" class="accordion-collapse collapse"
                                            aria-labelledby="headingOceania" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="oceaniaContestants" class="selection-table w-100">
                                                    </table>
                                                </div>
                                                <button id="selectAllOceania" class="btn btn-primary mt-2">Select All
                                                    Oceania</button>
                                                <button id="unselectAllOceania"
                                                    class="btn btn-secondary mt-2 ml-2">Unselect All Oceania</button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Custom Contestants -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingCustom">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseCustom"
                                                aria-expanded="false" aria-controls="collapseCustom">
                                                Custom Contestants
                                            </button>
                                        </h2>
                                        <div id="collapseCustom" class="accordion-collapse collapse"
                                            aria-labelledby="headingCustom" data-bs-parent="#countryAccordion">
                                            <div class="accordion-body">
                                                <div class="overflow-auto" style="max-height: 400px;">
                                                    <table id="customContestants" class="selection-table w-100"></table>
                                                </div>
                                                <button id="addCustomContestant" class="btn btn-primary mt-2">Add Custom
                                                    Contestant</button>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <button id="show_custom" class="btn btn-primary mt-2">Click here for custom
                                    contestants.</button>
                                <div id="custom_showing" style="display: none;" class="row">
                                    <div class="col-md-4">
                                        <div class="section-header">Custom Contestants</div>
                                        <div class="overflow-auto" style="max-height: 400px;">
                                            <table id="customContestants" class="selection-table w-100"></table>
                                        </div>
                                        <button id="selectAllCustom" class="btn btn-primary mt-2">Select All
                                            Custom</button>
                                        <button id="unselectAllCustom" class="btn btn-secondary mt-2 ml-2">Unselect All
                                            Custom</button>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="section-header">Add Contestants</div>
                                        <div class="overflow-auto" style="max-height: 400px;">
                                            <div class="selection-table w-100">
                                                <input placeholder="Name" id="custom_name" />
                                                <input placeholder="Code (E.g: Swiss is ch)" id="custom_code" />
                                                <input placeholder="Flag (E.g: Direct link.png)" id="custom_flag" />
                                                <button class="btn btn-success w-100 mt-4" id="add_contestant">Add
                                                    +</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="section-header">Save Contestants</div>
                                        <div class="overflow-auto" style="max-height: 400px;">
                                            <div class="selection-table w-100">
                                                <button class="btn btn-success w-100 mt-4"
                                                    id="export_custom">Export</button>
                                                <button class="btn btn-info w-100 mt-4"
                                                    id="import_custom">Import</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            Odds Controls
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-6">
                                                    <button id="randomizeButton" class="btn btn-success w-100">Randomize
                                                        All Odds</button>
                                                </div>
                                                <div class="col-6">
                                                    <button id="defaultOddsButton" class="btn btn-info w-100">Default
                                                        Odds (100)</button>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-6">
                                                    <button id="randomizeJuryButton"
                                                        class="btn btn-outline-success w-100">Randomize Jury
                                                        Odds</button>
                                                </div>
                                                <div class="col-6">
                                                    <button id="randomizeTeleButton"
                                                        class="btn btn-outline-success w-100">Randomize Tele
                                                        Odds</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            Odds Settings
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="maxOddsDifference" class="form-label">Max Jury-Tele Odds
                                                    Difference:</label>
                                                <input type="number" id="maxOddsDifference" class="form-control"
                                                    value="75" min="0" max="499">
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <label for="minOdds" class="form-label">Min Odds:</label>
                                                    <input type="number" id="minOdds" class="form-control" value="1"
                                                        min="1" max="500">
                                                </div>
                                                <div class="col-6">
                                                    <label for="maxOdds" class="form-label">Max Odds:</label>
                                                    <input type="number" id="maxOdds" class="form-control" value="500"
                                                        min="1" max="500">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="randomizeGenresButton" class="btn btn-secondary w-100 mt-2">Randomize
                                Genres</button>
                            <button id="randomizeScenographiesButton" class="btn btn-secondary w-100 mt-2">Randomize
                                Scenographies</button>
                            <button id="randomizeGenreLikeabilityButton" class="btn btn-secondary w-100 mt-2">Randomize
                                Genre Likeability</button>
                            <button id="randomizeScenographyLikeabilityButton"
                                class="btn btn-secondary w-100 mt-2">Randomize Scenography Likeability</button>

                            <div class="mt-4">
                                <label for="revealTime" class="form-label">Time before revealing qualifier
                                    (seconds):</label>
                                <select id="revealTime" class="form-select">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="15">15</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <p class="mt-2">Genre Likeability: 1 (Least Liked) to 5 (Most Liked)</p>
                                <small class="text-muted">Higher likeability (5) improves a country's odds, while lower
                                    likeability (1) worsens them.</small>
                                <h3 class="mt-4">Genre Likeability</h3>
                                <div id="genreLikeability"></div>
                            </div>
                            <div class="mt-4">
                                <p class="mt-2">Scenography Likeability: 1 (Least Liked) to 5 (Most Liked)</p>
                                <small class="text-muted">Higher likeability (5) improves a country's odds, while lower
                                    likeability (1) worsens them.</small>
                                <h3 class="mt-4">Scenography Likeability</h3>
                                <div id="scenographyLikeability"></div>
                            </div>
                            <div class="mt-4">
                                <label for="votingSystem" class="form-label">Voting System:</label>
                                <select id="votingSystem" class="form-select">
                                    <option value="current">1-8, 10, 12 with Jury Voting in Semi-Finals</option>
                                    <option value="noJurySemi">1-8, 10, 12 without Jury Voting in Semi-Finals</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chartContainer" class="mt-4"></div>
            <div id="results" class="mt-4"></div>
        </div>

        <script>
            // Dark mode toggle
            const toggleButton = document.getElementById('toggleDarkMode');
            function updateToggleButton() {
                if (document.body.classList.contains('dark-mode')) {
                    toggleButton.textContent = 'LIGHT MODE';
                } else {
                    toggleButton.textContent = 'DARK MODE';
                }
            }
            toggleButton.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                updateToggleButton();
                localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
            });
            // On load, check preference
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
            }
            updateToggleButton();

            // Welcome Modal - show only on first visit
            // Wait for Bootstrap to be fully loaded
            window.addEventListener('load', () => {
                const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
                const jescPromoShown = sessionStorage.getItem('jescPromoShown');

                if (!localStorage.getItem('welcomeModalShown')) {
                    // First time user: Show Welcome
                    welcomeModal.show();
                    document.getElementById('welcomeModal').addEventListener('hidden.bs.modal', () => {
                        localStorage.setItem('welcomeModalShown', 'true');
                    });
                }
            });

            const chartContainer = document.createElement('div');
            chartContainer.id = 'chartContainer';
            document.querySelector('.eurovision-simulator').appendChild(chartContainer);
            const currentContestants = [
                "Albania", "Armenia", "Australia", "Austria", "Azerbaijan", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czechia",
                "Denmark", "Estonia", "Finland", "France", "Georgia", "Germany", "Greece", "Iceland", "Ireland", "Israel", "Italy",
                "Latvia", "Lithuania", "Luxembourg", "Malta", "Moldova", "Montenegro", "Netherlands", "North Macedonia", "Norway",
                "Poland", "Portugal", "Romania", "San Marino", "Serbia", "Slovenia", "Spain", "Sweden", "Switzerland", "Ukraine",
                "United Kingdom"
            ];

            // Old Contestants (Former Participants)
            const oldContestants = [
                "Andorra", "Belarus", "Bosnia & Herz.", "Hungary", "Monaco", "Morocco", "Russia", "Slovakia", "Turkey"
            ];

            // Rest of Europe (Non-EU/Non-Eurovision)
            const restEuropeContestants = [
                "Liechtenstein", "Kosovo", "Vatican City", "Faroe Islands", "Greenland"
            ];

            // North America
            const northAmericaContestants = [
                "Antigua and Barbuda", "Bahamas", "Barbados", "Belize", "Canada", "Costa Rica", "Cuba", "Dominica", "Dominican Republic",
                "El Salvador", "Grenada", "Guatemala", "Haiti", "Honduras", "Jamaica", "Mexico", "Nicaragua", "Panama",
                "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Trinidad and Tobago", "United States"
            ];

            // South America
            const southAmericaContestants = [
                "Argentina", "Bolivia", "Brazil", "Chile", "Colombia", "Ecuador", "Guyana", "Paraguay", "Peru", "Suriname", "Uruguay", "Venezuela"
            ];

            // Africa (without Morocco)
            const africaContestants = [
                "Algeria", "Angola", "Benin", "Botswana", "Burkina Faso", "Burundi", "Cabo Verde", "Cameroon", "Central African Republic",
                "Chad", "Comoros", "Congo", "Democratic Republic of the Congo", "Djibouti",
                "Egypt", "Equatorial Guinea", "Eritrea", "Eswatini", "Ethiopia", "Gabon", "Gambia", "Ghana", "Guinea", "Guinea-Bissau",
                "Ivory Coast", "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar", "Malawi", "Mali", "Mauritania", "Mauritius",
                "Mozambique", "Namibia", "Niger", "Nigeria", "Rwanda", "S√£o Tom√© and Pr√≠ncipe", "Senegal", "Seychelles",
                "Sierra Leone", "Somalia", "South Africa", "South Sudan", "Sudan", "Tanzania", "Togo", "Tunisia", "Uganda", "Zambia", "Zimbabwe"
            ];

            // Asia (without Armenia, Azerbaijan, Cyprus, Georgia, Israel)
            const asiaContestants = [
                "Afghanistan", "Bahrain", "Bangladesh", "Bhutan", "Brunei", "Cambodia", "China", "India", "Indonesia",
                "Iran", "Iraq", "Japan", "Jordan", "Kazakhstan", "Kuwait", "Kyrgyzstan", "Laos", "Lebanon", "Malaysia",
                "Maldives", "Mongolia", "Myanmar", "Nepal", "North Korea", "Oman", "Pakistan", "Palestine", "Philippines",
                "Qatar", "Saudi Arabia", "Singapore", "South Korea", "Sri Lanka", "Syria", "Taiwan", "Tajikistan", "Thailand",
                "Timor-Leste", "Turkmenistan", "United Arab Emirates", "Uzbekistan", "Vietnam", "Yemen"
            ];

            // Oceania (without Australia)
            const oceaniaContestants = [
                "Fiji", "Kiribati", "Marshall Islands", "Micronesia", "Nauru", "New Zealand", "Palau", "Papua New Guinea",
                "Samoa", "Solomon Islands", "Tonga", "Tuvalu", "Vanuatu"
            ];

            var customContestants = []

            var customContestantsFlag = []

            //
            // Consolidate all predefined country lists into a single object.  This makes it
            // easy to iterate over them later when building the tables.  Keeping these
            // mappings in one place also makes it trivial to add or remove categories
            // without duplicating calls to `createCountryTable` for each new list.
            //
            const contestantLists = {
                currentContestants,
                oldContestants,
                restEuropeContestants,
                northAmericaContestants,
                southAmericaContestants,
                africaContestants,
                asiaContestants,
                oceaniaContestants,
                customContestants,
            };

            const genres = ["Pop", "Disco", "Dark Pop", "Pop Ballad", "Power Ballad", "Folk", "Country", "Jazz", "Rock", "Punk", "Heavy Metal", "Techno", "Rap"];
            let genreLikeability = {};
            genres.forEach(genre => genreLikeability[genre] = 3);

            const scenographies = ["Minimal", "LED Screens", "Props", "Dancers", "Pyrotechnics", "Stage Levels", "Projections", "Interactive", "Classical", "Abstract"];
            let scenographyLikeability = {};
            scenographies.forEach(scenography => scenographyLikeability[scenography] = 3);

            function randomizeGenreLikeability() {
                genres.forEach(genre => {
                    genreLikeability[genre] = Math.floor(Math.random() * 5) + 1;
                });
                updateGenreLikeabilityUI();
            }

            function updateGenreLikeabilityUI() {
                document.querySelectorAll('.genre-likeability').forEach(input => {
                    input.value = genreLikeability[input.dataset.genre];
                });
            }

            function randomizeScenographyLikeability() {
                scenographies.forEach(scenography => {
                    scenographyLikeability[scenography] = Math.floor(Math.random() * 5) + 1;
                });
                updateScenographyLikeabilityUI();
            }

            function updateScenographyLikeabilityUI() {
                document.querySelectorAll('.scenography-likeability').forEach(input => {
                    input.value = scenographyLikeability[input.dataset.scenography];
                });
            }

            document.getElementById('randomizeGenreLikeabilityButton').addEventListener('click', randomizeGenreLikeability);

            var customcountryCodeMap = {}

            function getCountryCode(countryName) {
                const countryCodeMap = {
                    // Current Contestants (Europe)
                    "Albania": "al", "Armenia": "am", "Australia": "au", "Austria": "at", "Azerbaijan": "az",
                    "Belgium": "be", "Bulgaria": "bg", "Croatia": "hr", "Cyprus": "cy", "Czechia": "cz",
                    "Denmark": "dk", "Estonia": "ee", "Finland": "fi", "France": "fr", "Georgia": "ge",
                    "Germany": "de", "Greece": "gr", "Iceland": "is", "Ireland": "ie", "Israel": "il",
                    "Italy": "it", "Latvia": "lv", "Lithuania": "lt", "Luxembourg": "lu", "Malta": "mt",
                    "Moldova": "md", "Montenegro": "me", "Netherlands": "nl", "North Macedonia": "mk", "Norway": "no",
                    "Poland": "pl", "Portugal": "pt", "Romania": "ro", "San Marino": "sm", "Serbia": "rs",
                    "Slovenia": "si", "Spain": "es", "Sweden": "se", "Switzerland": "ch", "Ukraine": "ua",
                    "United Kingdom": "gb",

                    // Old Contestants
                    "Andorra": "ad", "Belarus": "by", "Bosnia & Herz.": "ba", "Hungary": "hu", "Monaco": "mc",
                    "Morocco": "ma", "Russia": "ru", "Slovakia": "sk", "Turkey": "tr",

                    // Rest of Europe
                    "Liechtenstein": "li", "Kosovo": "xk", "Vatican City": "va", "Faroe Islands": "fo", "Greenland": "gl",

                    // North America
                    "Antigua and Barbuda": "ag", "Bahamas": "bs", "Barbados": "bb", "Belize": "bz", "Canada": "ca",
                    "Costa Rica": "cr", "Cuba": "cu", "Dominica": "dm", "Dominican Republic": "do", "El Salvador": "sv",
                    "Grenada": "gd", "Guatemala": "gt", "Haiti": "ht", "Honduras": "hn", "Jamaica": "jm",
                    "Mexico": "mx", "Nicaragua": "ni", "Panama": "pa", "Saint Kitts and Nevis": "kn",
                    "Saint Lucia": "lc", "Saint Vincent and the Grenadines": "vc", "Trinidad and Tobago": "tt", "United States": "us",

                    // South America
                    "Argentina": "ar", "Bolivia": "bo", "Brazil": "br", "Chile": "cl", "Colombia": "co",
                    "Ecuador": "ec", "Guyana": "gy", "Paraguay": "py", "Peru": "pe", "Suriname": "sr", "Uruguay": "uy", "Venezuela": "ve",

                    // Africa
                    "Algeria": "dz", "Angola": "ao", "Benin": "bj", "Botswana": "bw", "Burkina Faso": "bf",
                    "Burundi": "bi", "Cabo Verde": "cv", "Cameroon": "cm", "Central African Republic": "cf", "Chad": "td",
                    "Comoros": "km", "Congo": "cg", "Democratic Republic of the Congo": "cd", "Djibouti": "dj", "Egypt": "eg",
                    "Equatorial Guinea": "gq", "Eritrea": "er", "Eswatini": "sz", "Ethiopia": "et", "Gabon": "ga", "Gambia": "gm",
                    "Ghana": "gh", "Guinea": "gn", "Guinea-Bissau": "gw", "Ivory Coast": "ci", "Kenya": "ke",
                    "Lesotho": "ls", "Liberia": "lr", "Libya": "ly", "Madagascar": "mg", "Malawi": "mw", "Mali": "ml",
                    "Mauritania": "mr", "Mauritius": "mu", "Mozambique": "mz", "Namibia": "na", "Niger": "ne", "Nigeria": "ng",
                    "Rwanda": "rw", "S√£o Tom√© and Pr√≠ncipe": "st", "Senegal": "sn", "Seychelles": "sc", "Sierra Leone": "sl",
                    "Somalia": "so", "South Africa": "za", "South Sudan": "ss", "Sudan": "sd", "Tanzania": "tz", "Togo": "tg",
                    "Tunisia": "tn", "Uganda": "ug", "Zambia": "zm", "Zimbabwe": "zw",

                    // Asia
                    "Afghanistan": "af", "Bahrain": "bh", "Bangladesh": "bd", "Bhutan": "bt", "Brunei": "bn",
                    "Cambodia": "kh", "China": "cn", "India": "in", "Indonesia": "id", "Iran": "ir", "Iraq": "iq", "Japan": "jp",
                    "Jordan": "jo", "Kazakhstan": "kz", "Kuwait": "kw", "Kyrgyzstan": "kg", "Laos": "la", "Lebanon": "lb",
                    "Malaysia": "my", "Maldives": "mv", "Mongolia": "mn", "Myanmar": "mm", "Nepal": "np", "North Korea": "kp",
                    "Oman": "om", "Pakistan": "pk", "Palestine": "ps", "Philippines": "ph", "Qatar": "qa", "Saudi Arabia": "sa",
                    "Singapore": "sg", "South Korea": "kr", "Sri Lanka": "lk", "Syria": "sy", "Taiwan": "tw", "Tajikistan": "tj",
                    "Thailand": "th", "Timor-Leste": "tl", "Turkmenistan": "tm", "United Arab Emirates": "ae", "Uzbekistan": "uz",
                    "Vietnam": "vn", "Yemen": "ye",

                    // Oceania (without Australia)
                    "Fiji": "fj", "Kiribati": "ki", "Marshall Islands": "mh", "Micronesia": "fm", "Nauru": "nr",
                    "New Zealand": "nz", "Palau": "pw", "Papua New Guinea": "pg", "Samoa": "ws", "Solomon Islands": "sb",
                    "Tonga": "to", "Tuvalu": "tv", "Vanuatu": "vu"
                };
                return (countryCodeMap[countryName] || customcountryCodeMap[countryName]) || "unknown";
            }

            function createCountryTable(containerId, countries) {
                const container = document.getElementById(containerId);
                container.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => {
                    input.addEventListener('change', validateOddsDifference);
                });
                let html = '';
                for (let i = 0; i < countries.length; i += 3) {
                    html += '<tr>';
                    for (let j = i; j < Math.min(i + 3, countries.length); j++) {
                        html += `
                <td>
                    <div class="checkbox-container">
                        <input class="form-check-input country-checkbox" type="checkbox" value="${countries[j]}">
                        <span class="aq-label">AQ</span>
                        <input class="aq-checkbox" type="checkbox" value="${countries[j]}" title="Auto-qualifier">
                        <span class="country-name">
                            ${countries[j]}
                            <span class="flag-icon flag-icon-${getCountryCode(countries[j])} ml-2"></span>
                        </span>
                    </div>
                    <div class="odds-inputs">
                        <input type="number" class="form-control jury-odds-input" min="1" max="500" value="100" placeholder="Jury Odds">
                        <input type="number" class="form-control tele-odds-input" min="1" max="500" value="100" placeholder="Tele Odds">
                    </div>
                    <select class="genre-select">
                        ${genres.map(genre => `<option value="${genre}">${genre}</option>`).join('')}
                    </select>
                    <select class="scenography-select">
                        ${scenographies.map(scenography => `<option value="${scenography}">${scenography}</option>`).join('')}
                    </select>
                    <div class="song-info-inputs mt-2">
                        <input type="text" class="form-control song-title-input" placeholder="Song Title (optional)" style="font-size: 0.85em; margin-bottom: 3px;">
                        <input type="text" class="form-control artist-name-input" placeholder="Artist Name (optional)" style="font-size: 0.85em; margin-bottom: 3px;">
                        <select class="form-control language-select" style="font-size: 0.85em;">
                            <option value="">Language (optional)</option>
                            <option value="English">English</option>
                            <option value="Native">Native Language</option>
                            <option value="French">French</option>
                            <option value="Italian">Italian</option>
                            <option value="Spanish">Spanish</option>
                            <option value="German">German</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </td>
            `;
                    }
                    html += '</tr>';
                }
                container.innerHTML = html;
            }


            // Build all country tables by iterating over the consolidated lists.
            // Using Object.entries allows us to dynamically generate each table without
            // repeating nearly identical calls for each category.  If a new region is
            // added to `contestantLists`, it will automatically be rendered here.
            Object.entries(contestantLists).forEach(([tableId, list]) => {
                createCountryTable(tableId, list);
            });


            const generateButton = document.getElementById('generateButton');
            const randomizeButton = document.getElementById('randomizeButton');
            const defaultOddsButton = document.getElementById('defaultOddsButton');
            const resultsDiv = document.getElementById('results');
            const semiFinal1Button = document.getElementById('semiFinal1Button');
            const semiFinal2Button = document.getElementById('semiFinal2Button');
            const finaleButton = document.getElementById('finaleButton');
            const selectAllCurrentButton = document.getElementById('selectAllCurrent');
            const selectAllOldButton = document.getElementById('selectAllOld');
            const selectAllCustomButton = document.getElementById('selectAllCustom');
            const unselectAllCurrentButton = document.getElementById('unselectAllCurrent');
            const unselectAllOldButton = document.getElementById('unselectAllOld');
            const unselectAllCustomButton = document.getElementById('unselectAllCustom');
            const simulateButton = document.getElementById('simulateButton');
            const dynamicVotingButton = document.getElementById('dynamicVotingButton');
            const dynamicVotingArea = document.getElementById('dynamicVotingArea');
            const addCustomContestantButton = document.getElementById('add_contestant');
            const showCustomContestantButton = document.getElementById('show_custom');
            const importCustomContestantButton = document.getElementById('import_custom');
            const exportCustomContestantButton = document.getElementById('export_custom');
            const randomizeJuryButton = document.getElementById('randomizeJuryButton');
            const randomizeTeleButton = document.getElementById('randomizeTeleButton');
            const selectAllRestOfEuropeButton = document.getElementById('selectAllRestOfEurope');
            const unselectAllRestOfEuropeButton = document.getElementById('unselectAllRestOfEurope');
            const selectAllNorthAmericaButton = document.getElementById('selectAllNorthAmerica');
            const unselectAllNorthAmericaButton = document.getElementById('unselectAllNorthAmerica');
            const selectAllSouthAmericaButton = document.getElementById('selectAllSouthAmerica');
            const unselectAllSouthAmericaButton = document.getElementById('unselectAllSouthAmerica');
            const selectAllAfricaButton = document.getElementById('selectAllAfrica');
            const unselectAllAfricaButton = document.getElementById('unselectAllAfrica');
            const selectAllAsiaButton = document.getElementById('selectAllAsia');
            const unselectAllAsiaButton = document.getElementById('unselectAllAsia');
            const selectAllOceaniaButton = document.getElementById('selectAllOceania');
            const unselectAllOceaniaButton = document.getElementById('unselectAllOceania');
            const dynamicESCVotingButton = document.getElementById('dynamicESCVotingButton');

            let semiFinal1Results, semiFinal2Results, finalResults;
            let currentSemiFinal = 1;

            let selectedVotingSystem = 'current';

            //
            // Load participants for a given year from an external API.  This function makes
            // a network request to a placeholder URL to retrieve the list of countries
            // participating in a given Eurovision year.  The result should be an array of
            // country names.  On success, it updates the `currentContestants` list and
            // regenerates the corresponding table.  If the request fails (e.g. due to
            // network issues or the API being unavailable), an alert is shown and the
            // static list remains unchanged.
            /*
                     * Load the Eurovision participants for the selected year from the
                     * freely available dataset maintained on GitHub.  The dataset is a
                     * JSON array of contest objects, each containing a "year" field and
                     * a list of "contestants".  Each contestant has a "country"
                     * property containing the ISO 3166 alpha‚Äë2 code of the country.  We
                     * also load the companion countries.json file which maps those
                     * country codes to human‚Äëreadable names.  See the dataset for more
                     * information„Äê242465117659110‚Ä†L0-L9„Äë.
                     *
                     * Because GitHub raw content sets the Access‚ÄëControl‚ÄëAllow‚ÄëOrigin
                     * header to "*", it can be fetched directly from the browser
                     * (without needing a CORS proxy).  If the dataset is ever moved or
                     * removed, update the URLs below accordingly.  Note: the dataset is
                     * static and may not include the most recent contest; if the
                     * selected year is not found, an error will be thrown.
                     */
            async function loadParticipants() {
                const year = parseInt(document.getElementById('participantsYear').value, 10);
                try {
                    const [contestDataResponse, countriesResponse] = await Promise.all([
                        fetch('https://raw.githubusercontent.com/josago97/EurovisionDataset/main/dataset/eurovision.json'),
                        fetch('https://raw.githubusercontent.com/josago97/EurovisionDataset/main/dataset/countries.json')
                    ]);

                    if (!contestDataResponse.ok || !countriesResponse.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const contestData = await contestDataResponse.json();
                    const countriesMap = await countriesResponse.json();
                    const contest = contestData.find(c => parseInt(c.year, 10) === year);
                    if (!contest) {
                        throw new Error(`No data found for year ${year}`);
                    }
                    const codes = contest.contestants.map(contestant => contestant.country);
                    const names = codes.map(code => countriesMap[code] || code);

                    // Store the old current contestants
                    const oldCurrentContestants = contestantLists.currentContestants;

                    // Set the new current contestants
                    contestantLists.currentContestants = names;

                    // Update old contestants
                    // Remove from oldContestants any countries that are now in currentContestants
                    contestantLists.oldContestants = contestantLists.oldContestants.filter(country => !names.includes(country));

                    // Add to oldContestants the countries that were in oldCurrentContestants but not in names
                    const nonParticipants = oldCurrentContestants.filter(country => !names.includes(country));
                    contestantLists.oldContestants = [...new Set([...contestantLists.oldContestants, ...nonParticipants])];

                    // Rebuild both tables
                    createCountryTable('currentContestants', contestantLists.currentContestants);
                    createCountryTable('oldContestants', contestantLists.oldContestants);

                    // Reattach event listeners to all country checkboxes
                    document.querySelectorAll('.country-checkbox').forEach(addCheckboxListeners);

                    // Update AQ checkbox status
                    updateAQCheckboxStatus();

                    // Reset selected count
                    const countElement = document.getElementById('selectedCount');
                    if (countElement) {
                        countElement.textContent = `Total Selected Countries: 0/50`;
                    }
                } catch (error) {
                    console.error('Error loading participants:', error);
                    alert('Found no data');
                }
            }

            // Attach the click handler to the new Load Participants button
            document.getElementById('loadParticipantsButton')?.addEventListener('click', loadParticipants);

            document.getElementById('votingSystem').addEventListener('change', (e) => {
                selectedVotingSystem = e.target.value;
            });

            function randomizeGenres() {
                document.querySelectorAll('.genre-select').forEach(select => {
                    const randomIndex = Math.floor(Math.random() * genres.length);
                    select.selectedIndex = randomIndex;
                });
            }

            function randomizeScenographies() {
                document.querySelectorAll('.scenography-select').forEach(select => {
                    const randomIndex = Math.floor(Math.random() * scenographies.length);
                    select.selectedIndex = randomIndex;
                });
            }

            function calculateGenreBonus(selectedCountries) {
                const genreCounts = {};
                genres.forEach(genre => genreCounts[genre] = 0);

                selectedCountries.forEach(country => {
                    genreCounts[country.genre]++;
                });

                const totalCountries = selectedCountries.length;
                const genreBonuses = {};

                Object.entries(genreCounts).forEach(([genre, count]) => {
                    const percentage = (count / totalCountries); // 0.0 to 1.0
                    // Smooth curve: 0.97 at 0%, 1.0 at ~20%, 1.03 at 50%+
                    // Formula: 0.97 + (percentage * 0.12) capped at 1.03
                    genreBonuses[genre] = Math.min(1.03, 0.97 + (percentage * 0.12));
                });

                return genreBonuses;
            }

            randomizeJuryButton.addEventListener('click', () => {
                const minOdds = parseInt(document.getElementById('minOdds').value);
                const maxOdds = parseInt(document.getElementById('maxOdds').value);
                const maxDifference = parseInt(document.getElementById('maxOddsDifference').value);

                document.querySelectorAll('.odds-inputs').forEach(container => {
                    const juryInput = container.querySelector('.jury-odds-input');
                    const teleInput = container.querySelector('.tele-odds-input');

                    const teleOdds = parseInt(teleInput.value);
                    const juryOdds = getRandomOdds(minOdds, maxOdds, teleOdds, maxDifference);

                    juryInput.value = juryOdds;
                });
            });

            randomizeTeleButton.addEventListener('click', () => {
                const minOdds = parseInt(document.getElementById('minOdds').value);
                const maxOdds = parseInt(document.getElementById('maxOdds').value);
                const maxDifference = parseInt(document.getElementById('maxOddsDifference').value);

                document.querySelectorAll('.odds-inputs').forEach(container => {
                    const juryInput = container.querySelector('.jury-odds-input');
                    const teleInput = container.querySelector('.tele-odds-input');

                    const juryOdds = parseInt(juryInput.value);
                    const teleOdds = getRandomOdds(minOdds, maxOdds, juryOdds, maxDifference);

                    teleInput.value = teleOdds;
                });
            });

            randomizeButton.addEventListener('click', () => {
                const minOdds = parseInt(document.getElementById('minOdds').value);
                const maxOdds = parseInt(document.getElementById('maxOdds').value);
                const maxDifference = parseInt(document.getElementById('maxOddsDifference').value);

                document.querySelectorAll('.odds-inputs').forEach(container => {
                    const juryInput = container.querySelector('.jury-odds-input');
                    const teleInput = container.querySelector('.tele-odds-input');

                    const baseOdds = Math.floor(Math.random() * (maxOdds - minOdds + 1)) + minOdds;
                    const juryOdds = baseOdds;
                    const teleOdds = getRandomOdds(minOdds, maxOdds, baseOdds, maxDifference);

                    juryInput.value = juryOdds;
                    teleInput.value = teleOdds;
                });
            });

            document.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => {
                input.addEventListener('change', validateOddsDifference);
            });

            defaultOddsButton.addEventListener('click', () => {
                document.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => {
                    input.value = 100;
                });
            });

            function validateOddsDifference(event) {
                const container = event.target.closest('.odds-inputs');
                const juryInput = container.querySelector('.jury-odds-input');
                const teleInput = container.querySelector('.tele-odds-input');
                const maxDifference = parseInt(document.getElementById('maxOddsDifference').value);

                const juryOdds = parseInt(juryInput.value);
                const teleOdds = parseInt(teleInput.value);

                if (Math.abs(juryOdds - teleOdds) > maxDifference) {
                    alert(`The difference between Jury and Televoting odds cannot exceed ${maxDifference}.`);
                    event.target.value = event.target === juryInput ? teleOdds : juryOdds;
                }
            }

            function simulateDynamicESCVoting(finalResults) {
                const { results, votingOrder } = finalResults;
                const competingCountries = Object.keys(results).filter(country => results[country].isCompeting);

                dynamicVotingArea.innerHTML = '';
                const totalCountries = competingCountries.length;
                const midPoint = Math.ceil(totalCountries / 2);
                const topHalf = competingCountries.slice(0, midPoint);
                const bottomHalf = competingCountries.slice(midPoint);

                let html = `
        <h2>Dynamic ESC Voting Simulation</h2>
        <div id="votingHeader" style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px; text-align: center;"></div>
        <div class="row" id="tableContainer">
            <div class="col-md-6 table-column" id="leftTable">
                <div class="table-responsive">
                    <table class="table table-striped eurovision-table" id="topHalfTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Receiving Country</th>
                                <th>Song Title</th>
                                <th>Artist</th>
                                <th>Language</th>
                                <th>Genre</th>
                                <th class="current-jury-header">Current Jury</th>
                                <th>Jury Points</th>
                                <th>Televoting</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topHalf.map(country => `
                                <tr data-country="${country}">
                                    <td class="rank"></td>
                                    <td class="receiving-country">
                                        ${country}
                                        <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                                    </td>
                                    <td style="font-style: italic;">${results[country].songTitle || '-'}</td>
                                    <td>${results[country].artistName || '-'}</td>
                                    <td>${results[country].language || '-'}</td>
                                    <td class="genre">${results[country].genre}</td>
                                    <td class="current-jury"></td>
                                    <td class="jury-points">0</td>
                                    <td class="tele-points">0</td>
                                    <td class="total-column">0</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6 table-column" id="rightTable">
                <div class="table-responsive">
                    <table class="table table-striped eurovision-table" id="bottomHalfTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Receiving Country</th>
                                <th>Song Title</th>
                                <th>Artist</th>
                                <th>Language</th>
                                <th>Genre</th>
                                <th class="current-jury-header">Current Jury</th>
                                <th>Jury Points</th>
                                <th>Televoting</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bottomHalf.map(country => `
                                <tr data-country="${country}">
                                    <td class="rank"></td>
                                    <td class="receiving-country">
                                        ${country}
                                        <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                                    </td>
                                    <td style="font-style: italic;">${results[country].songTitle || '-'}</td>
                                    <td>${results[country].artistName || '-'}</td>
                                    <td>${results[country].language || '-'}</td>
                                    <td class="genre">${results[country].genre}</td>
                                    <td class="current-jury"></td>
                                    <td class="jury-points">0</td>
                                    <td class="tele-points">0</td>
                                    <td class="total-column">0</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <button id="nextVoteButton" class="btn btn-primary mt-3 reveal-button">Next Vote</button>
    `;

                dynamicVotingArea.innerHTML = html;

                let currentVotingIndex = 0;
                let isTelevotingRevealed = false;
                let isTelevotingStarted = false;
                let currentTeleVoteIndex = 0;
                let previousVotingCountry = null;
                const votedCountries = new Set(); // Track countries that have completed jury voting

                // Sort countries by jury points for televoting reveal (lowest to highest)
                const sortedByJuryPoints = [...competingCountries].sort((a, b) => {
                    const aJuryPoints = results[a].juryTotal || 0;
                    const bJuryPoints = results[b].juryTotal || 0;
                    return aJuryPoints - bJuryPoints;
                });

                // CSS for styling, row animations, voting country highlight, and jury-voted background
                const style = document.createElement('style');
                style.innerHTML = `
        .eurovision-table tr {
            transition: transform 0.5s ease-in-out;
            position: relative;
        }
        .moving-up::after, .moving-down::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        .moving-up::after {
            border-bottom: 5px solid green;
        }
        .moving-down::after {
            border-top: 5px solid red;
        }
        .current-jury-header {
            width: 80px; /* Smaller width for Current Jury column header */
        }
        .eurovision-table td.current-jury {
            width: 80px; /* Smaller width for Current Jury column cells */
            text-align: center;
        }
        .eurovision-table td.current-jury.jury-points-8 {
            background-color: #cd7f32 !important; /* Bronze */
            color: black;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .eurovision-table td.current-jury.jury-points-10 {
            background-color: silver !important;
            color: black;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .eurovision-table td.current-jury.jury-points-12 {
            background-color: gold !important;
            color: black;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .eurovision-table tr.televoted {
            background-color: #d5bdaf !important; /* Light brown background for televoting */
        }
        .eurovision-table td.current-jury.voting-country {
            background-color: black !important; /* Black background for the voting country */
            color: white; /* Ensure text is readable */
        }
        .eurovision-table tr.jury-voted {
            background-color: #d6ccc2 !important; /* Background for countries that have completed jury voting */
        }
    `;
                document.head.appendChild(style);

                function updateTable(callback = null) {
                    const topTableBody = document.querySelector('#topHalfTable tbody');
                    const bottomTableBody = document.querySelector('#bottomHalfTable tbody');
                    if (!topTableBody || !bottomTableBody) {
                        console.error('One or both table bodies not found');
                        return;
                    }

                    const topRows = Array.from(topTableBody.querySelectorAll('tr'));
                    const bottomRows = Array.from(bottomTableBody.querySelectorAll('tr'));
                    const allRows = [...topRows, ...bottomRows];

                    // Store current positions within each table
                    const topPositions = new Map(topRows.map((row, index) => [row.dataset.country, index]));
                    const bottomPositions = new Map(bottomRows.map((row, index) => [row.dataset.country, index]));

                    // Sort all rows based on total points
                    allRows.sort((a, b) => {
                        const aTotal = parseInt(a.querySelector('.total-column').textContent) || 0;
                        const bTotal = parseInt(b.querySelector('.total-column').textContent) || 0;
                        if (aTotal !== bTotal) {
                            return bTotal - aTotal;
                        }
                        const aCountry = a.dataset.country || '';
                        const bCountry = b.dataset.country || '';
                        return aCountry.localeCompare(bCountry);
                    });

                    // Assign new ranks based on sorted order
                    allRows.forEach((row, newIndex) => {
                        const rankCell = row.querySelector('.rank');
                        rankCell.textContent = newIndex + 1;
                    });

                    // Reassign rows to their respective tables (top or bottom half)
                    const newTopRows = allRows.slice(0, midPoint);
                    const newBottomRows = allRows.slice(midPoint);

                    // Animate within each table
                    const animateRows = (rows, tableBody, positions) => {
                        rows.forEach((row, newIndex) => {
                            const country = row.dataset.country;
                            const oldIndex = positions.get(country);
                            if (oldIndex !== undefined && newIndex !== oldIndex) {
                                const direction = newIndex > oldIndex ? 'moving-down' : 'moving-up';
                                row.classList.add(direction);
                                setTimeout(() => row.classList.remove(direction), 1000);

                                const distance = (newIndex - oldIndex) * row.offsetHeight;
                                row.style.transform = `translateY(${distance}px)`;
                            }
                        });

                        setTimeout(() => {
                            rows.forEach(row => {
                                row.style.transform = 'none';
                                tableBody.appendChild(row);
                            });
                        }, 500);
                    };

                    animateRows(newTopRows, topTableBody, topPositions);
                    animateRows(newBottomRows, bottomTableBody, bottomPositions);

                    setTimeout(() => {
                        if (callback) callback();
                    }, 500);
                }

                function revealNextVote() {
                    const votingHeader = document.getElementById('votingHeader');
                    if (currentVotingIndex < votingOrder.length && !isTelevotingRevealed) {
                        const votingCountry = votingOrder[currentVotingIndex];
                        votingHeader.innerHTML = `
                Voting Now: <span class="flag-icon flag-icon-${getCountryCode(votingCountry)}"></span> ${votingCountry} (${currentVotingIndex + 1}/${votingOrder.length})
            `;

                        // Reset Current Jury column for all rows before applying new votes
                        competingCountries.forEach(country => {
                            const row = document.querySelector(`.eurovision-table tr[data-country="${country}"]`);
                            if (row) {
                                const currentJuryCell = row.querySelector('.current-jury');
                                currentJuryCell.textContent = '';
                                currentJuryCell.className = 'current-jury'; // Reset classes
                            }
                        });

                        // Highlight the voting country's Current Jury cell with black background
                        const votingCountryRow = document.querySelector(`.eurovision-table tr[data-country="${votingCountry}"]`);
                        if (votingCountryRow) {
                            const currentJuryCell = votingCountryRow.querySelector('.current-jury');
                            currentJuryCell.classList.add('voting-country');
                        }

                        const juryVotes = results[votingCountry].juryVotesGiven;
                        const sortedVotes = Object.entries(juryVotes).sort((a, b) => a[1] - b[1]);

                        sortedVotes.forEach(([receiver, points]) => {
                            const receiverRow = document.querySelector(`.eurovision-table tr[data-country="${receiver}"]`);
                            if (receiverRow) {
                                const juryPointsCell = receiverRow.querySelector('.jury-points');
                                const currentJuryCell = receiverRow.querySelector('.current-jury');
                                const totalPointsCell = receiverRow.querySelector('.total-column');
                                const currentJuryPoints = parseInt(juryPointsCell.textContent) || 0;
                                const newJuryPoints = currentJuryPoints + points;
                                juryPointsCell.textContent = newJuryPoints;
                                totalPointsCell.textContent = newJuryPoints;

                                // Update Current Jury column with colored backgrounds
                                let className = 'current-jury';
                                if (points === 8) className += ' jury-points-8';
                                else if (points === 10) className += ' jury-points-10';
                                else if (points === 12) className += ' jury-points-12';
                                currentJuryCell.className = className;
                                currentJuryCell.textContent = points;
                            }
                        });

                        updateTable(() => {
                            // Add the current voting country to the voted set
                            votedCountries.add(votingCountry);

                            // Update background color for all countries that have voted
                            votedCountries.forEach(country => {
                                const row = document.querySelector(`.eurovision-table tr[data-country="${country}"]`);
                                if (row) {
                                    row.classList.add('jury-voted');
                                }
                            });

                            currentVotingIndex++;
                            if (currentVotingIndex >= votingOrder.length) {
                                isTelevotingRevealed = true;
                            }
                        });
                    } else if (isTelevotingRevealed && !isTelevotingStarted) {
                        // Show break before starting televoting, no table swap
                        votingHeader.innerHTML = `Preparing Televoting Results... (0/${sortedByJuryPoints.length})`;
                        isTelevotingStarted = true;
                        // No table update needed here, just wait for the next click
                    } else if (isTelevotingStarted && currentTeleVoteIndex < sortedByJuryPoints.length) {
                        revealNextTelevote();
                    }
                }

                function revealTelevoting() {
                    // Function remains for clarity, but clearing is handled in revealNextTelevote on first call
                }

                function revealNextTelevote() {
                    if (currentTeleVoteIndex === 0) {
                        // Clear Current Jury column and reset row backgrounds after all jury voting
                        competingCountries.forEach(country => {
                            const row = document.querySelector(`.eurovision-table tr[data-country="${country}"]`);
                            if (row) {
                                const currentJuryCell = row.querySelector('.current-jury');
                                currentJuryCell.textContent = '';
                                currentJuryCell.className = 'current-jury';
                                // Reset the jury-voted background color
                                row.classList.remove('jury-voted');
                            }
                        });
                    }

                    if (currentTeleVoteIndex < sortedByJuryPoints.length) {
                        const country = sortedByJuryPoints[currentTeleVoteIndex];
                        const votingHeader = document.getElementById('votingHeader');
                        votingHeader.innerHTML = `
                Televoting Reveal: <span class="flag-icon flag-icon-${getCountryCode(country)}"></span> ${country} (${currentTeleVoteIndex + 1}/${sortedByJuryPoints.length})
            `;

                        const row = document.querySelector(`.eurovision-table tr[data-country="${country}"]`);
                        if (row) {
                            const telePointsCell = row.querySelector('.tele-points');
                            const totalPointsCell = row.querySelector('.total-column');
                            const juryPointsCell = row.querySelector('.jury-points');
                            const telePoints = results[country].teleTotal;

                            telePointsCell.textContent = telePoints;
                            const totalPoints = (parseInt(juryPointsCell.textContent) || 0) + telePoints;
                            totalPointsCell.textContent = totalPoints;

                            // Highlight the row to indicate televoting points have been added
                            row.classList.add('televoted');

                            updateTable(() => {
                                currentTeleVoteIndex++;
                                if (currentTeleVoteIndex >= sortedByJuryPoints.length) {
                                    document.getElementById('nextVoteButton').style.display = 'none';
                                    votingHeader.innerHTML = 'Voting Complete';
                                }
                            });
                        } else {
                            currentTeleVoteIndex++;
                            revealNextTelevote();
                        }
                    }
                }

                document.getElementById('nextVoteButton').addEventListener('click', revealNextVote);
            }

            document.getElementById('dynamicESCVotingButton').addEventListener('click', () => {
                if (finalResults) {
                    simulateDynamicESCVoting(finalResults);
                } else {
                    alert('Please generate the contest results first.');
                }
            });

            function createSummaryTable(sortedCountries, results) {
                const totalCountries = sortedCountries.length;
                const midPoint = Math.ceil(totalCountries / 2);
                const topHalf = sortedCountries.slice(0, midPoint);
                const bottomHalf = sortedCountries.slice(midPoint);

                // Record the winner to Firebase Leaderboard
                if (sortedCountries.length > 0 && typeof window.recordSimulationWin === 'function') {
                    const winnerCountry = sortedCountries[0];
                    const winnerCode = getCountryCode(winnerCountry);
                    window.recordSimulationWin(winnerCountry, winnerCode, results, sortedCountries);
                    console.log(`üèÜ Winner recorded: ${winnerCountry} (${winnerCode})`);
                }

                let html = `
        <h2 class="results-headline">Final Summary</h2>
        <div class="row">
            <div class="col-md-6">
                <table class="table table-striped eurovision-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Country</th>
                            <th>Song Title</th>
                            <th>Total Points</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

                topHalf.forEach((country, index) => {
                    const totalPoints = results[country].juryTotal + results[country].teleTotal;
                    const rank = String(index + 1).padStart(2, '0');
                    html += `
            <tr>
                <td><span class="rank-box">${rank}</span></td>
                <td>
                    <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                    ${country}
                </td>
                <td style="font-style: italic;">${results[country].songTitle || '-'}</td>
                <td>${totalPoints}</td>
            </tr>
        `;
                });

                html += `
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-striped eurovision-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Country</th>
                            <th>Song Title</th>
                            <th>Total Points</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

                bottomHalf.forEach((country, index) => {
                    const totalPoints = results[country].juryTotal + results[country].teleTotal;
                    const rank = String(midPoint + index + 1).padStart(2, '0');
                    html += `
            <tr>
                <td><span class="rank-box">${rank}</span></td>
                <td>
                    <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                    ${country}
                </td>
                <td style="font-style: italic;">${results[country].songTitle || '-'}</td>
                <td>${totalPoints}</td>
            </tr>
        `;
                });

                html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;

                return html;
            }

            const buttonToTableMap = {
                selectAllRestOfEurope: 'restEuropeContestants',
                unselectAllRestOfEurope: 'restEuropeContestants',
                selectAllNorthAmerica: 'northAmericaContestants',
                unselectAllNorthAmerica: 'northAmericaContestants',
                selectAllSouthAmerica: 'southAmericaContestants',
                unselectAllSouthAmerica: 'southAmericaContestants',
                selectAllAfrica: 'africaContestants',
                unselectAllAfrica: 'africaContestants',
                selectAllAsia: 'asiaContestants',
                unselectAllAsia: 'asiaContestants',
                selectAllOceania: 'oceaniaContestants',
                unselectAllOceania: 'oceaniaContestants',
                selectAllCurrent: 'currentContestants',
                unselectAllCurrent: 'currentContestants',
                selectAllOld: 'oldContestants',
                unselectAllOld: 'oldContestants',
                selectAllCustom: 'customContestants',
                unselectAllCustom: 'customContestants',
            };

            // Select All buttons
            Object.keys(buttonToTableMap).forEach(buttonId => {
                if (buttonId.startsWith('selectAll')) {
                    const button = document.getElementById(buttonId);
                    button.addEventListener('click', () => {
                        console.log(`Select All button clicked: ${button.id}`);
                        const tableId = buttonToTableMap[button.id];
                        document.querySelectorAll(`#${tableId} .country-checkbox`).forEach(checkbox => {
                            checkbox.checked = true;
                        });
                        updateAQCheckboxStatus();
                    });
                }
            });

            // Unselect All buttons
            Object.keys(buttonToTableMap).forEach(buttonId => {
                if (buttonId.startsWith('unselectAll')) {
                    const button = document.getElementById(buttonId);
                    button.addEventListener('click', () => {
                        console.log(`Unselect All button clicked: ${button.id}`);
                        const tableId = buttonToTableMap[button.id];
                        document.querySelectorAll(`#${tableId} .country-checkbox`).forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        updateAQCheckboxStatus();
                    });
                }
            });

            function makeid(length) {
                let result = '';
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                const charactersLength = characters.length;
                let counter = 0;
                while (counter < length) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                    counter += 1;
                }
                return result;
            }

            const addCSS = css => document.head.appendChild(document.createElement("style")).innerHTML = css;


            addCustomContestantButton.addEventListener('click', () => {
                var con_name = "";
                const rawName = document.getElementById('custom_name').value;

                // Anti-spam validation for custom country names
                if (rawName.replace(/\s/g, '') !== "") {
                    // Check if antiSpamSystem is available (it might not be loaded yet)
                    if (typeof antiSpamSystem !== 'undefined') {
                        const validation = antiSpamSystem.validateCountryName(rawName);
                        if (!validation.valid) {
                            alert(`‚ùå Cannot add country: ${validation.reason}\n\nPlease choose a different name that doesn't contain political, offensive, or spam content.`);
                            return;
                        }
                        con_name = antiSpamSystem.sanitizeForFirebase(rawName);
                    } else {
                        con_name = rawName;
                    }
                    customContestants.push(con_name);
                } else {
                    con_name = String(Date.now()) + Math.floor(Math.random() * 10000);
                    customContestants.push(con_name);
                }

                var con_code = "";
                if (document.getElementById('custom_code').value.replace(/\s/g, '') == "") {
                    con_code = makeid(4)
                    customcountryCodeMap[con_name] = String(con_code);
                } else {
                    con_code = document.getElementById('custom_code').value;
                    customcountryCodeMap[con_name] = String(con_code);
                }
                if (document.getElementById('custom_flag').value.replace(/\s/g, '') == "") {
                    //pass
                } else {
                    customContestantsFlag.push(document.getElementById('custom_flag').value.replace(/\s/g, ''));
                    addCSS(`.flag-icon-${con_code}{ background-image: url("${document.getElementById('custom_flag').value.replace(/\s/g, '')}"); }`)
                }
                createCountryTable('customContestants', customContestants);
                document.getElementById('custom_name').value = "";
                document.getElementById('custom_code').value = "";
                document.getElementById('custom_flag').value = "";

                document.querySelectorAll('#customContestants .country-checkbox').forEach(addCheckboxListeners);

                updateAQCheckboxStatus();
            });

            showCustomContestantButton.addEventListener('click', () => {
                document.getElementById('custom_showing').style.display = document.getElementById('custom_showing').style.display == "none" ? "flex" : "none";
            })

            importCustomContestantButton.addEventListener('click', async () => {
                //customContestants.
                let str = prompt("Enter your export: (The export will not overwrite contestants you have already entered.)");
                const saveList = JSON.parse(str)
                console.log(saveList)
                customContestants = [...customContestants, ...saveList[0]];
                customcountryCodeMap = { ...customcountryCodeMap, ...saveList[1] };
                customContestantsFlag = [...customContestantsFlag, ...saveList[2]];
                for (var i = 0; i < saveList[0].length; i++) {
                    addCSS(`.flag-icon-${saveList[1][Object.keys(saveList[1])[i]].replace(/\s/g, '')}{ background-image: url("${saveList[2][i].replace(/\s/g, '')}"); }`)
                }

                alert("Imported!")
                createCountryTable('customContestants', customContestants);
            })


            exportCustomContestantButton.addEventListener('click', async () => {
                var res = JSON.stringify([customContestants, customcountryCodeMap, customContestantsFlag]);
                await navigator.clipboard.writeText(res);
                alert("Exported, and copied to your clipboard. Save this data somewhere so you don't lose it.")
            })


            function hideSettingsShowSimulation() {
                document.querySelector('.settings-card').style.display = 'none';
                resultsDiv.innerHTML = '';

                const simulationArea = document.createElement('div');
                simulationArea.id = 'simulationArea';
                simulationArea.innerHTML = `
        <div id="timerDisplay" class="mt-3 text-center"></div>
        <div class="row">
            <div class="col-md-6">
                <h3>Semi-Final ${currentSemiFinal} Countries</h3>
                <table id="semiFinalTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Song Title</th>
                            <th>Artist</th>
                            <th>Language</th>
                            <th>Genre</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h3>Qualified Countries</h3>
                <table id="qualifiedTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Song Title</th>
                            <th>Artist</th>
                            <th>Language</th>
                            <th>Genre</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <button id="nextSemiFinalButton" class="btn btn-primary mt-3" style="display: none;">Proceed to Semi-Final 2</button>
        <div class="semi-final-charts"></div>
    `;

                document.querySelector('.settings-card').insertAdjacentElement('afterend', simulationArea);
            }

            function populateSemiFinalTable(results) {
                const table = document.getElementById('semiFinalTable').getElementsByTagName('tbody')[0];
                table.innerHTML = '';

                const sortedCountries = Object.entries(results)
                    .sort(([a], [b]) => a.localeCompare(b));

                sortedCountries.forEach(([country, data]) => {
                    const row = table.insertRow();
                    row.innerHTML = `
            <td>
                ${country}
                <span class="flag-icon flag-icon-${getCountryCode(country)} ml-2"></span>
            </td>
            <td style="font-style: italic;">${data.songTitle || '-'}</td>
            <td>${data.artistName || '-'}</td>
            <td>${data.language || '-'}</td>
            <td>${data.genre}</td>
        `;
                });
            }
            // Function to collect current scenario data from the UI
            function collectScenarioData() {
                const scenario = {
                    // Version marker for the scenario file, can be useful for future compatibility
                    version: "1.2.4-scenario", // Updated version
                    selectedCountriesData: [],
                    genreLikeability: {},
                    scenographyLikeability: {}, // Added for scenography support
                    votingSystem: document.getElementById('votingSystem').value,
                    revealTime: parseInt(document.getElementById('revealTime').value),
                    minOdds: parseInt(document.getElementById('minOdds').value),
                    maxOdds: parseInt(document.getElementById('maxOdds').value),
                    maxOddsDifference: parseInt(document.getElementById('maxOddsDifference').value),
                    // Data related to custom contestants
                    customContestants: [...window.customContestants], // Assuming 'customContestants' is a global array
                    customcountryCodeMap: { ...window.customcountryCodeMap }, // Assuming 'customcountryCodeMap' is a global object
                    customContestantsFlag: [...window.customContestantsFlag] // Assuming 'customContestantsFlag' is a global array
                };

                // Collect data for each selected country
                document.querySelectorAll('.country-checkbox:checked').forEach(checkbox => {
                    const tdElement = checkbox.closest('td'); // Get the parent table cell <td>
                    if (!tdElement) {
                        console.warn('Could not find parent <td> for checkbox:', checkbox.value);
                        return; // Skip if structure is not as expected
                    }

                    // Find elements within this specific <td>
                    const containerDiv = tdElement.querySelector('.checkbox-container');
                    const oddsInputsDiv = tdElement.querySelector('.odds-inputs');
                    const genreSelect = tdElement.querySelector('.genre-select');
                    const scenographySelect = tdElement.querySelector('.scenography-select');

                    if (containerDiv && oddsInputsDiv && genreSelect && scenographySelect) {
                        const juryOddsInput = oddsInputsDiv.querySelector('.jury-odds-input');
                        const teleOddsInput = oddsInputsDiv.querySelector('.tele-odds-input');
                        const aqCheckbox = containerDiv.querySelector('.aq-checkbox');
                        const songTitleInput = tdElement.querySelector('.song-title-input');
                        const artistNameInput = tdElement.querySelector('.artist-name-input');
                        const languageSelect = tdElement.querySelector('.language-select');

                        scenario.selectedCountriesData.push({
                            name: checkbox.value,
                            juryOdds: parseInt(juryOddsInput.value),
                            teleOdds: parseInt(teleOddsInput.value),
                            genre: genreSelect.value,
                            scenography: scenographySelect.value,
                            isAQ: aqCheckbox.checked,
                            songTitle: songTitleInput ? songTitleInput.value : '',
                            artistName: artistNameInput ? artistNameInput.value : '',
                            language: languageSelect ? languageSelect.value : ''
                        });
                    } else {
                        console.warn('Could not find all required elements for country:', checkbox.value, 'within its <td>');
                    }
                });

                // Collect genre likeability settings
                genres.forEach(genre => { // 'genres' is a global array in your script
                    const inputElement = document.querySelector(`.genre-likeability[data-genre="${genre}"]`);
                    if (inputElement) {
                        scenario.genreLikeability[genre] = parseInt(inputElement.value);
                    } else {
                        scenario.genreLikeability[genre] = 3; // Default value if element somehow not found
                    }
                });

                // Collect scenography likeability settings
                scenographies.forEach(scenography => {
                    const inputElement = document.querySelector(`.scenography-likeability[data-scenography="${scenography}"]`);
                    if (inputElement) {
                        scenario.scenographyLikeability[scenography] = parseInt(inputElement.value);
                    } else {
                        scenario.scenographyLikeability[scenography] = 3;
                    }
                });
                return scenario;
            }

            // Function to apply loaded scenario data to the UI
            function applyScenarioData(scenario) {
                // 1. Gently reset current selections (without triggering full reset logic)
                document.querySelectorAll('.country-checkbox, .aq-checkbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => input.value = 100);
                document.querySelectorAll('.genre-select').forEach(select => select.selectedIndex = 0);
                document.querySelectorAll('.scenography-select').forEach(select => select.selectedIndex = 0);

                // 2. Apply custom contestants data if present in the scenario
                // This assumes 'createCountryTable' and 'addCSS' functions are globally available from your original script
                if (scenario.customContestants && scenario.customcountryCodeMap && scenario.customContestantsFlag && typeof createCountryTable === 'function') {
                    window.customContestants = [...scenario.customContestants];
                    window.customcountryCodeMap = { ...scenario.customcountryCodeMap };
                    window.customContestantsFlag = [...scenario.customContestantsFlag];

                    createCountryTable('customContestants', window.customContestants);

                    if (typeof addCSS === 'function') {
                        window.customContestants.forEach(name => {
                            const code = window.customcountryCodeMap[name];
                            // Find the flag URL for this custom country.
                            // This assumes customContestantsFlag stores URLs in the same order as customContestants names.
                            const countryIndex = window.customContestants.indexOf(name);
                            if (code && window.customContestantsFlag[countryIndex]) {
                                addCSS(`.flag-icon-${code}{ background-image: url("${window.customContestantsFlag[countryIndex]}"); }`);
                            }
                        });
                    }
                    // Re-attach listeners for newly created custom checkboxes. 'addCheckboxListeners' is from your script
                    if (typeof addCheckboxListeners === 'function') {
                        document.querySelectorAll('#customContestants .country-checkbox').forEach(addCheckboxListeners);
                    }
                }

                // 3. Apply selected countries' specific data
                scenario.selectedCountriesData.forEach(countryData => {
                    // Find the checkbox for the country. This query might need to be more specific if country names can appear in multiple tables.
                    const checkbox = document.querySelector(`.country-checkbox[value="${countryData.name}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        const td = checkbox.closest('td'); // Get parent <td>
                        if (td) {
                            const juryInput = td.querySelector('.jury-odds-input');
                            if (juryInput) juryInput.value = countryData.juryOdds;

                            const teleInput = td.querySelector('.tele-odds-input');
                            if (teleInput) teleInput.value = countryData.teleOdds;

                            const genreSel = td.querySelector('.genre-select');
                            if (genreSel) genreSel.value = countryData.genre;

                            const scenographySel = td.querySelector('.scenography-select');
                            if (scenographySel && countryData.scenography) scenographySel.value = countryData.scenography;

                            const songTitleInput = td.querySelector('.song-title-input');
                            if (songTitleInput && countryData.songTitle) songTitleInput.value = countryData.songTitle;

                            const artistNameInput = td.querySelector('.artist-name-input');
                            if (artistNameInput && countryData.artistName) artistNameInput.value = countryData.artistName;

                            const languageSelect = td.querySelector('.language-select');
                            if (languageSelect && countryData.language) languageSelect.value = countryData.language;

                            const aqCb = td.querySelector('.checkbox-container .aq-checkbox'); // Check within .checkbox-container
                            if (aqCb) aqCb.checked = countryData.isAQ;
                        }
                    } else {
                        console.warn('Could not find checkbox for country:', countryData.name, 'when applying scenario.');
                    }
                });

                // 4. Apply genre likeability
                // 'genreLikeability' (the object) and 'genres' (the array) are global in your script
                if (scenario.genreLikeability && typeof genreLikeability === 'object' && genreLikeability !== null) {
                    genres.forEach(genre => {
                        const inputElement = document.querySelector(`.genre-likeability[data-genre="${genre}"]`);
                        if (inputElement && scenario.genreLikeability[genre] !== undefined) {
                            inputElement.value = scenario.genreLikeability[genre];
                            genreLikeability[genre] = scenario.genreLikeability[genre]; // Update the JS variable as well
                        }
                    });
                }

                // Apply scenography likeability
                if (scenario.scenographyLikeability && typeof scenographyLikeability === 'object' && scenographyLikeability !== null) {
                    scenographies.forEach(scenography => {
                        const inputElement = document.querySelector(`.scenography-likeability[data-scenography="${scenography}"]`);
                        if (inputElement && scenario.scenographyLikeability[scenography] !== undefined) {
                            inputElement.value = scenario.scenographyLikeability[scenography];
                            scenographyLikeability[scenography] = scenario.scenographyLikeability[scenography];
                        }
                    });
                }

                // 5. Apply global settings
                const votingSystemEl = document.getElementById('votingSystem');
                if (votingSystemEl) votingSystemEl.value = scenario.votingSystem || 'current'; // Default to 'current' if not in scenario

                const revealTimeEl = document.getElementById('revealTime');
                if (revealTimeEl) revealTimeEl.value = scenario.revealTime || 10; // Default to 10

                const minOddsEl = document.getElementById('minOdds');
                if (minOddsEl) minOddsEl.value = scenario.minOdds || 1; // Default to 1

                const maxOddsEl = document.getElementById('maxOdds');
                if (maxOddsEl) maxOddsEl.value = scenario.maxOdds || 500; // Default to 500

                const maxOddsDiffEl = document.getElementById('maxOddsDifference');
                if (maxOddsDiffEl) maxOddsDiffEl.value = scenario.maxOddsDifference || 75; // Default to 75

                // 6. Crucial: Refresh UI states, especially AQ checkbox statuses
                // 'updateAQCheckboxStatus' is a global function in your script
                if (typeof updateAQCheckboxStatus === 'function') {
                    updateAQCheckboxStatus();
                } else {
                    console.error('updateAQCheckboxStatus function is not defined. AQ states might be incorrect.');
                }
            }

            // Event Listener for the "SAVE SCENARIO" button
            const saveScenarioButtonEl = document.getElementById('saveScenarioButton');
            if (saveScenarioButtonEl) {
                saveScenarioButtonEl.addEventListener('click', () => {
                    const scenarioData = collectScenarioData();
                    const scenarioJSON = JSON.stringify(scenarioData, null, 2);

                    // Suggest a default filename including the current date
                    const today = new Date();
                    const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const defaultFileName = `eurovision_scenario_${dateString}`;

                    // Ask the user for a filename, providing the default one
                    let userFileName = prompt("Enter a filename for your scenario (e.g., MyFavoriteESC)", defaultFileName);

                    // If the user clicks "Cancel" or leaves it empty, use the default name
                    if (userFileName === null || userFileName.trim() === "") {
                        userFileName = defaultFileName;
                    }

                    // Ensure the filename ends with .json
                    if (!userFileName.toLowerCase().endsWith('.json')) {
                        userFileName += '.json';
                    }

                    const a = document.createElement('a');
                    a.href = `data:text/json;charset=utf-8,${encodeURIComponent(scenarioJSON)}`;
                    a.download = userFileName; // Use the user-provided or default filename

                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    alert(`Scenario has been saved as ${userFileName}!`); // Inform the user about the actual filename
                });
            }

            // Event Listener for the "LOAD SCENARIO" button (which triggers the hidden file input)
            const loadScenarioButtonEl = document.getElementById('loadScenarioButton');
            if (loadScenarioButtonEl) {
                loadScenarioButtonEl.addEventListener('click', () => {
                    const loadScenarioInputEl = document.getElementById('loadScenarioInput');
                    if (loadScenarioInputEl) {
                        loadScenarioInputEl.click(); // Programmatically click the hidden file input
                    }
                });
            }

            // Event Listener for the hidden file input (when a file is selected)
            const loadScenarioInputEl = document.getElementById('loadScenarioInput');
            if (loadScenarioInputEl) {
                loadScenarioInputEl.addEventListener('change', (event) => {
                    const file = event.target.files[0]; // Get the selected file
                    if (!file) {
                        return; // No file selected
                    }

                    const reader = new FileReader(); // Create a FileReader to read the file content
                    reader.onload = (e) => { // This function is called when the file is successfully read
                        try {
                            const scenario = JSON.parse(e.target.result); // Parse the file content as JSON
                            // Basic validation: check if the loaded object has a 'version' property
                            if (!scenario || typeof scenario.version === 'undefined') {
                                alert('This does not look like a valid scenario file (missing version property or invalid JSON).');
                                return;
                            }
                            applyScenarioData(scenario); // Apply the loaded data to the UI
                            alert('Scenario has been loaded!');
                        } catch (error) {
                            console.error('Error loading or parsing scenario file:', error);
                            alert(`Could not load scenario. Error: ${error.message}`);
                        }
                        // Reset the file input's value. This allows loading the same file again if the user wishes to.
                        event.target.value = null;
                    };
                    reader.onerror = (e) => {
                        console.error('Error reading file:', e);
                        alert('Error reading the selected file.');
                    };
                    reader.readAsText(file); // Start reading the file as plain text
                });
            }

            generateButton.addEventListener('click', () => {
                // Hide the "Load Participants" button once the generation begins so the list
                // cannot be changed mid‚Äësimulation.
                const loadBtn = document.getElementById('loadParticipantsButton');
                if (loadBtn) {
                    loadBtn.style.display = 'none';
                }
                // Also hide the year selector and its label once the game starts to avoid mid‚Äësimulation changes
                const yearInput = document.getElementById('participantsYear');
                const yearLabel = document.querySelector("label[for='participantsYear']");
                if (yearInput) {
                    yearInput.style.display = 'none';
                }
                if (yearLabel) {
                    yearLabel.style.display = 'none';
                }
                const selectedCountries = Array.from(document.querySelectorAll('.country-checkbox:checked'))
                    .map(checkbox => {
                        const containerDiv = checkbox.closest('.checkbox-container');
                        const tdElement = containerDiv.closest('td');
                        const juryOddsInput = containerDiv.nextElementSibling.querySelector('.jury-odds-input');
                        const teleOddsInput = containerDiv.nextElementSibling.querySelector('.tele-odds-input');
                        const genreSelect = tdElement.querySelector('.genre-select');
                        const scenographySelect = tdElement.querySelector('.scenography-select');
                        const juryOdds = parseInt(juryOddsInput.value) || 100;
                        const teleOdds = parseInt(teleOddsInput.value) || 100;
                        const isAQ = containerDiv.querySelector('.aq-checkbox').checked;
                        const genre = genreSelect ? genreSelect.value : 'Pop';
                        const scenography = scenographySelect ? scenographySelect.value : 'Minimal';
                        const songTitle = tdElement.querySelector('.song-title-input')?.value || '';
                        const artistName = tdElement.querySelector('.artist-name-input')?.value || '';
                        const language = tdElement.querySelector('.language-select')?.value || '';
                        return { name: checkbox.value, juryOdds: juryOdds, teleOdds: teleOdds, isAQ: isAQ, genre: genre, scenography: scenography, songTitle: songTitle, artistName: artistName, language: language };
                    });

                if (selectedCountries.length < 10 || selectedCountries.length > 50) {
                    alert('Please select between 11 and 50 countries.');
                    return;
                }

                const autoQualifiers = selectedCountries.filter(country => country.isAQ);
                if (autoQualifiers.length > 10) {
                    alert('You can select a maximum of 10 auto-qualifiers.');
                    return;
                }


                const genreBonuses = calculateGenreBonus(selectedCountries);

                resultsDiv.innerHTML = '<div class="text-center my-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>Generating results...</p></div>';

                setTimeout(() => {
                    if (selectedCountries.length > 26) {
                        const contestResults = runContest(selectedCountries, genreBonuses);
                        semiFinal1Results = contestResults.semiFinal1;
                        semiFinal2Results = contestResults.semiFinal2;
                        finalResults = contestResults.finalResults;
                        displayFinalResults(finalResults);
                        semiFinal1Button.disabled = false;
                        semiFinal2Button.disabled = false;
                        semiFinal1Button.classList.add('btn-pink');
                        semiFinal2Button.classList.add('btn-pink');

                        document.querySelector('.settings-card').style.display = 'none';
                        resultsDiv.innerHTML = '<button id="showChartsButton" style="display: none;"> class="btn btn-info mt-3">Show Semi-Final Charts</button>';

                        document.getElementById('showChartsButton').addEventListener('click', function () {
                            chartContainer.style.display = 'block';
                            chartContainer.innerHTML = `
                    ${createSemiFinalTable(semiFinal1Results)}
                    ${createSemiFinalTable(semiFinal2Results)}
                    ${selectedVotingSystem === 'current' ? createVotingChart(semiFinal1Results, "Jury Voting - Semi-Final 1", false) : ''}
                    ${createVotingChart(semiFinal1Results, "Televoting - Semi-Final 1", true)}
                    ${selectedVotingSystem === 'current' ? createVotingChart(semiFinal2Results, "Jury Voting - Semi-Final 2", false) : ''}
                    ${createVotingChart(semiFinal2Results, "Televoting - Semi-Final 2", true)}
                `;
                            this.style.display = 'none';
                        });

                        simulateButton.disabled = false;
                        document.getElementById('simulateSemiDrawButton').disabled = false;
                    } else {
                        const contestResults = generateVotingResults(selectedCountries, null, genreBonuses);
                        finalResults = contestResults;
                        displayResults(contestResults.results, selectedCountries, contestResults.votingOrder);
                        semiFinal1Button.disabled = true;
                        semiFinal2Button.disabled = true;
                        semiFinal1Button.classList.remove('btn-pink');
                        semiFinal2Button.classList.remove('btn-pink');
                    }
                    finaleButton.disabled = false;
                    dynamicESCVotingButton.disabled = false;
                    dynamicVotingButton.disabled = false;
                }, 1000);
            });

            updateAQCheckboxStatus();

            semiFinal1Button.addEventListener('click', () => {
                displaySemiFinals(semiFinal1Results, "Semi-Final 1");
            });

            semiFinal2Button.addEventListener('click', () => {
                displaySemiFinals(semiFinal2Results, "Semi-Final 2");
            });

            finaleButton.addEventListener('click', () => {
                if (finalResults.results) {
                    displayFinalResults(finalResults);
                } else {
                    displayResults(finalResults.results, Object.keys(finalResults.results).map(name => ({ name, odds: finalResults.results[name].odds, genre: finalResults.results[name].genre })), finalResults.votingOrder);
                }
            });

            simulateButton.addEventListener('click', () => {
                simulateButton.disabled = true;
                hideSettingsShowSimulation();
                populateSemiFinalTable(currentSemiFinal === 1 ? semiFinal1Results.results : semiFinal2Results.results);

                const semiFinalTable = document.getElementById('semiFinalTable').getElementsByTagName('tbody')[0];
                const qualifiedTable = document.getElementById('qualifiedTable').getElementsByTagName('tbody')[0];
                const timerDisplay = document.getElementById('timerDisplay');
                const revealTime = parseInt(document.getElementById('revealTime').value);

                const allCountries = Array.from(semiFinalTable.rows).map(row => ({
                    element: row,
                    country: row.cells[0].textContent.trim(),
                    genre: row.cells[1].textContent.trim(),
                    points: currentSemiFinal === 1
                        ? semiFinal1Results.results[row.cells[0].textContent.trim()].juryTotal +
                        semiFinal1Results.results[row.cells[0].textContent.trim()].teleTotal
                        : semiFinal2Results.results[row.cells[0].textContent.trim()].juryTotal +
                        semiFinal2Results.results[row.cells[0].textContent.trim()].teleTotal
                }));

                const topTen = allCountries
                    .sort((a, b) => b.points - a.points)
                    .slice(0, 10);

                for (let i = topTen.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [topTen[i], topTen[j]] = [topTen[j], topTen[i]];
                }

                function updateTimer(secondsLeft) {
                    timerDisplay.textContent = `Next country in: ${secondsLeft} seconds`;
                }

                function revealCountry(index) {
                    if (index < topTen.length) {
                        let secondsLeft = revealTime;
                        const countdownInterval = setInterval(() => {
                            if (secondsLeft > 0) {
                                updateTimer(secondsLeft);
                                secondsLeft--;
                            } else {
                                clearInterval(countdownInterval);
                                const countryData = topTen[index];
                                const newRow = qualifiedTable.insertRow();
                                newRow.innerHTML = countryData.element.innerHTML;
                                newRow.classList.add('table-success');

                                semiFinalTable.deleteRow(Array.from(semiFinalTable.rows).indexOf(countryData.element));

                                revealCountry(index + 1);
                            }
                        }, 1000);
                    } else {
                        timerDisplay.textContent = 'All countries revealed!';
                        if (currentSemiFinal === 1) {
                            document.getElementById('nextSemiFinalButton').style.display = 'block';
                        } else {
                            document.getElementById('finaleButton').disabled = false;
                            document.getElementById('dynamicVotingButton').disabled = false;

                        }
                        simulateButton.disabled = false;
                    }
                }

                revealCountry(0);
            });

            document.addEventListener('click', function (e) {
                if (e.target && e.target.id === 'nextSemiFinalButton') {
                    currentSemiFinal = 2;
                    hideSettingsShowSimulation();
                    populateSemiFinalTable(semiFinal2Results.results);
                    simulateButton.disabled = false;
                    e.target.style.display = 'none';

                    const existingSimulationArea = document.getElementById('simulationArea');
                    if (existingSimulationArea) {
                        existingSimulationArea.remove();
                    }
                }

                if (e.target && e.target.id === 'showChartsButton') {
                    const chartsDiv = document.querySelector('.semi-final-charts');
                    chartsDiv.style.display = 'block';
                    chartsDiv.innerHTML = `
            ${createVotingChart(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results, `Jury Voting - Semi-Final ${currentSemiFinal}`, false)}
            ${createVotingChart(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results, `Televoting - Semi-Final ${currentSemiFinal}`, true)}
            ${createSemiFinalTable(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results)}
        `;
                    e.target.style.display = 'none';
                }
            });


            function getRandomOdds(min, max, baseOdds, maxDifference) {
                const lowerBound = Math.max(min, baseOdds - maxDifference);
                const upperBound = Math.min(max, baseOdds + maxDifference);
                return Math.floor(Math.random() * (upperBound - lowerBound + 1)) + lowerBound;
            }

            function calculateWeight(odds) {
                const base = Math.min(odds, 500);
                const weight = Math.max(1, Math.round(100000 / (Math.pow(base, 1.5) + 100)));
                return weight;
            }

            // ===== REALISTIC VOTING SYSTEM =====

            // Geographical voting blocks (countries that tend to vote for each other)
            const geographicalBlocks = {
                'Nordic': ['Denmark', 'Finland', 'Iceland', 'Norway', 'Sweden'],
                'Baltic': ['Estonia', 'Latvia', 'Lithuania'],
                'Balkans': ['Albania', 'Bosnia and Herzegovina', 'Bulgaria', 'Croatia', 'Greece', 'Montenegro', 'North Macedonia', 'Serbia', 'Slovenia'],
                'PostSoviet': ['Armenia', 'Azerbaijan', 'Belarus', 'Georgia', 'Kazakhstan', 'Moldova', 'Russia', 'Ukraine'],
                'Western': ['Austria', 'Belgium', 'France', 'Germany', 'Luxembourg', 'Netherlands', 'Switzerland'],
                'Mediterranean': ['Cyprus', 'Greece', 'Israel', 'Italy', 'Malta', 'Portugal', 'San Marino', 'Spain'],
                'British': ['Ireland', 'United Kingdom'],
                'EasternEU': ['Czechia', 'Hungary', 'Poland', 'Romania', 'Slovakia']
            };

            // Cultural/linguistic groups
            const culturalGroups = {
                'Slavic': ['Belarus', 'Bosnia and Herzegovina', 'Bulgaria', 'Croatia', 'Czechia', 'North Macedonia', 'Poland', 'Russia', 'Serbia', 'Slovakia', 'Slovenia', 'Ukraine'],
                'Romance': ['Andorra', 'France', 'Italy', 'Monaco', 'Portugal', 'Romania', 'San Marino', 'Spain'],
                'Germanic': ['Austria', 'Belgium', 'Germany', 'Liechtenstein', 'Luxembourg', 'Netherlands', 'Switzerland'],
                'Turkic': ['Azerbaijan', 'Kazakhstan', 'Turkey'],
                'Greek': ['Cyprus', 'Greece']
            };

            function getGeographicalBonus(voter, receiver) {
                // Check if countries are in the same geographical block
                for (const [block, countries] of Object.entries(geographicalBlocks)) {
                    if (countries.includes(voter) && countries.includes(receiver)) {
                        return 1.4; // 40% boost for geographical neighbors
                    }
                }
                return 1.0;
            }

            function getCulturalBonus(voter, receiver) {
                // Check if countries share cultural/linguistic ties
                for (const [group, countries] of Object.entries(culturalGroups)) {
                    if (countries.includes(voter) && countries.includes(receiver)) {
                        return 1.25; // 25% boost for cultural ties
                    }
                }
                return 1.0;
            }

            function getLanguageBonus(voterCountry, receiverLanguage, isJury) {
                // English songs tend to do well everywhere
                if (receiverLanguage === 'English') {
                    return isJury ? 1.15 : 1.25; // Jury +15%, Televote +25%
                }

                // Native language songs have slight disadvantage globally but may appeal to diaspora
                if (receiverLanguage === 'Native') {
                    return isJury ? 0.95 : 1.05; // Jury -5%, Televote +5% (emotional connection)
                }

                // Other major languages
                if (['French', 'Italian', 'Spanish'].includes(receiverLanguage)) {
                    return isJury ? 1.05 : 1.10;
                }

                return 1.0;
            }

            function getQualitySpreadBonus(receiverOdds, isJury) {
                // Very strong entries (low odds) get extra boost from multiple countries
                // Simulates the "runaway winner" effect
                if (receiverOdds < 50) {
                    return isJury ? 1.3 : 1.2; // Jury recognizes quality more
                } else if (receiverOdds < 100) {
                    return isJury ? 1.15 : 1.1;
                }
                return 1.0;
            }

            function calculateRealisticWeight(voter, receiver, oddsType, isJury) {
                const receiverData = results[receiver.name];
                const baseOdds = receiverData ? receiverData[oddsType] : receiver[oddsType];

                // Start with base weight calculation
                let weight = calculateWeight(baseOdds);

                // Apply geographical bonus (stronger for televoting)
                const geoBonus = getGeographicalBonus(voter, receiver.name);
                const geoEffect = isJury ? Math.pow(geoBonus, 0.6) : geoBonus; // Jury less influenced by geography

                // Apply cultural bonus
                const culturalBonus = getCulturalBonus(voter, receiver.name);
                const culturalEffect = isJury ? Math.pow(culturalBonus, 0.7) : culturalBonus;

                // Apply language bonus - safe fallback if receiverData is undefined
                const receiverLanguage = receiverData ? receiverData.language : (receiver.language || '');
                const langBonus = getLanguageBonus(voter, receiverLanguage, isJury);

                // Apply quality spread bonus
                const qualityBonus = getQualitySpreadBonus(baseOdds, isJury);

                // Add randomness (more for televoting, less for jury)
                const randomFactor = isJury
                    ? 0.85 + Math.random() * 0.3  // Jury: 0.85-1.15 (more consistent)
                    : 0.7 + Math.random() * 0.6;  // Televote: 0.7-1.3 (more unpredictable)

                // Calculate total multiplier BEFORE applying
                let totalMultiplier = geoEffect * culturalEffect * langBonus * qualityBonus * randomFactor;

                // CAP TOTAL BONUS at 2.5x to prevent extreme stacking
                totalMultiplier = Math.min(totalMultiplier, 2.5);

                // Also ensure minimum isn't too low
                totalMultiplier = Math.max(totalMultiplier, 0.4);

                weight *= totalMultiplier;

                // Jury is more spread out in their votes, televoting more concentrated on favorites
                if (!isJury && baseOdds > 150) {
                    weight *= 0.8; // Televoting gives even less chance to outsiders
                }

                return Math.max(1, Math.round(weight));
            }

            function createWeightedCountries(availableCountries, oddsType, voter = null, isJury = false) {
                const weights = availableCountries.map(country => {
                    const odds = results[country.name] ? results[country.name][oddsType] : country[oddsType];

                    // Use realistic weight calculation if voter is provided
                    const weight = voter
                        ? calculateRealisticWeight(voter, country, oddsType, isJury)
                        : calculateWeight(odds);

                    return { country: country.name, weight: weight };
                });

                const totalWeight = weights.reduce((sum, item) => sum + item.weight, 0);
                const scaleFactor = 10000 / totalWeight;

                return weights.map(item => ({
                    country: item.country,
                    weight: Math.max(1, Math.round(item.weight * scaleFactor))
                }));
            }

            function selectVotingCountries(weightedCountries) {
                const selectedCountries = [];
                const points = [12, 10, 8, 7, 6, 5, 4, 3, 2, 1];

                // NOTE: Vote distribution variance happens naturally:
                // - Strong entries (low odds, high weight) get selected by MANY voters
                // - Weak entries (high odds, low weight) get selected by FEW voters
                // - Each voter's weights are different (geographical/cultural bias)
                // Result: Some countries get points from 30+ countries, others from 3-5

                for (let i = 0; i < points.length; i++) {
                    let totalWeight = weightedCountries.reduce((sum, country) => sum + country.weight, 0);
                    let randomWeight = Math.random() * totalWeight;
                    let selectedCountry;

                    for (const country of weightedCountries) {
                        randomWeight -= country.weight;
                        if (randomWeight <= 0) {
                            selectedCountry = country.country;
                            break;
                        }
                    }

                    if (selectedCountry) {
                        selectedCountries.push(selectedCountry);
                        weightedCountries = weightedCountries.filter(c => c.country !== selectedCountry);
                    } else {
                        const remainingCountry = weightedCountries[Math.floor(Math.random() * weightedCountries.length)].country;
                        selectedCountries.push(remainingCountry);
                        weightedCountries = weightedCountries.filter(c => c.country !== remainingCountry);
                    }
                }

                return selectedCountries;
            }

            function generateVotingResults(countries, votingCountries = null, genreBonuses) {
                const results = {};
                const allCountries = votingCountries || countries;

                allCountries.forEach(country => {
                    const genreBonus = genreBonuses[country.genre] || 1;
                    const genreLikeabilityFactor = (1 + (genreLikeability[country.genre] || 3)) / 4;

                    // Safe scenography likeability with fallback
                    const scenographyValue = country.scenography && scenographyLikeability[country.scenography] !== undefined
                        ? scenographyLikeability[country.scenography]
                        : 3;
                    const scenographyLikeabilityFactor = (1 + scenographyValue) / 4;

                    // DAMPEN MULTIPLIER STACKING - prevent extreme ranges (24-232)
                    // Instead of direct multiplication, reduce the effect of each factor
                    const genreEffect = (genreBonus - 1) * 0.4 + 1;  // 0.97-1.03 -> ~0.988-1.012
                    const likeEffect = (genreLikeabilityFactor - 1) * 0.6 + 1;  // 0.5-1.5 -> 0.7-1.3
                    const scenoEffect = (scenographyLikeabilityFactor - 1) * 0.4 + 1;  // 0.5-1.5 -> 0.8-1.2

                    // Now multiply: worst case ~0.55x, best case ~1.57x (much more reasonable!)
                    const adjustedJuryOdds = Math.round(country.juryOdds * genreEffect * likeEffect * scenoEffect);
                    const adjustedTeleOdds = Math.round(country.teleOdds * genreEffect * likeEffect * scenoEffect);

                    results[country.name] = {
                        juryTotal: 0,
                        teleTotal: 0,
                        juryVotesGiven: {},
                        teleVotesGiven: {},
                        juryOdds: adjustedJuryOdds,
                        teleOdds: adjustedTeleOdds,
                        juryPlacement: 0,
                        telePlacement: 0,
                        isAQ: country.isAQ,
                        isCompeting: countries.some(c => c.name === country.name),
                        genre: country.genre,
                        scenography: country.scenography || "Minimal",
                        songTitle: country.songTitle || "",
                        artistName: country.artistName || "",
                        language: country.language || ""
                    };
                });

                const points = [12, 10, 8, 7, 6, 5, 4, 3, 2, 1];
                const votingOrder = (votingCountries || countries).map(c => c.name).sort(() => 0.5 - Math.random());

                votingOrder.forEach(voter => {
                    const availableCountries = countries.filter(c => c.name !== voter);

                    // Televoting with realistic weights (geographical, cultural, emotional)
                    const teleWeightedCountries = createWeightedCountries(availableCountries, 'teleOdds', voter, false);
                    const teleVotedCountries = selectVotingCountries(teleWeightedCountries);

                    if (results[voter]) {
                        // Always calculate televoting
                        teleVotedCountries.forEach((country, index) => {
                            results[voter].teleVotesGiven[country] = points[index];
                            results[country].teleTotal += points[index];
                        });

                        // Only calculate jury voting if it's the final or if using the current system in semi-finals
                        if (selectedVotingSystem === 'current' || votingCountries) {
                            // Jury voting with realistic weights (more professional, less biased but still some bias)
                            const juryWeightedCountries = createWeightedCountries(availableCountries, 'juryOdds', voter, true);
                            const juryVotedCountries = selectVotingCountries(juryWeightedCountries);
                            juryVotedCountries.forEach((country, index) => {
                                results[voter].juryVotesGiven[country] = points[index];
                                results[country].juryTotal += points[index];
                            });
                        }
                    }
                });

                const sortedTele = Object.keys(results)
                    .filter(country => results[country].isCompeting)
                    .sort((a, b) => results[b].teleTotal - results[a].teleTotal);

                if (selectedVotingSystem === 'current' || votingCountries) {
                    sortedTele.forEach((country, index) => {
                        results[country].telePlacement = results[country].teleTotal > 0 ? index + 1 : `<p style="color:red;">${sortedTele.length} (0p)</p>`;
                    });

                    const sortedJury = Object.keys(results)
                        .filter(country => results[country].isCompeting)
                        .sort((a, b) => results[b].juryTotal - results[a].juryTotal);

                    sortedJury.forEach((country, index) => {
                        results[country].juryPlacement = results[country].juryTotal > 0 ? index + 1 : `<p style="color:red;">${sortedJury.length} (0p)</p>`;
                    });
                }

                return { results, votingOrder };
            }


            function runContest(countries, genreBonuses) {
                if (countries.length <= 26) {
                    return generateVotingResults(countries, null, genreBonuses);
                } else {
                    const autoQualifiers = countries.filter(c => c.isAQ).slice(0, 10);
                    const remainingCountries = countries.filter(c => !c.isAQ);

                    const shuffledCountries = [...remainingCountries].sort(() => 0.5 - Math.random());
                    const semiFinal1Countries = shuffledCountries.slice(0, Math.ceil(shuffledCountries.length / 2));
                    const semiFinal2Countries = shuffledCountries.slice(Math.ceil(shuffledCountries.length / 2));

                    const semiFinal1 = generateVotingResults(semiFinal1Countries, null, genreBonuses);
                    const semiFinal2 = generateVotingResults(semiFinal2Countries, null, genreBonuses);

                    const qualifiersPerSemi = 10;
                    const semiFinal1Qualifiers = getQualifiers(semiFinal1.results, qualifiersPerSemi);
                    const semiFinal2Qualifiers = getQualifiers(semiFinal2.results, qualifiersPerSemi);

                    const finalCountries = [...autoQualifiers, ...semiFinal1Qualifiers, ...semiFinal2Qualifiers];
                    const allVotingCountries = [...countries];
                    const finalResults = generateVotingResults(finalCountries, allVotingCountries, genreBonuses);

                    return { semiFinal1, semiFinal2, finalResults };
                }
            }

            function updateAQCheckboxStatus() {
                // Select all country checkboxes across all continents and categories
                const totalSelectedCountries =
                    document.querySelectorAll('#currentContestants .country-checkbox:checked').length +
                    document.querySelectorAll('#oldContestants .country-checkbox:checked').length +
                    document.querySelectorAll('#customContestants .country-checkbox:checked').length +
                    document.querySelectorAll('#restEuropeContestants .country-checkbox:checked').length +
                    document.querySelectorAll('#northAmericaContestants .country-checkbox:checked').length +
                    document.querySelectorAll('#southAmericaContestants .country-checkbox:checked').length +
                    document.querySelectorAll('#africaContestants .country-checkbox:checked').length +
                    document.querySelectorAll('#asiaContestants .country-checkbox:checked').length +
                    document.querySelectorAll('#oceaniaContestants .country-checkbox:checked').length;

                // Check if 27 or more countries have been selected
                const shouldEnableAQ = totalSelectedCountries >= 27;

                // Enable or disable the AQ checkboxes based on the total count
                document.querySelectorAll('.country-checkbox').forEach(checkbox => {
                    const aqCheckbox = checkbox.nextElementSibling.nextElementSibling;
                    if (checkbox.checked && shouldEnableAQ) {
                        aqCheckbox.disabled = false;
                    } else {
                        aqCheckbox.disabled = true;
                        aqCheckbox.checked = false;
                    }
                });

                // Update the <h3> element with the selected count
                const selectedCountElement = document.getElementById('selectedCount');
                selectedCountElement.textContent = `Total Selected Countries: ${totalSelectedCountries}/50`;

                // Change color based on the number of selected countries
                if (totalSelectedCountries < 11 || totalSelectedCountries > 50) {
                    selectedCountElement.style.color = 'red';
                } else {
                    selectedCountElement.style.color = 'black';
                }

                console.log(`Total selected countries: ${totalSelectedCountries}, AQ enabled: ${shouldEnableAQ}`);
            }


            function addCheckboxListeners(checkbox) {
                checkbox.addEventListener('change', () => {
                    console.log(`Checkbox for ${checkbox.value} changed. Checked: ${checkbox.checked}`);
                    updateAQCheckboxStatus();
                });
            }

            document.querySelectorAll('.country-checkbox').forEach(addCheckboxListeners);



            function displayResults(results, countries, votingOrder) {
                let html = `
        ${createVotingChart({ results, votingOrder }, "Jury Voting - Final", false)}
        ${createVotingChart({ results, votingOrder }, "Televoting - Final", true)}
        <h2 class="results-headline">Final Results</h2>
        <table class="table table-striped eurovision-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Country</th>
                    <th>Song Title</th>
                    <th>Artist</th>
                    <th>Language</th>
                    <th>Genre</th>
                    <th>Scenography</th>
                    <th>Jury Points</th>
                    <th>Tele Points</th>
                    <th>Total Points</th>
                    <th>Jury Placement</th>
                    <th>Tele Placement</th>
                </tr>
            </thead>
            <tbody>
    `;

                const sortedCountries = countries.sort((a, b) => {
                    const totalA = results[a.name].juryTotal + results[a.name].teleTotal;
                    const totalB = results[b.name].juryTotal + results[b.name].teleTotal;
                    if (totalA !== totalB) return totalB - totalA;
                    if (results[a.name].teleTotal !== results[b.name].teleTotal) return results[b.name].teleTotal - results[a.name].teleTotal;
                    return tiebreaker(results[b.name], results[a.name]);
                });

                sortedCountries.forEach((country, index) => {
                    html += `<tr>
                <td>${index + 1}</td>
                <td style="text-align: right;">
                    ${country.name}
                    <span class="flag-icon flag-icon-${getCountryCode(country.name)} ml-2"></span>
                </td>
                <td style="font-style: italic;">${results[country.name].songTitle || '-'}</td>
                <td>${results[country.name].artistName || '-'}</td>
                <td>${results[country.name].language || '-'}</td>
                <td>${results[country.name].genre}</td>
                <td>${results[country.name].scenography || 'Minimal'}</td>
                <td class="points">${results[country.name].juryTotal}</td>
                <td class="points">${results[country.name].teleTotal}</td>
                <td class="points">${results[country.name].juryTotal + results[country.name].teleTotal}</td>
                <td class="placement">${results[country.name].juryPlacement}</td>
                <td class="placement">${results[country.name].telePlacement}</td>
            </tr>
        `;
                });

                html += `
            </tbody>
        </table>
    `;

                resultsDiv.innerHTML = html;
            }

            function getQualifiers(results, count) {
                const sortedCountries = Object.entries(results)
                    .sort((a, b) => {
                        if (selectedVotingSystem === 'current') {
                            const totalA = a[1].juryTotal + a[1].teleTotal;
                            const totalB = b[1].juryTotal + b[1].teleTotal;
                            if (totalA !== totalB) return totalB - totalA;
                        }
                        return b[1].teleTotal - a[1].teleTotal;
                    });

                return sortedCountries.slice(0, count).map(([name, data]) => ({
                    name,
                    juryOdds: data.juryOdds,
                    teleOdds: data.teleOdds,
                    genre: data.genre,
                    scenography: data.scenography || "Minimal",
                    songTitle: data.songTitle || "",
                    artistName: data.artistName || "",
                    language: data.language || ""
                }));
            }


            function displaySemiFinals(semiFinal, title) {
                chartContainer.style.display = 'block';
                chartContainer.innerHTML = `
        <h3 class="results-headline">${title} Results</h3>
        ${createSemiFinalTable(semiFinal)}
        ${selectedVotingSystem === 'current' ? createVotingChart(semiFinal, `Jury Voting - ${title}`, false) : ''}
        ${createVotingChart(semiFinal, `Televoting - ${title}`, true)}
    `;
            }

            function createSemiFinalTable(semiFinal) {
                const sortedCountries = Object.keys(semiFinal.results)
                    .sort((a, b) => {
                        if (selectedVotingSystem === 'current') {
                            const totalA = semiFinal.results[a].juryTotal + semiFinal.results[a].teleTotal;
                            const totalB = semiFinal.results[b].juryTotal + semiFinal.results[b].teleTotal;
                            if (totalA !== totalB) return totalB - totalA;
                        }
                        return semiFinal.results[b].teleTotal - semiFinal.results[a].teleTotal;
                    });

                let html = `
        <table class="table table-striped eurovision-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Country</th>
                    <th>Song Title</th>
                    <th>Artist</th>
                    <th>Language</th>
                    <th>Genre</th>
                    <th>Scenography</th>
                    ${selectedVotingSystem === 'current' ? '<th>Jury Points</th>' : ''}
                    <th>Tele Points</th>
                    ${selectedVotingSystem === 'current' ? '<th>Total Points</th>' : ''}
                    ${selectedVotingSystem === 'current' ? '<th>Jury Placement</th>' : ''}
                    ${selectedVotingSystem === 'current' ? '<th>Tele Placement</th>' : ''}
                </tr>
            </thead>
            <tbody>
    `;

                sortedCountries.forEach((country, index) => {
                    const result = semiFinal.results[country];
                    const isQualified = index < 10;
                    html += `
            <tr class="${isQualified ? '' : 'non-qualifier'}">
                <td>${index + 1}</td>
                <td style="text-align: right;">
                    ${country}
                    <span class="flag-icon flag-icon-${getCountryCode(country)} ml-2"></span>
                </td>
                <td style="font-style: italic;">${result.songTitle || '-'}</td>
                <td>${result.artistName || '-'}</td>
                <td>${result.language || '-'}</td>
                <td>${result.genre}</td>
                <td>${result.scenography || 'Minimal'}</td>
                ${selectedVotingSystem === 'current' ? `<td class="points">${result.juryTotal}</td>` : ''}
                <td class="points">${result.teleTotal}</td>
                ${selectedVotingSystem === 'current' ? `<td class="points">${result.juryTotal + result.teleTotal}</td>` : ''}
                ${selectedVotingSystem === 'current' ? `<td class="semi-placement">${result.juryPlacement}</td>` : ''}
                ${selectedVotingSystem === 'current' ? `<td class="semi-placement">${result.telePlacement}</td>` : ''}
            </tr>
        `;
                });

                html += `
            </tbody>
        </table>
    `;

                return html;
            }

            function createVotingChart(results, title, isTele = false) {
                if (!isTele && selectedVotingSystem === 'noJurySemi' && !title.includes('Final')) {
                    return ''; // Don't create jury voting chart for semi-finals in no-jury system
                }

                const { results: voteResults, votingOrder } = results;
                const sortedCountries = Object.keys(voteResults)
                    .filter(country => voteResults[country].isCompeting)
                    .sort((a, b) => {
                        const totalA = isTele ? voteResults[a].teleTotal : voteResults[a].juryTotal;
                        const totalB = isTele ? voteResults[b].teleTotal : voteResults[b].juryTotal;
                        return totalB - totalA;
                    });

                let html = `
        <h3 class="results-headline">${title}</h3>
        <div class="table-responsive">
            <table class="table table-striped eurovision-table">
                <thead>
                    <tr>
                        <th>Receiving Country</th>
                        <th>Song Title</th>
                        <th>Artist</th>
                        <th>Language</th>
                        <th>Genre</th>
                        ${votingOrder.map(country => `
                            <th class="rotate-header">
                                <div class="country-name">${country}</div>
                                <div class="flag-container">
                                    <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                                </div>
                            </th>
                        `).join('')}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
    `;

                sortedCountries.forEach((receiver, index) => {
                    html += `
            <tr>
                <td class="receiving-country">
                    ${receiver}
                    <span class="flag-icon flag-icon-${getCountryCode(receiver)}"></span>
                </td>
                <td style="font-style: italic;">${voteResults[receiver].songTitle || '-'}</td>
                <td>${voteResults[receiver].artistName || '-'}</td>
                <td>${voteResults[receiver].language || '-'}</td>
                <td>${voteResults[receiver].genre}</td>
                ${votingOrder.map(voter => {
                        if (!voteResults[voter]) {
                            return '<td></td>';
                        }
                        const points = voter !== receiver ? (isTele ? voteResults[voter].teleVotesGiven[receiver] : voteResults[voter].juryVotesGiven[receiver]) || '' : '';
                        let cellClass = voter === receiver ? 'self-vote' : `points-${points}`;
                        return `<td class="${cellClass}">${points}</td>`;
                    }).join('')}
                <td class="total-column">${isTele ? voteResults[receiver].teleTotal : voteResults[receiver].juryTotal}</td>
            </tr>
        `;
                });

                html += `
                </tbody>
            </table>
        </div>
    `;

                return html;
            }

            function simulateSemiFinalesDrawn() {
                // Hide the "Load Participants" button when starting the draw so users
                // cannot modify the participants list mid‚Äësimulation.
                const loadBtn = document.getElementById('loadParticipantsButton');
                if (loadBtn) {
                    loadBtn.style.display = 'none';
                }
                // Also hide the year selector and its label once the game starts
                const yearInput = document.getElementById('participantsYear');
                const yearLabel = document.querySelector("label[for='participantsYear']");
                if (yearInput) {
                    yearInput.style.display = 'none';
                }
                if (yearLabel) {
                    yearLabel.style.display = 'none';
                }
                if (!semiFinal1Results || !semiFinal2Results) {
                    alert("Please generate contest results first.");
                    return;
                }

                const allCountries = [...Object.keys(semiFinal1Results.results), ...Object.keys(semiFinal2Results.results)].sort();

                const drawSimulationDiv = document.createElement('div');
                drawSimulationDiv.className = 'col-md-10 draw-simulation';
                drawSimulationDiv.innerHTML = `
        <div class="card settings-card">
            <div class="card-body">
                <h2>Semi-Final Draw Simulation</h2>
                <button id="revealDrawButton" class="btn btn-primary mt-3 mb-3">Reveal Draw Results</button>
                <div class="row">
                    <div class="col-md-4">
                        <h3>1st Semi-Final</h3>
                        <table class="table table-striped">
                            <tbody id="semi1DrawnTable"></tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h3>Countries</h3>
                        <table class="table table-striped">
                            <tbody id="allCountriesTable">
                                ${allCountries.map(country => `
                                    <tr>
                                        <td>
                                            ${country}
                                            <span class="flag-icon flag-icon-${getCountryCode(country)} ml-2"></span>
                                            <span class="genre-info">(${semiFinal1Results.results[country]?.genre || semiFinal2Results.results[country]?.genre})</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h3>2nd Semi-Final</h3>
                        <table class="table table-striped">
                            <tbody id="semi2DrawnTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;

                const mainRow = document.querySelector('.eurovision-simulator > .row');

                const existingDrawSimulation = mainRow.querySelector('.draw-simulation');
                if (existingDrawSimulation) {
                    existingDrawSimulation.remove();
                }

                mainRow.appendChild(drawSimulationDiv);

                document.getElementById('revealDrawButton').addEventListener('click', () => {
                    document.getElementById('revealDrawButton').style.display = 'none';
                    const semi1Table = document.getElementById('semi1DrawnTable');
                    const semi2Table = document.getElementById('semi2DrawnTable');
                    const allCountriesTable = document.getElementById('allCountriesTable');

                    const semi1Countries = Object.keys(semiFinal1Results.results);
                    const semi2Countries = Object.keys(semiFinal2Results.results);

                    let index = 0;

                    function revealNextCountry() {
                        if (index < allCountries.length) {
                            const country = allCountries[index];
                            const row = allCountriesTable.rows[index];
                            row.style.opacity = '0.5';

                            const newRow = document.createElement('tr');
                            newRow.innerHTML = row.innerHTML;
                            newRow.style.animation = 'fadeIn 1s';

                            if (semi1Countries.includes(country)) {
                                semi1Table.appendChild(newRow);
                            } else if (semi2Countries.includes(country)) {
                                semi2Table.appendChild(newRow);
                            }

                            index++;
                            setTimeout(revealNextCountry, 2000);
                        } else {
                            document.getElementById('revealDrawButton').style.display = 'none';
                        }
                    }

                    revealNextCountry();
                });
            }

            document.getElementById('simulateSemiDrawButton').addEventListener('click', simulateSemiFinalesDrawn);

            function displayFinalResults(finalResults) {
                const { results, votingOrder } = finalResults;
                const sortedCountries = Object.keys(results)
                    .filter(country => results[country].isCompeting)
                    .sort((a, b) => {
                        const totalA = results[a].juryTotal + results[a].teleTotal;
                        const totalB = results[b].juryTotal + results[b].teleTotal;
                        if (totalA !== totalB) return totalB - totalA;
                        if (results[a].teleTotal !== results[b].teleTotal) return results[b].teleTotal - results[a].teleTotal;
                        return tiebreaker(results[b], results[a]);
                    });

                let html = `
        ${createVotingChart(finalResults, "Jury Voting - Final", false)}
        ${createVotingChart(finalResults, "Televoting - Final", true)}
        <h2 class="results-headline">Final Results</h2>
        <table class="table table-striped eurovision-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Country</th>
                    <th>Song Title</th>
                    <th>Artist</th>
                    <th>Language</th>
                    <th>Genre</th>
                    <th>Scenography</th>
                    <th>Jury Points</th>
                    <th>Tele Points</th>
                    <th>Total Points</th>
                    <th>Jury Placement</th>
                    <th>Tele Placement</th>
                </tr>
            </thead>
            <tbody>
    `;

                sortedCountries.forEach((country, index) => {
                    html += `<tr class="${results[country].isAQ ? 'auto-qualifier' : ''}">
                <td>${index + 1}</td>
                <td style="text-align: right;">
                    ${country}
                    <span class="flag-icon flag-icon-${getCountryCode(country)} ml-2"></span>
                </td>
                <td style="font-style: italic;">${results[country].songTitle || '-'}</td>
                <td>${results[country].artistName || '-'}</td>
                <td>${results[country].language || '-'}</td>
                <td>${results[country].genre}</td>
                <td>${results[country].scenography || 'Minimal'}</td>
                <td class="points">${results[country].juryTotal}</td>
                <td class="points">${results[country].teleTotal}</td>
                <td class="points">${results[country].juryTotal + results[country].teleTotal}</td>

                <td class="placement">${results[country].juryPlacement}</td>
                <td class="placement">${results[country].telePlacement}</td>
            </tr>
        `;
                });


                html += `
        </tbody>
    </table>
`;

                html += createSummaryTable(sortedCountries, results);

                resultsDiv.innerHTML = html;

            }

            function tiebreaker(a, b, previousOrder) {
                // Compare total points
                const totalA = a.juryTotal + a.teleTotal;
                const totalB = b.juryTotal + b.teleTotal;
                if (totalA !== totalB) {
                    return totalB - totalA;
                }

                // If total points are tied, compare televoting scores
                if (a.teleTotal !== b.teleTotal) {
                    return b.teleTotal - a.teleTotal;
                }

                // If televoting scores are tied, compare jury scores
                if (a.juryTotal !== b.juryTotal) {
                    return b.juryTotal - a.juryTotal;
                }

                // If jury scores are also tied, compare the number of countries that awarded points
                const aCountriesVoted = Object.values(a.teleVotesGiven).filter(v => v > 0).length;
                const bCountriesVoted = Object.values(b.teleVotesGiven).filter(v => v > 0).length;
                if (aCountriesVoted !== bCountriesVoted) {
                    return bCountriesVoted - aCountriesVoted;
                }

                // If still tied, compare the number of 12 points received in televoting
                const aTele12 = Object.values(a.teleVotesGiven).filter(v => v === 12).length;
                const bTele12 = Object.values(b.teleVotesGiven).filter(v => v === 12).length;
                if (aTele12 !== bTele12) {
                    return bTele12 - aTele12;
                }

                // Continue with 10 points, 8 points, etc. in televoting if needed
                const telePoints = [10, 8, 7, 6, 5, 4, 3, 2, 1];
                for (let point of telePoints) {
                    const aCount = Object.values(a.teleVotesGiven).filter(v => v === point).length;
                    const bCount = Object.values(b.teleVotesGiven).filter(v => v === point).length;
                    if (aCount !== bCount) return bCount - aCount;
                }

                // If still tied, repeat the process for jury votes
                const aJury12 = Object.values(a.juryVotesGiven).filter(v => v === 12).length;
                const bJury12 = Object.values(b.juryVotesGiven).filter(v => v === 12).length;
                if (aJury12 !== bJury12) {
                    return bJury12 - aJury12;
                }

                const juryPoints = [10, 8, 7, 6, 5, 4, 3, 2, 1];
                for (let point of juryPoints) {
                    const aCount = Object.values(a.juryVotesGiven).filter(v => v === point).length;
                    const bCount = Object.values(b.juryVotesGiven).filter(v => v === point).length;
                    if (aCount !== bCount) return bCount - aCount;
                }

                // If everything is still tied, maintain the previous order
                if (previousOrder) {
                    return previousOrder.indexOf(a.name) - previousOrder.indexOf(b.name);
                }

                // If no previous order is provided, countries remain in their current position
                return 0;
            }

            document.addEventListener('click', function (e) {
                if (e.target && e.target.id === 'showChartsButton') {
                    chartContainer.style.display = 'block';
                    chartContainer.innerHTML = `
            ${createVotingChart(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results, `Jury Voting - Semi-Final ${currentSemiFinal}`, false)}
            ${createVotingChart(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results, `Televoting - Semi-Final ${currentSemiFinal}`, true)}
            ${createSemiFinalTable(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results)}
        `;
                    e.target.style.display = 'none';
                }
            });

            document.querySelectorAll('.aq-checkbox').forEach(checkbox => {
                checkbox.disabled = !checkbox.previousElementSibling.previousElementSibling.checked;
            });

            document.getElementById('randomizeGenresButton').addEventListener('click', randomizeGenres);
            document.getElementById('randomizeScenographiesButton').addEventListener('click', randomizeScenographies);

            const genreLikeabilityContainer = document.getElementById('genreLikeability');
            genres.forEach(genre => {
                const div = document.createElement('div');
                div.innerHTML = `
        <label>${genre}:</label>
        <input type="number" class="genre-likeability" data-genre="${genre}" min="1" max="5" value="3">
    `;
                genreLikeabilityContainer.appendChild(div);
            });

            document.querySelectorAll('.genre-likeability').forEach(input => {
                input.addEventListener('change', (e) => {
                    const genre = e.target.dataset.genre;
                    const value = parseInt(e.target.value);
                    if (value >= 1 && value <= 5) {
                        genreLikeability[genre] = value;
                    } else {
                        e.target.value = genreLikeability[genre];
                    }
                });
            });

            const scenographyLikeabilityContainer = document.getElementById('scenographyLikeability');
            scenographies.forEach(scenography => {
                const div = document.createElement('div');
                div.innerHTML = `
        <label>${scenography}:</label>
        <input type="number" class="scenography-likeability" data-scenography="${scenography}" min="1" max="5" value="3">
    `;
                scenographyLikeabilityContainer.appendChild(div);
            });

            document.querySelectorAll('.scenography-likeability').forEach(input => {
                input.addEventListener('change', (e) => {
                    const scenography = e.target.dataset.scenography;
                    const value = parseInt(e.target.value);
                    if (value >= 1 && value <= 5) {
                        scenographyLikeability[scenography] = value;
                    } else {
                        e.target.value = scenographyLikeability[scenography];
                    }
                });
            });

            document.getElementById('randomizeScenographyLikeabilityButton').addEventListener('click', randomizeScenographyLikeability);

            dynamicVotingButton.addEventListener('click', () => {
                const { results, votingOrder } = finalResults;
                const competingCountries = Object.keys(results).filter(country => results[country].isCompeting);

                dynamicVotingArea.innerHTML = '';


                let html = `
        <h2>Dynamic Voting Simulation</h2>
        <div class="table-responsive">
            <table class="table table-striped eurovision-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Receiving Country</th>
                        <th>Song Title</th>
                        <th>Artist</th>
                        <th>Language</th>
                        <th>Genre</th>
                        <th>Jury Points</th>
                        ${votingOrder.map(country => `
                            <th class="rotate-header">
                                <div class="country-name">${country}</div>
                                <div class="flag-container">
                                    <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                                </div>
                            </th>
                        `).join('')}
                        <th>Televoting</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${competingCountries.map(country => `
                        <tr data-country="${country}">
                            <td class="rank"></td>
                            <td class="receiving-country">
                                ${country}
                                <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                            </td>
                            <td style="font-style: italic;">${results[country].songTitle || '-'}</td>
                            <td>${results[country].artistName || '-'}</td>
                            <td>${results[country].language || '-'}</td>
                            <td class="genre">${results[country].genre}</td>
                            <td class="jury-points">0</td>
                            ${votingOrder.map(voter => `<td class="points-column" data-voter="${voter}"></td>`).join('')}
                            <td class="tele-points">0</td>
                            <td class="total-column">0</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <button id="nextJuryButton" class="btn btn-primary mt-3 reveal-button">Reveal Next Jury</button>
        <button id="revealTelevotingButton" class="btn btn-success mt-3 reveal-button" style="display: none;">Reveal Televoting</button>
        <div id="debugInfo" class="mt-3"></div>
    `;

                dynamicVotingArea.innerHTML = html;

                let currentJuryIndex = 0;
                let isTelevotingMode = false;
                let rows;
                let currentTeleIndex = 0;

                function updateTable() {
                    const tableBody = document.querySelector('.eurovision-table tbody');
                    if (!tableBody) {
                        console.error('Table body not found');
                        return;
                    }

                    const rows = Array.from(tableBody.querySelectorAll('tr'));

                    const currentPositions = new Map(rows.map((row, index) => [row.dataset.country, index]));

                    rows.sort((a, b) => {
                        const aTotal = parseInt(a.querySelector('.total-column').textContent) || 0;
                        const bTotal = parseInt(b.querySelector('.total-column').textContent) || 0;
                        if (aTotal !== bTotal) {
                            return bTotal - aTotal;
                        }
                        const aCountry = a.dataset.country || '';
                        const bCountry = b.dataset.country || '';
                        return aCountry.localeCompare(bCountry);
                    });

                    rows.forEach((row, newIndex) => {
                        const country = row.dataset.country;
                        const oldIndex = currentPositions.get(country);
                        const rankCell = row.querySelector('.rank');
                        const countryNameCell = row.querySelector('.receiving-country');

                        if (newIndex !== oldIndex) {
                            const direction = newIndex > oldIndex ? 'moving-down' : 'moving-up';
                            row.classList.add(direction);
                            setTimeout(() => row.classList.remove(direction), 2500);

                            const distance = (newIndex - oldIndex) * row.offsetHeight;
                            row.style.transform = `translateY(${distance}px)`;

                            rankCell.textContent = newIndex + 1;
                        }

                        if (countryNameCell.classList.contains('tele-points-revealed')) {
                            row.classList.add('tele-revealed');
                        }
                    });

                    setTimeout(() => {
                        rows.forEach(row => {
                            row.style.transform = 'none';
                            tableBody.appendChild(row);
                            if (row.classList.contains('tele-revealed')) {
                                row.querySelector('.receiving-country').classList.add('tele-points-revealed');
                                row.classList.remove('tele-revealed');
                            }
                        });
                    }, 800);
                }

                function revealNextJury() {
                    if (currentJuryIndex < votingOrder.length) {
                        const votingCountry = votingOrder[currentJuryIndex];
                        console.log(`Revealing jury votes for: ${votingCountry}`);
                        document.getElementById('debugInfo').innerText = `Current Jury: ${votingCountry}`;

                        if (!results[votingCountry] || !results[votingCountry].juryVotesGiven) {
                            console.error(`No jury votes found for ${votingCountry}`);
                            currentJuryIndex++;
                            revealNextJury();
                            return;
                        }

                        const juryVotes = results[votingCountry].juryVotesGiven;

                        Object.entries(juryVotes).forEach(([receiver, points]) => {
                            const row = document.querySelector(`.eurovision-table tr[data-country="${receiver}"]`);
                            if (row) {
                                const pointsCell = row.querySelector(`.points-column[data-voter="${votingCountry}"]`);
                                const juryPointsCell = row.querySelector('.jury-points');
                                const totalPointsCell = row.querySelector('.total-column');

                                if (pointsCell && juryPointsCell && totalPointsCell) {
                                    pointsCell.textContent = points;
                                    pointsCell.classList.add(`points-${points}`, 'fade-in');
                                    if (votingCountry === receiver) {
                                        pointsCell.classList.add('self-vote');
                                    }

                                    const currentJuryPoints = parseInt(juryPointsCell.textContent) || 0;
                                    const newJuryPoints = currentJuryPoints + points;

                                    juryPointsCell.textContent = newJuryPoints;
                                    totalPointsCell.textContent = newJuryPoints;

                                    console.log(`${votingCountry} gave ${points} points to ${receiver}`);
                                } else {
                                    console.error(`Unable to find all cells for ${receiver}`);
                                }
                            } else {
                                console.error(`Row not found for ${receiver}`);
                            }
                        });

                        setTimeout(updateTable, 100);
                        currentJuryIndex++;

                        if (currentJuryIndex === votingOrder.length) {
                            document.getElementById('nextJuryButton').style.display = 'none';
                            document.getElementById('revealTelevotingButton').style.display = 'inline-block';
                        }
                    } else {
                        console.log('All jury votes revealed');
                        document.getElementById('nextJuryButton').style.display = 'none';
                        document.getElementById('revealTelevotingButton').style.display = 'inline-block';
                    }
                }

                document.getElementById('nextJuryButton').addEventListener('click', revealNextJury);

                function revealNextTele() {
                    if (currentTeleIndex < rows.length) {
                        const row = rows[currentTeleIndex];
                        const country = row.dataset.country;
                        if (!country || !results[country]) {
                            console.error(`No data found for country at index ${currentTeleIndex}`);
                            currentTeleIndex++;
                            revealNextTele();
                            return;
                        }
                        const telePoints = results[country].teleTotal;

                        row.classList.add('current-televote');

                        const telePointsCell = row.querySelector('.tele-points');
                        const totalPointsCell = row.querySelector('.total-column');
                        const juryPointsCell = row.querySelector('.jury-points');
                        const countryNameCell = row.querySelector('.receiving-country');

                        if (!telePointsCell || !totalPointsCell || !juryPointsCell || !countryNameCell) {
                            console.error(`Required cells not found for ${country}`);
                            currentTeleIndex++;
                            revealNextTele();
                            return;
                        }

                        const currentJuryPoints = parseInt(juryPointsCell.textContent) || 0;
                        const newTotalPoints = currentJuryPoints + telePoints;

                        setTimeout(() => {
                            telePointsCell.textContent = telePoints;
                            totalPointsCell.textContent = newTotalPoints;
                            telePointsCell.classList.add('tele-points-revealed', 'fade-in');
                            countryNameCell.classList.add('tele-points-revealed', 'fade-in');
                            row.classList.add('highlight');
                            row.classList.remove('current-televote');
                            setTimeout(() => {
                                row.classList.remove('highlight');
                            }, 800);
                            setTimeout(updateTable, 800);
                            currentTeleIndex++;
                            if (currentTeleIndex === rows.length) {
                                document.getElementById('revealTelevotingButton').style.display = 'none';
                            }
                        }, 1000);
                    }
                }

                document.getElementById('revealTelevotingButton').addEventListener('click', () => {
                    if (!isTelevotingMode) {
                        isTelevotingMode = true;
                        document.getElementById('revealTelevotingButton').textContent = 'Reveal Next Televote';

                        rows = Array.from(document.querySelectorAll('.eurovision-table tbody tr'));
                        rows.sort((a, b) => {
                            const aJuryPoints = parseInt(a.querySelector('.jury-points')?.textContent) || 0;
                            const bJuryPoints = parseInt(b.querySelector('.jury-points')?.textContent) || 0;
                            if (aJuryPoints !== bJuryPoints) {
                                return aJuryPoints - bJuryPoints;
                            }
                            const aCountry = a.querySelector('.receiving-country')?.textContent.trim() || '';
                            const bCountry = b.querySelector('.receiving-country')?.textContent.trim() || '';
                            return bCountry.localeCompare(aCountry);
                        });
                        currentTeleIndex = 0;
                        const oldClickHandler = document.getElementById('revealTelevotingButton').onclick;
                        if (oldClickHandler) {
                            document.getElementById('revealTelevotingButton').removeEventListener('click', oldClickHandler);
                        }
                        document.getElementById('revealTelevotingButton').onclick = revealNextTele;
                        revealNextTele();
                    }
                });

                updateTable();
            });

            document.getElementById('resetButton').addEventListener('click', () => {
                // Reset checkboxes and AQ status
                document.querySelectorAll('.country-checkbox, .aq-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                    if (checkbox.classList.contains('aq-checkbox')) {
                        checkbox.disabled = true;
                    }
                });

                // Reset odds inputs
                document.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => {
                    input.value = 100;
                });

                // Reset genre selections
                document.querySelectorAll('.genre-select').forEach(select => {
                    select.selectedIndex = 0;
                });

                // Reset scenography selections
                document.querySelectorAll('.scenography-select').forEach(select => {
                    select.selectedIndex = 0;
                });

                // Reset genre likeability
                genres.forEach(genre => genreLikeability[genre] = 3);
                updateGenreLikeabilityUI();

                // Reset scenography likeability
                scenographies.forEach(scenography => scenographyLikeability[scenography] = 3);
                updateScenographyLikeabilityUI();

                // Reset min and max odds
                document.getElementById('minOdds').value = 1;
                document.getElementById('maxOdds').value = 500;

                // Reset reveal time
                document.getElementById('revealTime').value = 10;

                // Clear results and dynamic voting area
                resultsDiv.innerHTML = '';
                dynamicVotingArea.innerHTML = '';

                // Hide and clear chart containers
                const chartContainers = document.querySelectorAll('.semi-final-charts, #chartContainer');
                chartContainers.forEach(container => {
                    container.innerHTML = '';
                    container.style.display = 'none';
                });

                // Remove simulation areas
                const simulationAreas = document.querySelectorAll('#simulationArea');
                simulationAreas.forEach(area => area.remove());

                // Remove draw simulation
                const drawSimulation = document.querySelector('.draw-simulation');
                if (drawSimulation) {
                    drawSimulation.remove();
                }

                // Reset results variables
                semiFinal1Results = null;
                semiFinal2Results = null;
                finalResults = null;
                currentSemiFinal = 1;

                // Reset button states
                document.getElementById('generateButton').disabled = false;
                semiFinal1Button.disabled = true;
                semiFinal2Button.disabled = true;
                finaleButton.disabled = true;
                simulateButton.disabled = true;
                dynamicVotingButton.disabled = true;
                dynamicESCVotingButton.disabled = true;
                document.getElementById('simulateSemiDrawButton').disabled = true;

                semiFinal1Button.classList.remove('btn-pink');
                semiFinal2Button.classList.remove('btn-pink');

                // Show settings card
                document.querySelector('.settings-card').style.display = 'block';

                // Scroll to top
                window.scrollTo(0, 0);

                // Update AQ checkbox status
                updateAQCheckboxStatus();
            });

            document.getElementById('instructionsButton').addEventListener('click', () => {
                const instructionsHTML = `
        <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="instructionsModalLabel">Eurovision Simulator Instructions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Welcome to the Eurovision Song Contest Simulator!</h6>
                        <p>This simulator allows you to create and run your own Eurovision-style contest. Here's what you can do:</p>
                        <ol>
                            <li><strong>Select Participating Countries:</strong> Choose from current and old contestants.</li>
                            <li><strong>Set Odds:</strong> Adjust the odds for each country (lower is better).</li>
                            <li><strong>Assign Genres:</strong> Select a genre for each country's song.</li>
                            <li><strong>Auto-Qualifiers:</strong> Mark countries as auto-qualifiers (up to 6).</li>
                            <li><strong>Randomize:</strong> Use buttons to randomize odds and genres.</li>
                            <li><strong>Adjust Diversity:</strong> Use the diversity slider to add variation to jury and televote scores.</li>
                            <li><strong>Genre Likeability:</strong> Set how well-liked each genre is, affecting voting patterns.</li>
                            <li><strong>Generate Results:</strong> Click 'GENERATE' to create contest results.</li>
                            <li><strong>View Charts:</strong> See detailed voting charts for semi-finals and finals.</li>
                            <li><strong>Simulate Draw:</strong> Watch a simulation of the semi-final draw.</li>
                            <li><strong>Dynamic Voting:</strong> Experience an interactive voting reveal for the final.</li>
                        </ol>
                        <p>Explore different scenarios, strategies, and see how changes in genres, odds, and preferences affect the contest outcomes!</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

                document.body.insertAdjacentHTML('beforeend', instructionsHTML);

                const instructionsModal = new bootstrap.Modal(document.getElementById('instructionsModal'));
                instructionsModal.show();
            });

            document.getElementById('whatsNewButton').addEventListener('click', () => {
                const whatsNewHTML = `
<div class="modal fade" id="whatsNewModal" tabindex="-1" aria-labelledby="whatsNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="whatsNewModalLabel">Eurovision Simulator - Version 1.2.5 Updates!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <div class="alert alert-info" role="alert">
                    <strong>A Big Thank You & Exciting News!</strong><br>
                    This simulator was originally created by <strong>u/Successful_Sky7328</strong>. After a period of inactivity (around 8 months), and with their kind permission, I've taken on the task of updating and hopefully expanding this wonderful tool for the Eurovision community!

                </div>
                <!--
                    Latest version notes: 1.2.7 (by u/alexsemilos)
                    In this release we added Google Login, User Profiles, and Advanced Customization
                -->
                <h6>Version 1.2.7 (by u/alexsemilos) <span class="badge bg-primary">PROFILE SPECIAL!</span></h6>
                <ul>
                    <li style="color:blue;"><strong>&lt;NEW FEATURE&gt; Enhanced User Profile:</strong>
                        <ul>
                            <li><strong>My Profile Button</strong> - Easily access your profile from the main menu.</li>
                            <li><strong>Drag & Drop Country Selector</strong> - Choose your Favorite Country from <strong>ALL countries in the world</strong> using a new drag-and-drop interface!</li>
                            <li><strong>Flags on Profile</strong> - Your favorite country now appears with its official flag on your profile.</li>
                            <li><strong>üìç Location</strong> - Add your City and Country to show where you are simulating from.</li>
                            <li><strong>üîó Social Handle</strong> - Add your social media handle (e.g. @username) to connect with others.</li>
                            <li><strong>New Tags</strong> - Dozens of new tags added! (e.g., "Wind Machine Enthusiast", "Chaos Agent", "Robbed Queen Support").</li>
                            <li><strong>Privacy Mode</strong> - Option to make your profile private (hides stats from leaderboard).</li>
                        </ul>
                    </li>
                    <li style="color:blue;"><strong>&lt;NEW FEATURE&gt; Google Login & Leaderboard:</strong>
                         <ul>
                            <li><strong>Google Sign-In</strong> - Log in safely.</li>
                            <li><strong>User Leaderboard</strong> - Compete for most simulations!</li>
                            <li><strong>Role Badges</strong> - Admin/Dev badges for special users.</li>
                        </ul>
                    </li>
                </ul>
                <!--
                    Latest version notes: 1.2.6 (by u/alexsemilos)
                    In this release we add JESC 2025 Voting
                -->
                <h6>Version 1.2.6 (by u/alexsemilos) <span class="badge bg-primary">VOTING SPECIAL!</span></h6>
                <ul>
                    <li style="color:blue;"><strong>&lt;NEW FEATURE&gt; Junior Eurovision 2025 Voting:</strong> Vote for your favorite song from JESC 2025!
                        <ul>
                            <li><strong>Interactive Voting</strong> - Click the new "JESC 2025 VOTE" button to cast your vote.</li>
                            <li><strong>Real-time Results</strong> - See live voting statistics powered by Firebase.</li>
                            <li><strong>Secure Voting</strong> - One vote per user system.</li>
                        </ul>
                    </li>
                </ul>
                <!--
                    Latest version notes: 1.2.5 (by u/alexsemilos)
                    In this release we add Christmas decorations
                -->
                <h6>Version 1.2.5 (by u/alexsemilos) <span class="badge bg-info">HOLIDAY UPDATE!</span></h6>
                <ul>
                    <li style="color:green;"><strong>&lt;NEW FEATURE&gt; Christmas Decorations:</strong> Get into the holiday spirit with festive decorations!
                        <ul>
                            <li><strong>Animated Snowflakes</strong> - Beautiful falling snowflakes across the entire page</li>
                            <li><strong>Christmas Lights</strong> - Colorful twinkling lights at the top of the page</li>
                            <li><strong>Holiday Banner</strong> - Festive greeting banner with seasonal wishes</li>
                            <li><strong>Festive Styling</strong> - Christmas tree emojis on the title and snowflakes on cards</li>
                            <li><strong>Toggle Button</strong> - Don't like Christmas? Click the "üéÑ CHRISTMAS MODE" button to turn it on/off. Your preference is saved!</li>
                        </ul>
                    </li>
                    <li style="color:green;"><strong>&lt;NEW FEATURE&gt; Advent Calendar:</strong> A Eurovision-themed Advent Calendar with 24 doors!
                        <ul>
                            <li><strong>Daily Doors</strong> - Open one door each day from December 1-24</li>
                            <li><strong>Eurovision Countries</strong> - Each door reveals a Eurovision country with its flag</li>
                            <li><strong>Fun Facts</strong> - Learn interesting Eurovision trivia with each door</li>
                            <li><strong>üéØ Eurovision Quiz</strong> - Each door has a trivia question about Eurovision! Answer correctly for points</li>
                            <li><strong>Points System</strong> - Earn 10 points for each correct answer. Track your total score!</li>
                            <li><strong>Progress Tracking</strong> - Your opened doors and quiz scores are saved</li>
                            <li><strong>Reset Option</strong> - Start fresh anytime with the reset button</li>
                        </ul>
                    </li>
                    <li style="color:green;"><strong>&lt;NEW FEATURE&gt; Christmas Leaderboard:</strong> Global statistics powered by Firebase!
                        <ul>
                            <li><strong>üèÜ Global Ranking</strong> - See which countries win the most across ALL users</li>
                            <li><strong>Total Simulations</strong> - Track how many simulations have been run worldwide</li>
                            <li><strong>Top Countries</strong> - View the top 20 most winning countries</li>
                            <li><strong>Firebase Integration</strong> - Real-time data synced across all users</li>
                            <li><strong>Demo Mode</strong> - Works without Firebase configuration with sample data</li>
                        </ul>
                    </li>
                </ul>
                <h6>Version 1.2.4 (by u/alexsemilos) <span class="badge bg-success">MAJOR UPDATE!</span></h6>
                <ul>
                    <li style="color:green;"><strong>&lt;NEW FEATURE&gt; Song Information:</strong> You can now add optional song details for each country:
                        <ul>
                            <li><strong>Song Title</strong> - Displayed in italic style throughout results</li>
                            <li><strong>Artist Name</strong> - The performer's name</li>
                            <li><strong>Language</strong> - Choose from English, Native, French, Italian, Spanish, German, or Other</li>
                        </ul>
                        All song information appears in results tables, voting charts, and is saved/loaded with scenarios!
                    </li>
                    <li style="color:green;"><strong>&lt;MAJOR UPGRADE&gt; Realistic Voting System:</strong> Completely remastered voting algorithm that simulates real Eurovision patterns:
                        <ul>
                            <li><strong>Geographical Voting Blocks</strong> - Nordic countries support each other, Balkans vote together, Post-Soviet bloc exchanges points, etc. (+40% boost for neighbors)</li>
                            <li><strong>Cultural & Linguistic Ties</strong> - Slavic nations favor each other, Romance language countries exchange votes (+25% boost)</li>
                            <li><strong>Language Impact</strong> - English songs get a boost everywhere (+15% jury, +25% televoting). Native language songs appeal emotionally to diaspora</li>
                            <li><strong>Jury vs Televoting Differences</strong> - Juries are more professional and less biased by geography. Televoting is more emotional and influenced by cultural connections</li>
                            <li><strong>Quality Recognition</strong> - Strong entries (low odds) naturally receive points from many countries. Weaker entries get points from fewer countries</li>
                            <li><strong>Natural Variance</strong> - Each country votes with different weights based on their relationships. Results vary realistically between simulations</li>
                        </ul>
                    </li>
                    <li><strong>Improved Balance:</strong> Fixed multiplier stacking issues - genre, likeability, and scenography bonuses now apply smoothly without creating extreme ranges</li>
                    <li><strong>Smooth Genre Bonus:</strong> Genre popularity now uses a smooth curve instead of harsh thresholds for more natural results</li>
                    <li><strong>Bug Fixes:</strong> Resolved several edge cases and improved error handling throughout the voting system</li>
                </ul>
                <p><strong>What This Means:</strong> Simulations now feel much more like real Eurovision! You'll see familiar voting patterns - Nordic countries exchange 12s, strong songs dominate across the board, and English songs perform consistently well. Yet every simulation is unique due to realistic randomness!</p>
                
                <h6>Version 1.2.3 (by u/alexsemilos)</h6>
                <ul>
                    <li style="color:green;"><strong>&lt;NEW FEATURE&gt; Scenography Category:</strong> A brand new category similar to Genre Likeability! You can now assign scenography types (Minimal, LED Screens, Props, Dancers, Pyrotechnics, Stage Levels, Projections, Interactive, Classical, Abstract) to each country and set likeability scores (1-5) that affect voting odds. Includes randomization buttons and full save/load support.</li>
                    <li style="color:green;"><strong>&lt;NEW FEATURE&gt; Welcome Modal:</strong> New visitors are now greeted with a friendly welcome message inviting them to join our Reddit community at r/YourOwnESC. The modal appears only once per browser using localStorage.</li>
                    <li>Scenography is now displayed in all results tables (Semi-Finals and Finals).</li>
                    <li>Added comprehensive fallback handling for undefined scenography values to prevent calculation errors.</li>
                    <li>Improved selector robustness for better DOM traversal and error prevention.</li>
                    <li>Scenography data is properly integrated into getQualifiers() function.</li>
                </ul>
                <h6>Version 1.2.2 (by u/alexsemilos)</h6>
                <ul>
                    <li style="color:green;"><strong>&lt;NEW FEATURE&gt; Automatic Participant List Loading:</strong> You can now fetch official participant lists by year directly from a public Eurovision dataset on GitHub. Enter a year in the new field and click <em>Load Participants</em> to import the countries.  (by u/alexsemilos)</li>
                    <li style="color:green;"><strong>Refactored Data Model:</strong> All contestant lists are now consolidated into a single object, and country tables are generated dynamically. This eliminates duplicated code and makes it easy to add new categories. (by u/alexsemilos)</li>
                    <li>Improved error handling and clearer status messages when loading participants. (by u/alexsemilos)</li>
                    <li style="color:green;"><strong>Dark Mode:</strong> Dark Mode to adjust when needed. (by u/Successful_Sky7328)</li>
                </ul>
                <h6>Version 1.2.1 (by u/Successful_Sky7328)</h6>
                <ul>
                    <li style="color:green;">New mode with ESC Scoreboard split table and revealing only 1 jury/tele at time in chart.</li>
                </ul>
                <h6>Version 1.2.0 (by u/alexsemilos) <span class="badge bg-success">NEW COOWNER!</span></h6>
                <p>Hello everyone! As the new comaker of this project, I'm excited to bring you the first set of updates:</p>
                <ul>
                    <li style="color:green;"><strong><FEATURE UPGRADE> Custom Filenames for Saved Scenarios:</strong> To help you better organize your simulations, you can now specify a custom filename when saving your scenarios.</li>
                    <li style="color:green;"><strong><NEW FEATURE> Scenario Saving & Loading:</strong> This was a much-anticipated capability! You can now save your entire simulation setup ‚Äì including selected countries, their odds, genres, any custom contestants you've added, global settings like genre likeability, and the voting system ‚Äì to a local file. Load it back anytime to continue your work or re-run a favorite setup.</li>
                    <li>Initial code refactoring for easier future development and stability for these new features.</li>
                </ul>
                <p>This is just the beginning! I'm keen to hear your feedback and ideas for future enhancements. Let's make this simulator even better together!</p>
                <hr> 
                <p><em>For context, here's a look back at the great work done by u/Successful_Sky7328:</em></p>
                <h6>Version 1.1.1 (by u/Successful_Sky7328)</h6>
                <ul>
                    <li>New built-in countries from around the world.</li>
                    <li>Counter for countries participating in the season.</li>
                    <li>Minor adjustments to odds calculations.</li>
                    <li><i>... (and other changes from v.1.1.1 as listed in your original file) ...</i></li>
                </ul>
                 <h6>Version 1.1.0 (by u/Successful_Sky7328)</h6>
                <ul>
                    <li>Mode to remove jury from Semi-Finals.</li>
                    <li>Custom countries with custom icons (original credits to u/stems_twice).</li>
                    <li>Separated odds for Televoting and Jury; updated odds menu.</li>
                    <li>Increased Auto-Qualifiers limit to 10 (available with 27+ countries).</li>
                    <li>Odds hidden in charts and simulations.</li>
                </ul>
                 <h6>Version 1.0.1 (by u/Successful_Sky7328)</h6>
                <ul>
                    <li>"What's New?" button added.</li>
                    <li>New genres: Heavy Metal, Techno, and Rap.</li>
                    <li>Genres displayed in a grid layout.</li>
                    <li>Menu layout changed to horizontal.</li>
                    <li>Dynamic finale table moved above charts.</li>
                    <li>"AQ" label added for auto-qualifier checkboxes.</li>
                    <li>Tiebreaker system fixed for more accurate results.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
    `;

                document.body.insertAdjacentHTML('beforeend', whatsNewHTML);

                const whatsNewModal = new bootstrap.Modal(document.getElementById('whatsNewModal'));
                whatsNewModal.show();
            });
            updateAQCheckboxStatus();
            document.addEventListener('DOMContentLoaded', updateAQCheckboxStatus);

            // ===== CHRISTMAS SNOWFLAKES ANIMATION =====
            function createSnowflakes() {
                const snowflakesContainer = document.getElementById('snowflakes');
                const snowflakeSymbols = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚úª', '‚úº', '‚ùã'];
                const numberOfSnowflakes = 50;

                for (let i = 0; i < numberOfSnowflakes; i++) {
                    const snowflake = document.createElement('div');
                    snowflake.className = 'snowflake';
                    snowflake.textContent = snowflakeSymbols[Math.floor(Math.random() * snowflakeSymbols.length)];

                    // Random properties
                    const leftPosition = Math.random() * 100;
                    const animationDuration = Math.random() * 8 + 5; // 5-13 seconds
                    const animationDelay = Math.random() * 10;
                    const fontSize = Math.random() * 1.5 + 0.8; // 0.8-2.3em
                    const opacity = Math.random() * 0.5 + 0.5; // 0.5-1

                    snowflake.style.left = leftPosition + '%';
                    snowflake.style.animationDuration = animationDuration + 's';
                    snowflake.style.animationDelay = animationDelay + 's';
                    snowflake.style.fontSize = fontSize + 'em';
                    snowflake.style.opacity = opacity;

                    snowflakesContainer.appendChild(snowflake);
                }
            }

            // Create snowflakes when page loads
            createSnowflakes();

            // ===== CHRISTMAS TOGGLE FUNCTIONALITY =====
            const christmasElements = {
                lights: document.querySelector('.christmas-lights'),
                snowflakes: document.getElementById('snowflakes'),
                banner: document.querySelector('.christmas-banner')
            };

            function setChristmasMode(enabled) {
                if (enabled) {
                    christmasElements.lights.style.display = 'flex';
                    christmasElements.snowflakes.style.display = 'block';
                    christmasElements.banner.style.display = 'block';
                    document.body.classList.add('christmas-enabled');
                    document.getElementById('toggleChristmas').innerHTML = 'üéÑ CHRISTMAS: ON';
                    document.getElementById('toggleChristmas').classList.remove('btn-secondary');
                    document.getElementById('toggleChristmas').classList.add('btn-danger');
                } else {
                    christmasElements.lights.style.display = 'none';
                    christmasElements.snowflakes.style.display = 'none';
                    christmasElements.banner.style.display = 'none';
                    document.body.classList.remove('christmas-enabled');
                    document.getElementById('toggleChristmas').innerHTML = 'üéÑ CHRISTMAS: OFF';
                    document.getElementById('toggleChristmas').classList.remove('btn-danger');
                    document.getElementById('toggleChristmas').classList.add('btn-secondary');
                }
                localStorage.setItem('christmasMode', enabled);
            }

            // Load saved preference (default: enabled)
            const savedChristmasMode = localStorage.getItem('christmasMode');
            const christmasEnabled = savedChristmasMode === null ? true : savedChristmasMode === 'true';
            setChristmasMode(christmasEnabled);

            // Toggle button click handler
            document.getElementById('toggleChristmas').addEventListener('click', () => {
                const currentState = localStorage.getItem('christmasMode') !== 'false';
                setChristmasMode(!currentState);
            });

            // ===== ADVENT CALENDAR FUNCTIONALITY =====
            const adventCountries = [
                {
                    flag: 'üá∏üá™', name: 'Sweden', fact: 'Sweden has won Eurovision 7 times - the most shared record!',
                    quiz: { question: 'How many times has Sweden won Eurovision?', answers: ['5', '6', '7', '8'], correct: 2 }
                },
                {
                    flag: 'üáÆüá™', name: 'Ireland', fact: 'Ireland won Eurovision 3 times in a row (1992-1994)!',
                    quiz: { question: 'Which country won Eurovision 3 times in a row?', answers: ['Sweden', 'Ireland', 'Luxembourg', 'UK'], correct: 1 }
                },
                {
                    flag: 'üá±üá∫', name: 'Luxembourg', fact: 'Luxembourg won Eurovision 5 times despite its small size!',
                    quiz: { question: 'How many times has Luxembourg won Eurovision?', answers: ['2', '3', '4', '5'], correct: 3 }
                },
                {
                    flag: 'üá´üá∑', name: 'France', fact: 'France is a founding member of Eurovision since 1956!',
                    quiz: { question: 'When was the first Eurovision Song Contest held?', answers: ['1950', '1956', '1960', '1965'], correct: 1 }
                },
                {
                    flag: 'üá≥üá±', name: 'Netherlands', fact: 'The Netherlands hosted Eurovision 5 times!',
                    quiz: { question: 'Which Dutch city hosted Eurovision in 2021?', answers: ['Amsterdam', 'The Hague', 'Rotterdam', 'Utrecht'], correct: 2 }
                },
                {
                    flag: 'üá¨üáß', name: 'United Kingdom', fact: 'UK has finished in 2nd place more times than any other country!',
                    quiz: { question: 'The UK has the most what in Eurovision history?', answers: ['Wins', '2nd places', 'Last places', 'Hosts'], correct: 1 }
                },
                {
                    flag: 'üá©üá™', name: 'Germany', fact: 'Germany has participated in every Eurovision since 1956!',
                    quiz: { question: 'Which artist won Eurovision 2010 for Germany?', answers: ['Nicole', 'Lena', 'Cascada', 'Max Mutzke'], correct: 1 }
                },
                {
                    flag: 'üáÆüáπ', name: 'Italy', fact: 'Italy won Eurovision 2021 with M√•neskin\'s "Zitti e buoni"!',
                    quiz: { question: 'Which band won Eurovision 2021 for Italy?', answers: ['Mahmood', 'Il Volo', 'M√•neskin', 'Diodato'], correct: 2 }
                },
                {
                    flag: 'üá™üá∏', name: 'Spain', fact: 'Spain has received "nul points" twice in Eurovision!',
                    quiz: { question: 'What does "nul points" mean in Eurovision?', answers: ['12 points', '0 points', 'Disqualified', 'Winner'], correct: 1 }
                },
                {
                    flag: 'üá®üá≠', name: 'Switzerland', fact: 'Switzerland won the very first Eurovision in 1956!',
                    quiz: { question: 'Which country won the first Eurovision in 1956?', answers: ['France', 'Germany', 'Switzerland', 'Netherlands'], correct: 2 }
                },
                {
                    flag: 'üá≥üá¥', name: 'Norway', fact: 'Norway holds the record for most last-place finishes!',
                    quiz: { question: 'Which Norwegian group won Eurovision 1985?', answers: ['A-ha', 'Secret Garden', 'Bobbysocks', 'Alexander Rybak'], correct: 2 }
                },
                {
                    flag: 'üá©üá∞', name: 'Denmark', fact: 'Denmark hosted Eurovision in 2014 in Copenhagen!',
                    quiz: { question: 'What year did Emmelie de Forest win for Denmark?', answers: ['2011', '2012', '2013', '2014'], correct: 2 }
                },
                {
                    flag: 'üá´üáÆ', name: 'Finland', fact: 'Finland won in 2006 with Lordi - first hard rock winners!',
                    quiz: { question: 'What genre did Lordi bring to Eurovision?', answers: ['Pop', 'Ballad', 'Hard Rock', 'EDM'], correct: 2 }
                },
                {
                    flag: 'üá¶üáπ', name: 'Austria', fact: 'Conchita Wurst won for Austria in 2014 and became an icon!',
                    quiz: { question: 'What was Conchita Wurst\'s winning song called?', answers: ['Heroes', 'Rise Like a Phoenix', 'Euphoria', '1944'], correct: 1 }
                },
                {
                    flag: 'üá¨üá∑', name: 'Greece', fact: 'Greece and Cyprus often exchange 12 points for each other!',
                    quiz: { question: 'Which Greek singer won Eurovision 2005?', answers: ['Sakis Rouvas', 'Helena Paparizou', 'Eleni Foureira', 'Kalomira'], correct: 1 }
                },
                {
                    flag: 'üáµüáπ', name: 'Portugal', fact: 'Salvador Sobral won for Portugal in 2017 with record points!',
                    quiz: { question: 'What was Salvador Sobral\'s winning song?', answers: ['Amar Pelos Dois', 'Medo De Sentir', 'O Jardim', 'Saudade'], correct: 0 }
                },
                {
                    flag: 'üáÆüá±', name: 'Israel', fact: 'Israel has won Eurovision 4 times!',
                    quiz: { question: 'Who won Eurovision 2018 for Israel?', answers: ['Dana International', 'Netta', 'Eden Alene', 'Nadav Guedj'], correct: 1 }
                },
                {
                    flag: 'üá∫üá¶', name: 'Ukraine', fact: 'Ukraine won Eurovision 3 times including 2022!',
                    quiz: { question: 'Which Ukrainian band won Eurovision 2022?', answers: ['Go_A', 'Kalush Orchestra', 'Jamala', 'Ruslana'], correct: 1 }
                },
                {
                    flag: 'üá∑üá∏', name: 'Serbia', fact: 'Serbia won Eurovision on their debut in 2007!',
                    quiz: { question: 'Who won Eurovision 2007 for Serbia?', answers: ['Jelena Toma≈°eviƒá', 'Marija ≈†erifoviƒá', '≈Ωeljko Joksimoviƒá', 'Konstrakta'], correct: 1 }
                },
                {
                    flag: 'üá™üá™', name: 'Estonia', fact: 'Estonia was the first former Soviet country to win in 2001!',
                    quiz: { question: 'What country was the first ex-Soviet nation to win?', answers: ['Latvia', 'Lithuania', 'Estonia', 'Ukraine'], correct: 2 }
                },
                {
                    flag: 'üá¶üáø', name: 'Azerbaijan', fact: 'Azerbaijan won Eurovision 2011 with "Running Scared"!',
                    quiz: { question: 'In which city did Azerbaijan host Eurovision 2012?', answers: ['Baku', 'Ganja', 'Sumgait', 'Mingachevir'], correct: 0 }
                },
                {
                    flag: 'üá≤üáπ', name: 'Malta', fact: 'Malta has finished 2nd place three times but never won!',
                    quiz: { question: 'How many times has Malta finished 2nd at Eurovision?', answers: ['1', '2', '3', '4'], correct: 2 }
                },
                {
                    flag: 'üáÆüá∏', name: 'Iceland', fact: 'Iceland has never won Eurovision but came close in 2009!',
                    quiz: { question: 'Which Icelandic artist came 2nd in Eurovision 2009?', answers: ['Hatari', 'Da√∞i Freyr', 'Yohanna', 'Systur'], correct: 2 }
                },
                {
                    flag: 'üá®üáæ', name: 'Cyprus', fact: 'Cyprus and Greece have a strong voting bond for decades!',
                    quiz: { question: 'What\'s the highest placement Cyprus has achieved?', answers: ['1st', '2nd', '3rd', '4th'], correct: 1 }
                }
            ];

            function getOpenedDoors() {
                const saved = localStorage.getItem('adventOpenedDoors');
                return saved ? JSON.parse(saved) : [];
            }

            function getQuizScore() {
                const saved = localStorage.getItem('adventQuizScore');
                return saved ? parseInt(saved) : 0;
            }

            function addQuizScore(points) {
                const current = getQuizScore();
                localStorage.setItem('adventQuizScore', current + points);
                return current + points;
            }

            function getAnsweredQuizzes() {
                const saved = localStorage.getItem('adventAnsweredQuizzes');
                return saved ? JSON.parse(saved) : [];
            }

            function markQuizAnswered(day) {
                const answered = getAnsweredQuizzes();
                if (!answered.includes(day)) {
                    answered.push(day);
                    localStorage.setItem('adventAnsweredQuizzes', JSON.stringify(answered));
                }
            }

            function saveOpenedDoor(day) {
                const opened = getOpenedDoors();
                if (!opened.includes(day)) {
                    opened.push(day);
                    localStorage.setItem('adventOpenedDoors', JSON.stringify(opened));
                }
            }

            function getCurrentDay() {
                const now = new Date();
                const month = now.getMonth(); // 0-11
                const day = now.getDate();
                // Only December counts, return day 1-24
                if (month === 11 && day >= 1 && day <= 24) {
                    return day;
                }
                return 24; // After Dec 24 or other months - all doors available
            }

            function showAdventCalendar() {
                const currentDay = getCurrentDay();
                const openedDoors = getOpenedDoors();

                let doorsHTML = '';
                for (let i = 1; i <= 24; i++) {
                    const isOpened = openedDoors.includes(i);
                    const isLocked = i > currentDay;
                    const isToday = i === currentDay;

                    let doorClass = 'advent-door';
                    if (isOpened) doorClass += ' opened';
                    if (isLocked) doorClass += ' locked';
                    if (isToday && !isOpened) doorClass += ' today';

                    const content = isOpened ? adventCountries[i - 1].flag : i;
                    doorsHTML += `<div class="${doorClass}" data-day="${i}">${content}</div>`;
                }

                const adventHTML = `
<div class="modal fade" id="adventModal" tabindex="-1" aria-labelledby="adventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #c41e3a 0%, #1a472a 100%); color: white;">
                <h5 class="modal-title" id="adventModalLabel">üìÖ Eurovision Advent Calendar üéÑ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-center mb-3">
                    <strong>Open a door each day to discover Eurovision countries and fun facts!</strong><br>
                    <small>Today is December ${currentDay}th - you can open doors 1-${currentDay}</small>
                </p>
                <div class="advent-calendar-grid">
                    ${doorsHTML}
                </div>
                <div class="advent-stats" style="background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);">
                    <div>
                        <div class="stat-number">${openedDoors.length}</div>
                        <div>Doors Opened</div>
                    </div>
                    <div>
                        <div class="stat-number">${24 - openedDoors.length}</div>
                        <div>Doors Left</div>
                    </div>
                    <div>
                        <div class="stat-number" id="quizScoreDisplay">${getQuizScore()}</div>
                        <div>üéØ Quiz Points</div>
                    </div>
                    <div>
                        <div class="stat-number">${getAnsweredQuizzes().length}/24</div>
                        <div>Quizzes Done</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="resetAdventBtn">üîÑ Reset Calendar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
                `;

                // Remove existing modal if present
                const existingModal = document.getElementById('adventModal');
                if (existingModal) existingModal.remove();

                document.body.insertAdjacentHTML('beforeend', adventHTML);

                const adventModal = new bootstrap.Modal(document.getElementById('adventModal'));
                adventModal.show();

                // Add click handlers for doors
                document.querySelectorAll('.advent-door').forEach(door => {
                    door.addEventListener('click', function () {
                        const day = parseInt(this.dataset.day);
                        const currentDay = getCurrentDay();

                        if (day > currentDay) {
                            alert(`üîí This door is locked!\nCome back on December ${day}th to open it.`);
                            return;
                        }

                        const openedDoors = getOpenedDoors();
                        if (openedDoors.includes(day)) {
                            // Already opened - show content again
                            showDoorContent(day);
                        } else {
                            // Open for first time
                            saveOpenedDoor(day);
                            this.classList.add('opened');
                            this.innerHTML = adventCountries[day - 1].flag;
                            showDoorContent(day);

                            // Update stats
                            const newOpened = getOpenedDoors();
                            document.querySelector('.advent-stats .stat-number').textContent = newOpened.length;
                            document.querySelectorAll('.advent-stats .stat-number')[1].textContent = 24 - newOpened.length;
                        }
                    });
                });

                // Reset button handler
                document.getElementById('resetAdventBtn').addEventListener('click', function () {
                    if (confirm('üéÑ Are you sure you want to reset your Advent Calendar?\nAll opened doors will be closed.')) {
                        localStorage.removeItem('adventOpenedDoors');
                        localStorage.removeItem('adventQuizScore');
                        localStorage.removeItem('adventAnsweredQuizzes');
                        adventModal.hide();
                        showAdventCalendar();
                    }
                });
            }

            function showDoorContent(day) {
                const country = adventCountries[day - 1];
                const quiz = country.quiz;
                const alreadyAnswered = getAnsweredQuizzes().includes(day);

                let quizHTML = '';
                if (alreadyAnswered) {
                    quizHTML = `
                        <div class="quiz-section" style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                            <p style="color: #2e7d32; font-weight: bold;">‚úÖ You've already answered this quiz!</p>
                            <p><strong>Question:</strong> ${quiz.question}</p>
                            <p><strong>Correct Answer:</strong> ${quiz.answers[quiz.correct]}</p>
                        </div>
                    `;
                } else {
                    const answersHTML = quiz.answers.map((answer, index) =>
                        `<button class="btn btn-outline-primary quiz-answer m-1" style="min-width: 120px;" data-index="${index}">${answer}</button>`
                    ).join('');

                    quizHTML = `
                        <div class="quiz-section" style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 10px;">
                            <p style="color: #e65100; font-weight: bold;">üéØ Eurovision Quiz - Answer for points!</p>
                            <p style="font-weight: bold; margin-bottom: 10px;">${quiz.question}</p>
                            <div class="quiz-answers" style="display: flex; flex-wrap: wrap; justify-content: center;">
                                ${answersHTML}
                            </div>
                            <p id="quizFeedback" style="margin-top: 10px; font-weight: bold;"></p>
                        </div>
                    `;
                }

                const contentHTML = `
<div class="modal fade" id="doorContentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #2989d8 0%, #1e5799 100%); color: white;">
                <h5 class="modal-title">üéÅ Day ${day} - ${country.name}!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body advent-content">
                <div class="country-reveal">${country.flag}</div>
                <div class="country-name">${country.name}</div>
                <div class="fun-fact">
                    <strong>üéµ Eurovision Fun Fact:</strong><br>
                    ${country.fact}
                </div>
                ${quizHTML}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">üéÑ Continue</button>
            </div>
        </div>
    </div>
</div>
                `;

                const existingContent = document.getElementById('doorContentModal');
                if (existingContent) existingContent.remove();

                document.body.insertAdjacentHTML('beforeend', contentHTML);
                const contentModal = new bootstrap.Modal(document.getElementById('doorContentModal'));
                contentModal.show();

                // Add quiz answer handlers if not already answered
                if (!alreadyAnswered) {
                    document.querySelectorAll('.quiz-answer').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const selectedIndex = parseInt(this.dataset.index);
                            const isCorrect = selectedIndex === quiz.correct;
                            const feedback = document.getElementById('quizFeedback');

                            // Disable all buttons
                            document.querySelectorAll('.quiz-answer').forEach(b => {
                                b.disabled = true;
                                if (parseInt(b.dataset.index) === quiz.correct) {
                                    b.classList.remove('btn-outline-primary');
                                    b.classList.add('btn-success');
                                }
                            });

                            if (isCorrect) {
                                this.classList.add('btn-success');
                                const newScore = addQuizScore(10);
                                feedback.innerHTML = 'üéâ <span style="color: green;">Correct! +10 points!</span> Your total: ' + newScore + ' points';
                                // Add confetti effect
                                this.innerHTML += ' ‚úì';
                            } else {
                                this.classList.remove('btn-outline-primary');
                                this.classList.add('btn-danger');
                                feedback.innerHTML = '‚ùå <span style="color: red;">Wrong!</span> The correct answer was: <strong>' + quiz.answers[quiz.correct] + '</strong>';
                            }

                            markQuizAnswered(day);

                            // Update score display in calendar if visible
                            const scoreDisplay = document.getElementById('quizScoreDisplay');
                            if (scoreDisplay) {
                                scoreDisplay.textContent = getQuizScore();
                            }
                        });
                    });
                }
            }

            // Advent Calendar button click handler
            document.getElementById('adventCalendarButton').addEventListener('click', showAdventCalendar);

            // ===== SECURITY PROTOCOL =====
            // Unauthorized access to this section is strictly monitoring.

            const _0xGen = {
                _a: "eurovision-simulator",
                _b: ".firebaseapp.com",
                _c: ".firebasestorage.app",
                _d: "619727891514",
                _e: "1:619727891514:web:cb8e0ca1351cb7e0acd903",
                _f: "G-DPX10D8Z9E"
            };


            const _0xPayload = [
                "DL}dV|Gp6}]zQlif}Q9zhvEMQtvP<dD;05ORg:T",
            ]; function _0xDecrypt(_s) {
                let _r = "";
                for (let i = 0; i < _s.length; i++) {
                    _r += String.fromCharCode(_s.charCodeAt(i) - 3);
                }
                return _r;
            }


            function _0xGetConfig() {
                const _h = window.location.hostname;


                const _isSecure = _h.includes('github.io') || _h.includes('localhost') || _h.includes('127.0.0.1');

                if (!_isSecure) {
                    console.warn("‚õî SECURITY ALERT: Unauthorized Environment Detected. Countermeasures Active.");
                    return null;
                }

                return {
                    apiKey: _0xDecrypt(_0xPayload[0]), // Decrypts just-in-time
                    authDomain: _0xGen._a + _0xGen._b,
                    projectId: _0xGen._a,
                    storageBucket: _0xGen._a + _0xGen._c,
                    messagingSenderId: _0xGen._d,
                    appId: _0xGen._e,
                    measurementId: _0xGen._f
                };
            }

            const firebaseConfig = _0xGetConfig() || { apiKey: "ACCESS_DENIED" };

            // Initialize Firebase (only if config is set)
            let db = null;
            let firebaseEnabled = false;
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';

            try {
                if (firebaseConfig.apiKey && firebaseConfig.apiKey.startsWith("AIza")) {
                    firebase.initializeApp(firebaseConfig);

                    // Initialize App Check with reCAPTCHA v3 (only on production, not localhost)
                    if (!isLocalhost) {
                        const appCheck = firebase.appCheck();
                        appCheck.activate('6Lei5igsAAAAACmnL1hacrM-bsA_SUyuM4nutnh-', true);
                        console.log('üîí App Check activated with reCAPTCHA v3');
                    } else {
                        console.log('‚ö†Ô∏è Localhost detected - App Check disabled for development');
                    }

                    db = firebase.firestore();
                    firebaseEnabled = true;
                    console.log('üî• Firebase connected successfully!');

                    // ===== ANTI-EXPLOIT PROTECTION =====
                    // Prevent direct window.db access for console exploits
                    Object.defineProperty(window, 'db', {
                        get: function () {
                            console.warn('‚õî SECURITY: Direct db access blocked! Use official functions.');
                            return null;
                        },
                        set: function () {
                            console.warn('‚õî SECURITY: Cannot override db!');
                        },
                        configurable: false
                    });

                    // Block firebase.firestore() from returning usable instance for exploits
                    const originalFirestore = firebase.firestore;
                    let firestoreCallCount = 0;
                    firebase.firestore = function () {
                        firestoreCallCount++;
                        // First call is legitimate (our init), subsequent calls are suspicious
                        if (firestoreCallCount > 1) {
                            console.warn('‚õî SECURITY: Suspicious firestore() call detected!');
                            // Return a fake/neutered db object
                            return {
                                collection: function () {
                                    console.warn('‚õî EXPLOIT BLOCKED: You cannot spam the leaderboard!');
                                    return {
                                        doc: () => ({
                                            set: () => Promise.reject(new Error('BLOCKED')),
                                            get: () => Promise.reject(new Error('BLOCKED')),
                                            update: () => Promise.reject(new Error('BLOCKED'))
                                        }),
                                        get: () => Promise.reject(new Error('BLOCKED')),
                                        orderBy: () => ({ limit: () => ({ get: () => Promise.reject(new Error('BLOCKED')) }) })
                                    };
                                }
                            };
                        }
                        return originalFirestore.call(firebase);
                    };
                    // Restore static properties lost during proxying
                    firebase.firestore.FieldValue = originalFirestore.FieldValue;
                    firebase.firestore.Timestamp = originalFirestore.Timestamp;

                    // Detect and warn about exploit scripts
                    const exploitPatterns = ['realSpam', 'spam.palestine', 'spam.israel', 'spam.war', 'hack.'];
                    const originalConsoleLog = console.log;
                    let exploitWarningShown = false;

                    // Monitor for exploit variables being created
                    const exploitWatcher = setInterval(() => {
                        if (window.realSpam || window.spam || window.hack) {
                            if (!exploitWarningShown) {
                                console.clear();
                                console.log('%c‚õî EXPLOIT DETECTED AND BLOCKED! ‚õî', 'color: red; font-size: 24px; font-weight: bold;');
                                console.log('%cYour spam attempt has been logged and will not work.', 'color: red; font-size: 14px;');
                                console.log('%cFirebase writes are protected by server-side rules.', 'color: orange;');
                                exploitWarningShown = true;
                            }
                            // Neutralize exploit objects
                            if (window.realSpam) {
                                window.realSpam = { go: () => console.log('‚õî BLOCKED'), batch: () => console.log('‚õî BLOCKED'), war: () => console.log('‚õî BLOCKED') };
                            }
                            if (window.spam) {
                                window.spam = { palestine: () => console.log('‚õî BLOCKED'), israel: () => console.log('‚õî BLOCKED'), test: () => console.log('‚õî BLOCKED') };
                            }
                            if (window.hack) {
                                window.hack = { showTop: () => console.log('‚õî BLOCKED'), unlock: () => console.log('‚õî BLOCKED') };
                            }
                        }
                    }, 500);

                } else {
                    console.log('‚ö†Ô∏è Firebase not configured. Leaderboard will show demo data.');
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }

            // ===== ADVANCED ANTI-SPAM SYSTEM =====
            const antiSpamSystem = {
                // Comprehensive banned words/phrases (political, offensive, spam)
                bannedPatterns: [
                    // Israel-Palestine conflict
                    /palest[i1][n|\u006e]e?/i, /\b[i1]sra[e3]l/i, /\bg[a4]z[a4]\b/i, /h[a4]m[a4]s/i,
                    /[i1]nt[i1]f[a4]d[a4]/i, /z[i1][o0]n[i1]st?s?/i, /\bnak?b[a4]\b/i,
                    /\bidf\b/i, /hezboll?ah/i, /free.?palest/i, /from.?river/i,
                    /aparthe[i1]d/i, /genoc[i1]de/i, /ethnic.?cleans/i, /\bj[e3]w[i1]sh/i,
                    /\barab\b/i, /\bmuslim/i, /\bislam/i, /west.?bank/i, /\bbibi\b/i,
                    /netanyahu/i, /\bwar.?crim/i, /\boccup[iy]/i,

                    // Other political/controversial spam
                    /\bn[a4]z[i1]\b/i, /h[i1]tl[e3]r/i, /\btrump\b/i, /\bb[i1]d[e3]n\b/i,
                    /\bput[i1]n\b/i, /z[e3]l[e3]nsk/i, /\bukra[i1]n/i, /\bruss[i1][a4]\b/i,
                    /comm?un[i1]st?/i, /f[a4]sc[i1]st?/i, /\bss\b/i, /\bkkk\b/i,
                    /\bmaga\b/i, /\bantifa\b/i, /\bblm\b/i, /white.?suprem/i,
                    /black.?lives/i, /all.?lives/i, /\bcoup\b/i, /\brebel/i,

                    // Offensive content
                    /\bsh[i1!]t\b/i, /\bf+u+c+k+/i, /\ba+ss+\b/i, /\bb[i1]tch/i,
                    /\bn[i1]gg?[a4e3]/i, /\br[e3]t[a4]rd/i, /\bc+u+n+t+/i, /\bd[i1]ck\b/i,
                    /\bwh[o0]r[e3]/i, /\bf[a4]g+[o0]?t?/i, /\bsl[u]t/i, /\bk[i1]k[e3]/i,
                    /\bsp[i1]c\b/i, /\bch[i1]nk/i, /\bgook/i, /\btrann?y/i,

                    // Religious sensitivity
                    /\ball[a4]h?\b/i, /\bj[i1]h[a4]d/i, /\bsh[a4]r[i1][a4]\b/i,
                    /crusade/i, /infidel/i, /\bholy.?war/i, /\bkafir/i,

                    // Other spam patterns
                    /\bspam\b/i, /\btest\d+\b/i, /buy.?now/i, /free.?money/i,
                    /subscribe/i, /follow.?me/i, /check.?out/i, /\bdm\s*me/i,
                    /\bxxx/i, /\bporn/i, /\bsex\b/i, /\bviagra/i, /\bcrypto/i,
                    /\bnft\b/i, /\bscam/i, /click.?here/i, /\bdeath\s*to/i,
                    /\bkill\s*(all)?/i, /\bhate\b/i
                ],

                // Normalization table for leet-speak and homoglyphs
                normalizeMap: {
                    '0': 'o', '1': 'i', '3': 'e', '4': 'a', '5': 's', '7': 't', '8': 'b',
                    '@': 'a', '$': 's', '!': 'i', '|': 'i', '(': 'c',
                    '\u0430': 'a', '\u0435': 'e', '\u043e': 'o', '\u0440': 'p', // Cyrillic lookalikes
                    '\u0441': 'c', '\u0443': 'y', '\u0445': 'x', '\u0456': 'i'
                },

                // Rate limiting
                lastSubmission: 0,
                minSubmissionInterval: 3000, // 3 seconds

                normalize(text) {
                    if (!text || typeof text !== 'string') return '';
                    let normalized = text.toLowerCase();
                    // Replace leet-speak and homoglyphs
                    for (const [char, replacement] of Object.entries(this.normalizeMap)) {
                        normalized = normalized.split(char).join(replacement);
                    }
                    // Remove special characters that might be used to bypass filters
                    normalized = normalized.replace(/[\s\-_\.\'\"]/g, '');
                    return normalized;
                },

                containsBannedContent(text) {
                    if (!text || typeof text !== 'string') return { banned: false };

                    const normalized = this.normalize(text);
                    const original = text.toLowerCase();

                    for (const pattern of this.bannedPatterns) {
                        if (pattern.test(normalized) || pattern.test(original)) {
                            console.warn(`‚ö†Ô∏è Anti-spam: Blocked content matching pattern: ${pattern}`);
                            return { banned: true, reason: 'Inappropriate or political content detected' };
                        }
                    }
                    return { banned: false };
                },

                validateCountryName(name) {
                    if (!name || typeof name !== 'string') {
                        return { valid: false, reason: 'Invalid name' };
                    }

                    // Length check
                    if (name.length < 2 || name.length > 50) {
                        return { valid: false, reason: 'Name must be 2-50 characters' };
                    }

                    // Check for banned content
                    const spamCheck = this.containsBannedContent(name);
                    if (spamCheck.banned) {
                        return { valid: false, reason: spamCheck.reason };
                    }

                    // Check for excessive special characters (spam indicator)
                    const specialCharRatio = (name.match(/[^a-zA-Z\s]/g) || []).length / name.length;
                    if (specialCharRatio > 0.4) {
                        return { valid: false, reason: 'Too many special characters' };
                    }

                    return { valid: true };
                },

                canSubmit() {
                    const now = Date.now();
                    if (now - this.lastSubmission < this.minSubmissionInterval) {
                        console.warn('‚ö†Ô∏è Anti-spam: Rate limit - submission too fast');
                        return false;
                    }
                    this.lastSubmission = now;
                    return true;
                },

                sanitizeForFirebase(text) {
                    if (!text || typeof text !== 'string') return text;
                    // Remove any control characters and normalize whitespace
                    return text.replace(/[\x00-\x1F\x7F]/g, '').trim().substring(0, 50);
                }
            };

            window.antiSpamSystem = antiSpamSystem;
            console.log('üõ°Ô∏è Anti-spam system initialized');

            // Record a simulation win to Firebase with detailed stats
            async function recordSimulationWin(winnerCountry, winnerCode, results, sortedCountries) {
                if (!firebaseEnabled || !db) return;

                // Anti-spam validation for custom countries
                const validation = antiSpamSystem.validateCountryName(winnerCountry);
                if (!validation.valid) {
                    console.warn(`‚ö†Ô∏è Blocked leaderboard submission: ${validation.reason}`);
                    return;
                }

                if (!antiSpamSystem.canSubmit()) {
                    console.warn('‚ö†Ô∏è Rate limited - please wait before next simulation');
                    return;
                }

                // Sanitize country name
                winnerCountry = antiSpamSystem.sanitizeForFirebase(winnerCountry);

                try {
                    const batch = db.batch();
                    const currentUser = firebase.auth().currentUser;
                    const userId = currentUser ? currentUser.uid : 'anonymous';

                    // 1. Overall Winner
                    const winnerRef = db.collection('leaderboard').doc(winnerCode);
                    batch.set(winnerRef, {
                        country: winnerCountry,
                        code: winnerCode,
                        wins: firebase.firestore.FieldValue.increment(1),
                        lastWin: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUser: userId
                    }, { merge: true });

                    // 2. Jury Winner (Calculate from results)
                    if (results && sortedCountries) {
                        let juryWinner = sortedCountries[0];
                        let maxJury = -1;
                        sortedCountries.forEach(c => {
                            if (results[c].juryTotal > maxJury) {
                                maxJury = results[c].juryTotal;
                                juryWinner = c;
                            }
                        });
                        const juryCode = getCountryCode(juryWinner);
                        const juryRef = db.collection('leaderboard').doc(juryCode);
                        batch.set(juryRef, {
                            country: juryWinner,
                            code: juryCode,
                            juryWins: firebase.firestore.FieldValue.increment(1),
                            lastUser: userId
                        }, { merge: true });

                        // 3. Televote Winner
                        let teleWinner = sortedCountries[0];
                        let maxTele = -1;
                        sortedCountries.forEach(c => {
                            if (results[c].teleTotal > maxTele) {
                                maxTele = results[c].teleTotal;
                                teleWinner = c;
                            }
                        });
                        const teleCode = getCountryCode(teleWinner);
                        const teleRef = db.collection('leaderboard').doc(teleCode);
                        batch.set(teleRef, {
                            country: teleWinner,
                            code: teleCode,
                            teleWins: firebase.firestore.FieldValue.increment(1),
                            lastUser: userId
                        }, { merge: true });

                        // 4. Last Place (Wooden Spoon)
                        const lastPlace = sortedCountries[sortedCountries.length - 1];
                        const lastCode = getCountryCode(lastPlace);
                        const lastRef = db.collection('leaderboard').doc(lastCode);
                        batch.set(lastRef, {
                            country: lastPlace,
                            code: lastCode,
                            lastPlaces: firebase.firestore.FieldValue.increment(1),
                            lastUser: userId
                        }, { merge: true });
                    }

                    // 5. Total Simulations
                    const statsRef = db.collection('leaderboard').doc('_stats');
                    batch.set(statsRef, {
                        totalSimulations: firebase.firestore.FieldValue.increment(1)
                    }, { merge: true });

                    await batch.commit();

                    // 6. Update User Simulation Count (if logged in)
                    if (firebase.auth().currentUser && db) {
                        const userRef = db.collection('users').doc(firebase.auth().currentUser.uid);
                        // We use a separate update to not fail the main batch if user permissions vary, however it's safe to separate.
                        // Or we could have added it to batch if we are sure of the document path.
                        // Simply running a separate update is safer for now.
                        userRef.set({
                            simulations: firebase.firestore.FieldValue.increment(1),
                            lastSimulation: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true }).catch(err => console.error("Error updating user stats:", err));
                    }

                    console.log(`üèÜ Recorded detailed stats to Firebase`);
                } catch (error) {
                    console.error('Error recording win:', error);
                }
            }

            // Fetch leaderboard data from Firebase
            async function fetchLeaderboardData() {
                if (!firebaseEnabled || !db) {
                    // Demo data
                    return {
                        countries: [
                            { country: 'Sweden', code: 'se', wins: 127, juryWins: 80, teleWins: 50, lastPlaces: 2 },
                            { country: 'Italy', code: 'it', wins: 98, juryWins: 60, teleWins: 90, lastPlaces: 0 },
                            { country: 'Ukraine', code: 'ua', wins: 87, juryWins: 40, teleWins: 110, lastPlaces: 1 },
                            { country: 'United Kingdom', code: 'gb', wins: 48, juryWins: 55, teleWins: 20, lastPlaces: 15 },
                            { country: 'Germany', code: 'de', wins: 42, juryWins: 30, teleWins: 10, lastPlaces: 25 },
                        ],
                        totalSimulations: 892,
                        isDemo: true
                    };
                }

                try {
                    // Fetch ALL countries (small dataset ~50 docs, one read per doc, acceptable for this scale)
                    // This allows client-side sorting for all tabs without needing multiple indexes
                    const snapshot = await db.collection('leaderboard').get();

                    const countries = [];
                    let totalSimulations = 0;

                    snapshot.forEach(doc => {
                        if (doc.id === '_stats') {
                            totalSimulations = doc.data().totalSimulations || 0;
                        } else {
                            countries.push(doc.data());
                        }
                    });

                    return { countries, totalSimulations, isDemo: false };
                } catch (error) {
                    console.error('Error fetching leaderboard:', error);
                    return { countries: [], totalSimulations: 0, isDemo: false, error: true };
                }
            }

            // Show Leaderboard Modal
            async function showLeaderboard() {
                // Loading state
                const loadingHTML = `
                <div class="modal fade" id="leaderboardModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header leaderboard-header">
                                <h5 class="modal-title"><span class="trophy-icon">üèÜ</span> Christmas Leaderboard</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="leaderboard-tabs">
                                <button class="leaderboard-tab active" onclick="switchTab('wins')">üèÜ Overall</button>
                                <button class="leaderboard-tab" onclick="switchTab('juryWins')">‚öñÔ∏è Jury Favorites</button>
                                <button class="leaderboard-tab" onclick="switchTab('teleWins')">‚òéÔ∏è Public Favorites</button>
                                <button class="leaderboard-tab" onclick="switchTab('lastPlaces')">ü•Ñ Wooden Spoon</button>
                            </div>
                            <div class="modal-body">
                                <div class="leaderboard-loading">
                                    <div class="spinner"></div>
                                    <p>Loading global statistics...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

                const existingModal = document.getElementById('leaderboardModal');
                if (existingModal) existingModal.remove();
                document.body.insertAdjacentHTML('beforeend', loadingHTML);
                const modal = new bootstrap.Modal(document.getElementById('leaderboardModal'));
                modal.show();

                // Fetch Data
                const data = await fetchLeaderboardData();
                window.leaderboardData = data.countries; // Store for tab switching

                // Render initial tab (Wins)
                renderLeaderboardTable('wins', data.totalSimulations, data.isDemo);
            }

            // Render Table Function (Global scope for onclick access)
            window.renderLeaderboardTable = function (sortBy, totalSims, isDemo) {
                const countries = window.leaderboardData || [];

                // Sort data
                countries.sort((a, b) => (b[sortBy] || 0) - (a[sortBy] || 0));

                // Slice top 20
                const topCountries = countries.slice(0, 20);

                let tableRows = '';
                topCountries.forEach((country, index) => {
                    if (!country[sortBy] && country[sortBy] !== 0) return; // Skip if no data for this metric

                    let rankClass = '';
                    let rankDisplay = index + 1;
                    if (index === 0) { rankClass = 'gold'; rankDisplay = 'ü•á'; }
                    else if (index === 1) { rankClass = 'silver'; rankDisplay = 'ü•à'; }
                    else if (index === 2) { rankClass = 'bronze'; rankDisplay = 'ü•â'; }

                    let valueClass = sortBy === 'lastPlaces' ? 'text-muted' : 'text-danger';
                    if (sortBy === 'wins') valueClass = 'text-primary';

                    tableRows += `
                        <tr>
                            <td class="leaderboard-rank ${rankClass}">${rankDisplay}</td>
                            <td>
                                <span class="flag-icon flag-icon-${country.code}" style="margin-right: 10px;"></span>
                                ${country.country}
                            </td>
                            <td style="font-weight: bold;" class="${valueClass}">${country[sortBy] || 0}</td>
                        </tr>
                    `;
                });

                let headerText = 'Wins';
                if (sortBy === 'juryWins') headerText = 'Jury Wins';
                if (sortBy === 'teleWins') headerText = 'Televote Wins';
                if (sortBy === 'lastPlaces') headerText = 'Last Places';

                const content = `
                   <div class="leaderboard-stats">
                        <div class="leaderboard-stat-card">
                            <div class="stat-value">${totalSims ? totalSims.toLocaleString() : 0}</div>
                            <div class="stat-label">üåç Global Simulations</div>
                        </div>
                        <div class="leaderboard-stat-card">
                            <div class="stat-value">${countries.length}</div>
                            <div class="stat-label">üè≥Ô∏è Countries Tracked</div>
                        </div>
                   </div>
                   ${isDemo ? '<div class="alert alert-warning mt-2">üìù Demo Mode: Configure Firebase to see real stats!</div>' : ''}
                   <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Rank</th>
                                    <th>Country</th>
                                    <th style="width: 120px;">${headerText}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;

                const tableContainer = document.querySelector('#leaderboardModal .modal-body');
                if (tableContainer) tableContainer.innerHTML = content;
            };

            window.switchTab = function (sortBy) {
                // Update active tab styling
                document.querySelectorAll('.leaderboard-tab').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                // Get totalSims from DOM or global var (simplified here)
                const totalSims = document.querySelector('.leaderboard-stat-card .stat-value').textContent.replace(/,/g, '');
                const isDemo = document.querySelector('.alert-warning') !== null;

                renderLeaderboardTable(sortBy, parseInt(totalSims), isDemo);
            };

            // Leaderboard button click handler
            document.getElementById('leaderboardButton').addEventListener('click', showLeaderboard);
            document.getElementById('userLeaderboardButton').addEventListener('click', showUserLeaderboard);

            // Make recordSimulationWin available globally for integration
            window.recordSimulationWin = recordSimulationWin;

            // ===== USER LEADERBOARD =====
            async function showUserLeaderboard() {
                const loadingHTML = `
                <div class="modal fade" id="userLeaderboardModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header leaderboard-header" style="background: linear-gradient(135deg, #6f42c1 0%, #4b0082 100%);">
                                <h5 class="modal-title">üë§ User Leaderboard</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="leaderboard-tabs">
                                <button class="leaderboard-tab active">ü§ñ Most Simulations</button>
                            </div>
                            <div class="modal-body">
                                <div class="leaderboard-loading">
                                    <div class="spinner"></div>
                                    <p>Loading user rankings...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

                const existingModal = document.getElementById('userLeaderboardModal');
                if (existingModal) existingModal.remove();
                document.body.insertAdjacentHTML('beforeend', loadingHTML);
                const modal = new bootstrap.Modal(document.getElementById('userLeaderboardModal'));
                modal.show();

                // Fetch Data
                let users = [];
                if (firebaseEnabled && db) {
                    try {
                        // Check if user is logged in (permission check)
                        if (!firebase.auth().currentUser) {
                            document.querySelector('#userLeaderboardModal .modal-body').innerHTML = `
                                <div class="alert alert-warning text-center m-4">
                                    <h5>üîí Login Required</h5>
                                    <p>You must be logged in to view the User Leaderboard.</p>
                                </div>`;
                            return;
                        }

                        const snapshot = await db.collection('users')
                            .orderBy('simulations', 'desc')
                            .limit(50)
                            .get();

                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.nickname) {
                                users.push({
                                    nickname: data.nickname,
                                    simulations: data.simulations || 0,
                                    role: data.role || null,
                                    uid: doc.id, // Store UID for click event
                                    isPrivate: data.isPrivate || false
                                });
                            }
                        });
                    } catch (error) {
                        console.error("Error fetching user leaderboard:", error);
                        document.querySelector('#userLeaderboardModal .modal-body').innerHTML = `
                                <div class="alert alert-danger text-center m-4">
                                    <p>Error loading leaderboard. Ensure you are logged in.</p>
                                </div>`;
                        return;
                    }
                } else {
                    // Demo Data
                    users = [
                        { nickname: "EuroFan2025", simulations: 154 },
                        { nickname: "SimMaster", simulations: 120 },
                        { nickname: "SongContestLover", simulations: 98 },
                        { nickname: "JuryMember1", simulations: 85 },
                        { nickname: "TelevoteKing", simulations: 42 }
                    ];
                }

                renderUserLeaderboardTable(users);
            }

            function renderUserLeaderboardTable(users) {
                let tableRows = '';
                users.forEach((user, index) => {
                    let rankClass = '';
                    let rankDisplay = index + 1;
                    if (index === 0) { rankClass = 'gold'; rankDisplay = 'ü•á'; }
                    else if (index === 1) { rankClass = 'silver'; rankDisplay = 'ü•à'; }
                    else if (index === 2) { rankClass = 'bronze'; rankDisplay = 'ü•â'; }

                    let badgeHtml = '';
                    if (user.role === 'admin') {
                        badgeHtml = '<span class="badge-role badge-admin">ADMIN</span>';
                    } else if (user.role === 'dev') {
                        badgeHtml = '<span class="badge-role badge-dev">DEV</span>';
                    }

                    tableRows += `
                        <tr style="cursor: pointer;" onclick="openProfileModal('${user.uid}')">
                            <td class="leaderboard-rank ${rankClass}">${rankDisplay}</td>
                            <td style="font-weight: bold;">
                                ${user.nickname} ${badgeHtml} ${user.isPrivate ? 'üîí' : ''}
                            </td>
                            <td style="font-weight: bold; color: #6f42c1;">${user.isPrivate ? '-' : user.simulations}</td>
                        </tr>
                    `;
                });

                const content = `
                   <div class="leaderboard-stats" style="background: linear-gradient(135deg, #4b0082 0%, #6f42c1 100%);">
                        <div class="leaderboard-stat-card">
                            <div class="stat-value">${users.length}</div>
                            <div class="stat-label">üë§ Ranked Users</div>
                        </div>
                   </div>
                   <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Rank</th>
                                    <th>Nickname</th>
                                    <th style="width: 150px;">Total Simulations</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;

                const tableContainer = document.querySelector('#userLeaderboardModal .modal-body');
                if (tableContainer) tableContainer.innerHTML = content;
            }

            // ===== JESC 2025 VOTING SYSTEM =====
            const jesc2025Participants = [
                { code: 'mt', name: 'Malta', artist: 'Eliza Borg', song: 'I Believe' },
                { code: 'az', name: 'Azerbaijan', artist: 'Yaƒümur', song: 'Miau Miau' },
                { code: 'hr', name: 'Croatia', artist: 'Marino Vrgoƒç', song: 'Snovi' },
                { code: 'sm', name: 'San Marino', artist: 'Martina CRV', song: 'Beyond the Stars' },
                { code: 'am', name: 'Armenia', artist: 'Albert', song: 'Brave Heart' },
                { code: 'ua', name: 'Ukraine', artist: 'Sofija Nersesian', song: 'Motanka' },
                { code: 'ie', name: 'Ireland', artist: "Lottie O'Driscoll Murray", song: 'R√∫in' },
                { code: 'nl', name: 'Netherlands', artist: 'Meadow', song: 'Freeze' },
                { code: 'pl', name: 'Poland', artist: 'Marianna K≈Ços', song: 'Brightest Light' },
                { code: 'mk', name: 'North Macedonia', artist: 'Nela Manczeska', song: 'Miracle' },
                { code: 'me', name: 'Montenegro', artist: 'Asja D≈æogoviƒá', song: 'I tu≈æna i sreƒána priƒça' },
                { code: 'it', name: 'Italy', artist: 'Leonardo Giovannangeli', song: 'Rockstar' },
                { code: 'pt', name: 'Portugal', artist: 'In√™s Gon√ßalves', song: 'Para onde vai o amor?' },
                { code: 'es', name: 'Spain', artist: 'Gonzalo Pinillos', song: '√ârase una vez' },
                { code: 'ge', name: 'Georgia', artist: 'Anita Abgariani', song: 'Shine Like a Star' },
                { code: 'cy', name: 'Cyprus', artist: 'Rafaella i Christos', song: 'Away' },
                { code: 'fr', name: 'France', artist: 'Lou Deleuze', song: 'Ce monde' },
                { code: 'al', name: 'Albania', artist: 'Kroni Pula', song: 'Fruta perime' }
            ];

            const jescVoteButton = document.getElementById('jescVoteButton');
            const jescList = document.getElementById('jescParticipantsList');
            const jescPredictionList = document.getElementById('jescPredictionList');
            let jescModal = null; // Lazy init

            // Initialization
            jescVoteButton.addEventListener('click', async () => {
                if (!jescModal) {
                    jescModal = new bootstrap.Modal(document.getElementById('jescVotingModal'));

                    // Add tab change listener to load data when switching tabs
                    document.getElementById('vote-tab').addEventListener('shown.bs.tab', () => loadJescData('vote'));
                    document.getElementById('prediction-tab').addEventListener('shown.bs.tab', () => loadJescData('prediction'));
                }
                jescModal.show();
                await loadJescData('vote'); // Load default tab
            });

            async function loadJescData(type) {
                const targetList = type === 'vote' ? jescList : jescPredictionList;
                const collectionName = type === 'vote' ? 'jesc_2025_votes' : 'jesc_2025_predictions';

                targetList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

                let votesData = {};
                let totalVotes = 0;

                // Fetch votes from Firebase if enabled
                if (firebaseEnabled && db) {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        snapshot.forEach(doc => {
                            votesData[doc.id] = doc.data().votes || 0;
                            totalVotes += doc.data().votes || 0;
                        });
                    } catch (error) {
                        console.error(`Error fetching JESC ${type} data`, error);
                    }
                }

                renderJescList(votesData, totalVotes, type);
            }

            function renderJescList(votesData, totalVotes, type) {
                const targetList = type === 'vote' ? jescList : jescPredictionList;
                // Voting Closed - ignore local storage state for UI, always show results

                targetList.innerHTML = '';

                // Show Winner Header
                if (type === 'vote') {
                    const winnerHtml = `
                        <div class="text-center mb-4 p-3" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius: 15px; color: black; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                            <h2 style="font-weight: 900; margin-bottom: 5px;">üèÜ WINNER üèÜ</h2>
                            <h3 style="font-size: 2.5em; margin: 10px 0;">üá´üá∑ FRANCE</h3>
                            <h5 style="font-weight: normal;">Lou Deleuze - "Ce monde"</h5>
                        </div>
                        <h5 class="text-center mb-3">Full Results (Voting Closed)</h5>
                    `;
                    targetList.insertAdjacentHTML('beforeend', winnerHtml);
                } else {
                    targetList.insertAdjacentHTML('beforeend', '<h5 class="text-center mb-3">Prediction Results (Voting Closed)</h5>');
                }

                // Always sort by votes descending
                let sortedParticipants = [...jesc2025Participants];
                sortedParticipants.sort((a, b) => {
                    const votesA = votesData[a.code] || 0;
                    const votesB = votesData[b.code] || 0;
                    return votesB - votesA;
                });

                sortedParticipants.forEach((p, index) => {
                    const votes = votesData[p.code] || 0;
                    const percent = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;

                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap';

                    // Always show results UI
                    let badgeColor = type === 'vote' ? 'bg-primary' : 'bg-success';
                    let actionHtml = `
                        <div class="d-flex flex-column align-items-end" style="min-width: 100px;">
                            <span class="badge ${badgeColor} rounded-pill mb-1">${votes} votes</span>
                            <small class="text-muted">${percent}%</small>
                        </div>
                     `;
                    // Progress bar background
                    let color = type === 'vote' ? '230,240,255' : '230,255,230';
                    item.style.background = `linear-gradient(to right, rgba(${color},1) ${percent}%, white ${percent}%)`;

                    item.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="flag-icon flag-icon-${p.code} me-3" style="font-size: 1.5em; margin-right: 15px;"></span>
                            <div>
                                <h6 class="mb-0 fw-bold">#${index + 1} ${p.name}</h6>
                                <small class="text-muted">${p.artist} - "<em>${p.song}</em>"</small>
                            </div>
                        </div>
                        ${actionHtml}
                    `;
                    targetList.appendChild(item);
                });

                // No event listeners needed as there are no buttons
            }

            async function castAction(countryCode, type) {
                const countryName = jesc2025Participants.find(c => c.code === countryCode).name;
                const actionName = type === 'vote' ? 'vote' : 'predict';
                const collectionName = type === 'vote' ? 'jesc_2025_votes' : 'jesc_2025_predictions';
                const storageKey = type === 'vote' ? 'hasVotedJESC2025' : 'hasPredictedJESC2025';

                if (!confirm(`Are you sure you want to ${actionName} for ${countryName}? You cannot change this choice.`)) {
                    return;
                }

                if (localStorage.getItem(storageKey) === 'true') {
                    alert("You have already done this!");
                    return;
                }

                // Optimistic update
                localStorage.setItem(storageKey, 'true');

                if (firebaseEnabled && db) {
                    try {
                        const docRef = db.collection(collectionName).doc(countryCode);
                        await docRef.set({
                            votes: firebase.firestore.FieldValue.increment(1)
                        }, { merge: true });
                        console.log(`${actionName} cast successfully!`);

                        // Show Success Modal
                        const successModalHtml = `
                        <div class="modal fade" id="voteSuccessModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content text-center">
                                    <div class="modal-body p-4">
                                        <div style="font-size: 3rem; margin-bottom: 10px;">üéâ</div>
                                        <h4 class="mb-3">Thank You!</h4>
                                        <p class="mb-0">Your ${actionName} for <strong>${countryName}</strong> has been recorded.</p>
                                    </div>
                                    <div class="modal-footer justify-content-center">
                                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Awesome!</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                        document.body.insertAdjacentHTML('beforeend', successModalHtml);
                        const successModal = new bootstrap.Modal(document.getElementById('voteSuccessModal'));
                        successModal.show();
                        document.getElementById('voteSuccessModal').addEventListener('hidden.bs.modal', function () {
                            this.remove();
                        });

                    } catch (error) {
                        console.error(`Error casting ${actionName}:`, error);
                        alert("There was an error saving online, but it's recorded locally.");
                    }
                }

                // Reload to show results
                await loadJescData(type);
            }

            const ESC_COUNTRIES = [
                // Europe
                { name: "Albania", code: "al" }, { name: "Andorra", code: "ad" }, { name: "Armenia", code: "am" },
                { name: "Austria", code: "at" }, { name: "Azerbaijan", code: "az" }, { name: "Belarus", code: "by" },
                { name: "Belgium", code: "be" }, { name: "Bosnia & Herzegovina", code: "ba" }, { name: "Bulgaria", code: "bg" },
                { name: "Croatia", code: "hr" }, { name: "Cyprus", code: "cy" }, { name: "Czechia", code: "cz" },
                { name: "Denmark", code: "dk" }, { name: "Estonia", code: "ee" }, { name: "Finland", code: "fi" },
                { name: "France", code: "fr" }, { name: "Georgia", code: "ge" }, { name: "Germany", code: "de" },
                { name: "Greece", code: "gr" }, { name: "Hungary", code: "hu" }, { name: "Iceland", code: "is" },
                { name: "Ireland", code: "ie" }, { name: "Italy", code: "it" }, { name: "Kazakhstan", code: "kz" },
                { name: "Kosovo", code: "xk" }, { name: "Latvia", code: "lv" }, { name: "Liechtenstein", code: "li" },
                { name: "Lithuania", code: "lt" }, { name: "Luxembourg", code: "lu" }, { name: "Malta", code: "mt" },
                { name: "Moldova", code: "md" }, { name: "Monaco", code: "mc" }, { name: "Montenegro", code: "me" },
                { name: "Netherlands", code: "nl" }, { name: "North Macedonia", code: "mk" }, { name: "Norway", code: "no" },
                { name: "Poland", code: "pl" }, { name: "Portugal", code: "pt" }, { name: "Romania", code: "ro" },
                { name: "Russia", code: "ru" }, { name: "San Marino", code: "sm" }, { name: "Serbia", code: "rs" },
                { name: "Slovakia", code: "sk" }, { name: "Slovenia", code: "si" }, { name: "Spain", code: "es" },
                { name: "Sweden", code: "se" }, { name: "Switzerland", code: "ch" }, { name: "Turkey", code: "tr" },
                { name: "Ukraine", code: "ua" }, { name: "United Kingdom", code: "gb" }, { name: "Vatican City", code: "va" },

                // Americas
                { name: "Antigua & Barbuda", code: "ag" }, { name: "Argentina", code: "ar" }, { name: "Bahamas", code: "bs" },
                { name: "Barbados", code: "bb" }, { name: "Belize", code: "bz" }, { name: "Bolivia", code: "bo" },
                { name: "Brazil", code: "br" }, { name: "Canada", code: "ca" }, { name: "Chile", code: "cl" },
                { name: "Colombia", code: "co" }, { name: "Costa Rica", code: "cr" }, { name: "Cuba", code: "cu" },
                { name: "Dominica", code: "dm" }, { name: "Dominican Republic", code: "do" }, { name: "Ecuador", code: "ec" },
                { name: "El Salvador", code: "sv" }, { name: "Grenada", code: "gd" }, { name: "Guatemala", code: "gt" },
                { name: "Guyana", code: "gy" }, { name: "Haiti", code: "ht" }, { name: "Honduras", code: "hn" },
                { name: "Jamaica", code: "jm" }, { name: "Mexico", code: "mx" }, { name: "Nicaragua", code: "ni" },
                { name: "Panama", code: "pa" }, { name: "Paraguay", code: "py" }, { name: "Peru", code: "pe" },
                { name: "Saint Kitts & Nevis", code: "kn" }, { name: "Saint Lucia", code: "lc" }, { name: "Saint Vincent", code: "vc" },
                { name: "Suriname", code: "sr" }, { name: "Trinidad & Tobago", code: "tt" }, { name: "United States", code: "us" },
                { name: "Uruguay", code: "uy" }, { name: "Venezuela", code: "ve" },

                // Asia & Oceania
                { name: "Afghanistan", code: "af" }, { name: "Australia", code: "au" }, { name: "Bangladesh", code: "bd" },
                { name: "Bhutan", code: "bt" }, { name: "Brunei", code: "bn" }, { name: "Cambodia", code: "kh" },
                { name: "China", code: "cn" }, { name: "East Timor", code: "tl" }, { name: "Fiji", code: "fj" },
                { name: "India", code: "in" }, { name: "Indonesia", code: "id" }, { name: "Iran", code: "ir" },
                { name: "Iraq", code: "iq" }, { name: "Israel", code: "il" }, { name: "Japan", code: "jp" },
                { name: "Jordan", code: "jo" }, { name: "Kiribati", code: "ki" }, { name: "Kuwait", code: "kw" },
                { name: "Kyrgyzstan", code: "kg" }, { name: "Laos", code: "la" }, { name: "Lebanon", code: "lb" },
                { name: "Malaysia", code: "my" }, { name: "Maldives", code: "mv" }, { name: "Marshall Islands", code: "mh" },
                { name: "Micronesia", code: "fm" }, { name: "Mongolia", code: "mn" }, { name: "Myanmar", code: "mm" },
                { name: "Nauru", code: "nr" }, { name: "Nepal", code: "np" }, { name: "New Zealand", code: "nz" },
                { name: "North Korea", code: "kp" }, { name: "Oman", code: "om" }, { name: "Pakistan", code: "pk" },
                { name: "Palau", code: "pw" }, { name: "Palestine", code: "ps" }, { name: "Papua New Guinea", code: "pg" },
                { name: "Philippines", code: "ph" }, { name: "Qatar", code: "qa" }, { name: "Samoa", code: "ws" },
                { name: "Saudi Arabia", code: "sa" }, { name: "Singapore", code: "sg" }, { name: "Solomon Islands", code: "sb" },
                { name: "South Korea", code: "kr" }, { name: "Sri Lanka", code: "lk" }, { name: "Syria", code: "sy" },
                { name: "Taiwan", code: "tw" }, { name: "Tajikistan", code: "tj" }, { name: "Thailand", code: "th" },
                { name: "Tonga", code: "to" }, { name: "Turkmenistan", code: "tm" }, { name: "Tuvalu", code: "tv" },
                { name: "UAE", code: "ae" }, { name: "Uzbekistan", code: "uz" }, { name: "Vanuatu", code: "vu" },
                { name: "Vietnam", code: "vn" }, { name: "Yemen", code: "ye" },

                // Africa
                { name: "Algeria", code: "dz" }, { name: "Angola", code: "ao" }, { name: "Benin", code: "bj" },
                { name: "Botswana", code: "bw" }, { name: "Burkina Faso", code: "bf" }, { name: "Burundi", code: "bi" },
                { name: "Cabo Verde", code: "cv" }, { name: "Cameroon", code: "cm" }, { name: "CAR", code: "cf" },
                { name: "Chad", code: "td" }, { name: "Comoros", code: "km" }, { name: "Congo (DRC)", code: "cd" },
                { name: "Congo (Republic)", code: "cg" }, { name: "Cote d'Ivoire", code: "ci" }, { name: "Djibouti", code: "dj" },
                { name: "Egypt", code: "eg" }, { name: "Equatorial Guinea", code: "gq" }, { name: "Eritrea", code: "er" },
                { name: "Eswatini", code: "sz" }, { name: "Ethiopia", code: "et" }, { name: "Gabon", code: "ga" },
                { name: "Gambia", code: "gm" }, { name: "Ghana", code: "gh" }, { name: "Guinea", code: "gn" },
                { name: "Guinea-Bissau", code: "gw" }, { name: "Kenya", code: "ke" }, { name: "Lesotho", code: "ls" },
                { name: "Liberia", code: "lr" }, { name: "Libya", code: "ly" }, { name: "Madagascar", code: "mg" },
                { name: "Malawi", code: "mw" }, { name: "Mali", code: "ml" }, { name: "Mauritania", code: "mr" },
                { name: "Mauritius", code: "mu" }, { name: "Morocco", code: "ma" }, { name: "Mozambique", code: "mz" },
                { name: "Namibia", code: "na" }, { name: "Niger", code: "ne" }, { name: "Nigeria", code: "ng" },
                { name: "Rwanda", code: "rw" }, { name: "Sao Tome & Principe", code: "st" }, { name: "Senegal", code: "sn" },
                { name: "Seychelles", code: "sc" }, { name: "Sierra Leone", code: "sl" }, { name: "Somalia", code: "so" },
                { name: "South Africa", code: "za" }, { name: "South Sudan", code: "ss" }, { name: "Sudan", code: "sd" },
                { name: "Tanzania", code: "tz" }, { name: "Togo", code: "tg" }, { name: "Tunisia", code: "tn" },
                { name: "Uganda", code: "ug" }, { name: "Zambia", code: "zm" }, { name: "Zimbabwe", code: "zw" }
            ];

            const AVAILABLE_TAGS = [
                // General
                "Eurofan", "Statistician", "Casual", "Predictor", "Sim Addict",
                // Roles
                "Jury Member", "Televoter", "Artist", "Historian", "Composer", "Commentator", "Journalist",
                // Specific Interests
                "JESC Fan", "NF Watcher", "San Remo Enjoyer", "Melodifestivalen Fan", "Chart Maker",
                "Winner Predictor", "Underdog Fan", "Big 5 Hater", "Big 5 Lover",
                // Fun / Personality
                "Flag Nerd", "Map Lover", "Ballad Lover", "Bop Enjoyer", "Ethno-Bop Fan",
                "Rock Fan", "Joke Entry Stan", "Robbed Queen Support", "Null Points Fear",
                "Dark Horse Hunter", "Live Show Purist", "Studio Cut Only", "Postcard Critic",
                "Stage Design Nerd", "Green Room Stalker", "Wind Machine Enthusiast",
                "Key Change Spotter", "Pyrotechnics Fan", "Chaos Agent", "Peace & Love",
                "Old School (Pre-2000)", "New School (Post-2010)", "Golden Era (2000s)",
                "Recap Watcher", "Iceberg Explorer", "Reaction Video Addict"
            ];

            async function openProfileModal(targetUid) {
                const modalEl = document.getElementById('profileModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();

                const loading = document.getElementById('profileLoading');
                const content = document.getElementById('profileContent');
                const editControls = document.getElementById('editProfileControls');

                loading.style.display = 'block';
                content.style.display = 'none';
                loading.style.display = 'block';
                content.style.display = 'none';
                editControls.style.display = 'none'; // Ensure hidden by default

                const currentUser = firebase.auth().currentUser;
                const isOwner = currentUser && currentUser.uid === targetUid;

                if (firebaseEnabled && db) {
                    try {
                        const doc = await db.collection('users').doc(targetUid).get();
                        if (!doc.exists) {
                            alert("User not found");
                            modal.hide();
                            return;
                        }
                        const data = doc.data();
                        const isPrivate = data.isPrivate && !isOwner;

                        // Populate View
                        document.getElementById('profileNickname').textContent = data.nickname || "Unknown";
                        document.getElementById('profileImage').src = data.avatarUrl || data.photoURL || 'https://placehold.co/100';
                        document.getElementById('profileBio').textContent = data.bio || (isOwner ? "No bio yet." : "");

                        // New Fields Display
                        // New Fields Display
                        const favCountryName = data.favCountry || "";
                        const favCountryCode = data.favCountryCode || ""; // Backward compatibility attempt?

                        // Try to find code if missing
                        let displayCode = favCountryCode;
                        if (!displayCode && favCountryName) {
                            const found = ESC_COUNTRIES.find(c => c.name === favCountryName);
                            if (found) displayCode = found.code;
                        }

                        const social = data.social || "";
                        const location = data.location || "";
                        let extraInfoHtml = "";
                        if (favCountryName && displayCode) {
                            extraInfoHtml += `<span class="badge bg-light text-dark border me-1"><span class="flag-icon flag-icon-${displayCode}"></span> ${favCountryName}</span>`;
                        } else if (favCountryName) {
                            extraInfoHtml += `<span class="badge bg-danger me-1">‚ù§Ô∏è ${favCountryName}</span>`;
                        }

                        if (location) extraInfoHtml += `<span class="badge bg-warning text-dark me-1">üìç ${location}</span>`;
                        if (social) extraInfoHtml += `<span class="badge bg-info text-dark">üîó ${social}</span>`;

                        // Insert extra info after bio
                        const existingExtra = document.getElementById('profileExtraInfo');
                        if (existingExtra) existingExtra.remove();
                        if (extraInfoHtml) {
                            document.getElementById('profileBio').insertAdjacentHTML('afterend', `<div id="profileExtraInfo" class="mb-2">${extraInfoHtml}</div>`);
                        }



                        document.getElementById('profileSimulations').textContent = isPrivate ? "üîí" : (data.simulations || 0);
                        document.getElementById('profileJoinDate').textContent = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : "-";

                        // Badges
                        let badgesHtml = '';
                        if (data.role === 'admin') badgesHtml += '<span class="badge-role badge-admin">ADMIN</span>';
                        if (data.role === 'dev') badgesHtml += '<span class="badge-role badge-dev">DEV</span>';
                        document.getElementById('profileBadges').innerHTML = badgesHtml;

                        // Tags
                        const tagsContainer = document.getElementById('profileTags');
                        tagsContainer.innerHTML = '';
                        if (data.tags && Array.isArray(data.tags)) {
                            data.tags.forEach(tag => {
                                tagsContainer.innerHTML += `<span class="badge bg-secondary rounded-pill">${tag}</span>`;
                            });
                        }

                        // Owner Logic
                        if (isOwner) {
                            editControls.style.display = 'block';
                            document.getElementById('editAvatarUrl').value = data.avatarUrl || "";
                            document.getElementById('editBio').value = data.bio || "";
                            document.getElementById('editLocation').value = data.location || "";
                            document.getElementById('editSocial').value = data.social || "";
                            document.getElementById('privacyToggle').checked = data.isPrivate || false;

                            // Init Country Drag & Drop
                            initCountryDragDrop(data.favCountry, data.favCountryCode);

                            // Render Tag Selection
                            const editTagsContainer = document.getElementById('editTagsContainer');
                            editTagsContainer.innerHTML = '';
                            AVAILABLE_TAGS.forEach(tag => {
                                const isSelected = data.tags && data.tags.includes(tag);
                                const btnClass = isSelected ? 'btn-primary' : 'btn-outline-secondary';
                                editTagsContainer.innerHTML += `
                                    <button class="btn btn-sm ${btnClass} tag-select-btn" data-tag="${tag}" onclick="toggleTag(this)">${tag}</button>
                                `;
                            });

                            // Save Handler
                            document.getElementById('saveProfileButton').onclick = async () => {
                                const newAvatar = document.getElementById('editAvatarUrl').value.trim();
                                const newBio = document.getElementById('editBio').value.trim();
                                const newFavCountryName = document.getElementById('editFavCountryName').value;
                                const newFavCountryCode = document.getElementById('editFavCountryCode').value;
                                const newLocation = document.getElementById('editLocation').value.trim();
                                const newSocial = document.getElementById('editSocial').value.trim();
                                const isPrivate = document.getElementById('privacyToggle').checked;

                                // Collect tags
                                const selectedTags = [];
                                document.querySelectorAll('.tag-select-btn.btn-primary').forEach(btn => selectedTags.push(btn.dataset.tag));

                                try {
                                    await db.collection('users').doc(currentUser.uid).update({
                                        avatarUrl: newAvatar,
                                        bio: newBio,
                                        favCountry: newFavCountryName,
                                        favCountryCode: newFavCountryCode,
                                        location: newLocation,
                                        social: newSocial,
                                        isPrivate: isPrivate,
                                        tags: selectedTags
                                    });
                                    modal.hide();
                                    modal.hide();
                                    const leaderboardModal = document.getElementById('userLeaderboardModal');
                                    if (leaderboardModal && leaderboardModal.classList.contains('show')) {
                                        // Ideally we would refresh here, but for now just saving is enough.
                                        // The user can close/re-open leaderboard to see changes.
                                    }
                                } catch (e) {
                                    console.error(e);
                                    alert("Error saving profile");
                                }
                            };
                        } else {
                            if (isPrivate) {
                                document.getElementById('profileBio').textContent = "This profile is private.";
                                document.getElementById('profileTags').innerHTML = '';
                            }
                        }

                        loading.style.display = 'none';
                        content.style.display = 'block';

                    } catch (e) {
                        console.error(e);
                        alert("Error loading profile");
                        modal.hide();
                    }
                }
            }

            window.toggleTag = function (btn) {
                btn.classList.toggle('btn-primary');
                btn.classList.toggle('btn-outline-secondary');
            };

            // Drag & Drop Logic for Countries
            function initCountryDragDrop(currentName, currentCode) {
                const sourceContainer = document.getElementById('favCountrySource');
                const dropZone = document.getElementById('favCountryDropZone');
                const hiddenName = document.getElementById('editFavCountryName');
                const hiddenCode = document.getElementById('editFavCountryCode');

                window.resetDropZone = function () {
                    document.getElementById('editFavCountryName').value = "";
                    document.getElementById('editFavCountryCode').value = "";
                    document.getElementById('favCountryDropZone').innerHTML = '<span class="text-muted small">Drag your favorite country here</span>';
                };

                // 1. Populate Source
                sourceContainer.innerHTML = '';
                ESC_COUNTRIES.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'country-draggable badge bg-light text-dark border';
                    el.style.cursor = 'grab';
                    el.style.userSelect = 'none';
                    el.draggable = true;
                    el.dataset.code = c.code;
                    el.dataset.name = c.name;
                    el.innerHTML = `<span class="flag-icon flag-icon-${c.code}"></span> ${c.name}`;

                    el.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', JSON.stringify({ name: c.name, code: c.code }));
                        el.style.opacity = '0.5';
                    });
                    el.addEventListener('dragend', () => {
                        el.style.opacity = '1';
                    });

                    // Click to select fallback
                    el.addEventListener('click', () => {
                        setFavoriteCountry(c.name, c.code);
                    });

                    sourceContainer.appendChild(el);
                });

                // 2. Drop Zone Events
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Allow drop
                    dropZone.style.background = '#e9ecef';
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.background = '#f8f9fa';
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.background = '#f8f9fa';
                    const data = e.dataTransfer.getData('text/plain');
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            setFavoriteCountry(parsed.name, parsed.code);
                        } catch (err) { console.error(err); }
                    }
                });

                function setFavoriteCountry(name, code) {
                    hiddenName.value = name;
                    hiddenCode.value = code;
                    dropZone.innerHTML = `
                        <div class="badge bg-primary fs-6 p-2">
                             <span class="flag-icon flag-icon-${code}"></span> ${name} 
                             <span class="ms-2" style="cursor:pointer; opacity:0.7;" onclick="event.stopPropagation(); resetDropZone();">√ó</span>
                        </div>
                    `;
                }

                // 3. Set Initial
                if (currentName) {
                    // Try to find code if missing
                    let code = currentCode;
                    if (!code) {
                        const found = ESC_COUNTRIES.find(c => c.name === currentName);
                        if (found) code = found.code;
                    }
                    if (code) setFavoriteCountry(currentName, code);
                } else {
                    resetDropZone();
                }
            }

            window.filterCountries = function () {
                const term = document.getElementById('favCountrySearch').value.toLowerCase();
                const items = document.querySelectorAll('.country-draggable');
                items.forEach(item => {
                    const name = item.dataset.name.toLowerCase();
                    if (name.includes(term)) item.style.display = 'inline-block';
                    else item.style.display = 'none';
                });
            };

        </script>
        <script>
            // Authentication Logic
            document.addEventListener('DOMContentLoaded', () => {
                const auth = firebase.auth();
                const provider = new firebase.auth.GoogleAuthProvider();

                const loginBtn = document.getElementById('loginButton');
                const logoutBtn = document.getElementById('logoutButton');
                const authSection = document.getElementById('authSection');
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');

                // Login
                loginBtn.addEventListener('click', () => {
                    if (!firebaseEnabled) {
                        alert("Firebase is not initialized. Cannot log in.");
                        return;
                    }
                    auth.signInWithPopup(provider)
                        .then((result) => {
                            console.log("User logged in:", result.user);
                            // Optional: Store user in DB if needed later
                        }).catch((error) => {
                            console.error("Login failed:", error);
                            alert("Login failed: " + error.message);
                        });
                });

                // Logout
                logoutBtn.addEventListener('click', () => {
                    auth.signOut().then(() => {
                        console.log("User logged out");
                        // Clear session storage if any
                    }).catch((error) => {
                        console.error("Logout failed:", error);
                    });
                });

                // State Observer

                // Add listener for My Profile
                document.getElementById('myProfileButton').addEventListener('click', () => {
                    const user = firebase.auth().currentUser;
                    if (user) openProfileModal(user.uid);
                });

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        loginBtn.style.display = 'none';

                        // Check if user has a nickname in Firestore
                        if (firebaseEnabled && db) {
                            const userRef = db.collection('users').doc(user.uid);
                            try {
                                const doc = await userRef.get();
                                if (doc.exists && doc.data().nickname) {
                                    // User has a nickname, show UI
                                    const nickname = doc.data().nickname;
                                    userAvatar.src = user.photoURL || 'https://via.placeholder.com/40';
                                    userName.textContent = nickname; // Show Nickname ONLY

                                    authSection.style.display = 'block';
                                    authSection.classList.add('fade-in');
                                } else {
                                    // No nickname, show modal
                                    const nicknameModal = new bootstrap.Modal(document.getElementById('nicknameModal'));
                                    nicknameModal.show();

                                    // Handle Save
                                    document.getElementById('saveNicknameButton').onclick = async () => {
                                        const input = document.getElementById('nicknameInput');
                                        const nick = input.value.trim();
                                        const errDiv = document.getElementById('nicknameError');

                                        if (nick.length < 3) {
                                            errDiv.textContent = "Nickname must be at least 3 characters.";
                                            return;
                                        }

                                        // Save to Firestore
                                        try {
                                            await userRef.set({
                                                nickname: nick,
                                                email: user.email, // Store email privately for admin reference if needed
                                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                            }, { merge: true });

                                            nicknameModal.hide();

                                            // Update UI
                                            userAvatar.src = user.photoURL || 'https://via.placeholder.com/40';
                                            userName.textContent = nick;
                                            authSection.style.display = 'block';
                                        } catch (err) {
                                            console.error("Error saving nickname:", err);
                                            errDiv.textContent = "Error saving. Please try again.";
                                        }
                                    };
                                }
                            } catch (error) {
                                console.error("Error fetching user data:", error);
                            }
                        } else {
                            // Fallback if DB is not ready (shouldn't happen often)
                            console.warn("DB not ready, using Display Name temporary");
                            authSection.style.display = 'block';
                            userName.textContent = user.displayName;
                        }

                    } else {
                        loginBtn.style.display = 'block';
                        authSection.style.display = 'none';
                        userAvatar.src = '';
                        userName.textContent = '';
                    }
                });
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
</body>
